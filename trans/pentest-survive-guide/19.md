# 第 9 章 AJAX 和 Web 服务——安全问题

**异步 JavaScript 和 XML**（**AJAX**是用于创建快速和动态页面的技术组合。它不是一种新的编程语言，而是旧技术的混合体，它创建了一个更具交互性的客户端界面。通过高速互联网连接，企业正试图使其应用程序运行得更快。传统的请求-响应行为限制了应用程序的响应能力。AJAX 使用异步请求-响应方法，使应用程序更具交互性。这允许驻留在远程位置的应用程序像基于桌面的应用程序一样响应。在以传统方式工作的 web 应用程序中，客户端需要提交整个 web 页面以从服务器获得响应。AJAX 打破了传统的模型，允许在不向服务器提交整个页面的情况下更新 web 页面的内容。

除了 AJAX 之外，我们还将了解 web 服务，它是一种独立于平台的技术，用于使用 web API 通过网络访问服务。Web 服务用于实现面向服务的体系结构，其中多个服务相互协作和通信。移动设备上的应用程序也会使用 web 服务，这使其成为未来几年的一项重要技术。

尽管 AJAX 和 web 服务是一组功能强大的技术，但它们也容易受到 web 应用程序面临的安全问题的影响。更大的攻击范围和客户端代码的增加是影响 AJAX 的几个问题。另一方面，web 服务容易出现传统的 web 应用程序安全问题，如输入验证、注入缺陷和身份验证问题。在本章中，我们将了解 AJAX 和 web 服务是如何改变 web 的，以及攻击者利用它们的不同方式。我们将在本章中研究以下主题：

*   AJAX 简介
*   AJAX 安全问题
*   抓取 AJAX 应用程序
*   分析客户端代码–Firebug
*   Web 服务–SOAP 和 RESTful
*   保护 web 服务

# AJAX 简介

AJAX 不是一种编程语言；这是一个概念。它是一个客户端脚本，无需刷新和重新加载整个网页即可与服务器通信。简单地说，AJAX 允许与 web 服务器通信，而无需用户在 web 浏览器中显式地发出新请求。这使得服务器的响应更快，因为网页的某些部分可以单独更新，从而改善了用户体验。AJAX 使用 JavaScript 连接并从服务器检索信息，而无需重新加载整个网页。

以下是使用 AJAX 的一些好处：

*   **提高速度**：使用 AJAX 的目的是提高 web 应用程序的性能。通过更新单个表单元素，服务器上需要最少的处理来提高性能。客户端的响应能力也得到了极大的提高。
*   **用户友好**：在基于 AJAX 的应用程序中，用户不需要重新加载整个页面来刷新网站的特定部分，这使得应用程序更具交互性和用户友好性。它还可用于执行实时验证和自动完成。
*   **异步调用**：基于 AJAX 的应用程序旨在对 web 服务器进行异步调用，因此命名为异步 JavaScript 和 XML。这有助于用户在后台更新网页的某一部分时与网页进行交互。
*   **网络利用率降低**：由于没有每次执行整页刷新，网络利用率降低。在加载大型图像和 flash 内容的 web 应用程序中，使用 AJAX 可以优化网络利用率。

## AJAX 的构建块

正如前面提到的，AJAX 是用于构建 web 应用程序的常见 web 技术的混合体。使用这些 web 技术设计应用程序的方式产生了基于 AJAX 的应用程序。以下是 AJAX 的组件：

*   **JavaScript**：基于 AJAX 的应用程序的最重要的组件是客户端 JavaScript 代码。JavaScript 在后台与 web 服务器交互，并在信息显示给用户之前对其进行处理。它使用 XMLHttpRequestAPI 在服务器和客户端之间传输数据。XMLHTTPRequest 存在于后台，用户不知道它的存在。
*   **动态 HTML（DHTML）**：一旦从服务器检索到数据并由 JavaScript 处理，则需要更新网页元素以反映服务器的响应。一个完美的例子是在填写在线表单时输入用户名。表单将动态更新，以反映并通知用户用户名是否已在网站上注册。使用 DHTML 和 JavaScript，您可以动态更新页面内容。DHTML 早在 AJAX 出现之前就已经存在了。仅使用 DHTML 的主要缺点是它严重依赖客户端代码来更新页面。大多数情况下，您没有在客户端加载所有内容，您需要与服务器端代码交互。这就是 AJAX 通过 XHR 对象在客户端代码和服务器之间创建连接的原因。在 AJAX 之前，您必须使用 JavaScript 小程序。
*   **文档对象模型（DOM）**：DOM 是组织 HTML 或 XML 文档中元素的框架。它是表示 HTML 对象并与之交互的约定。以逻辑方式想象 HTML 文档被解析为一棵树，其中每个元素都被视为树节点，树的每个节点都有自己的属性和事件。例如，HTML 文档的 body 对象将具有一组特定的属性，如 text、link、bgColor 等。每个对象也有事件。该模型允许 JavaScript 使用 DHTML 动态访问和更新页面内容的接口。DHTML 是一个浏览器函数，DOM 作为实现它的接口。

## AJAX 工作流

下面的屏幕截图演示了基于 AJAX 的应用程序的各个组件之间的交互。与传统 web 应用程序相比，AJAX 引擎是主要的补充。AJAX 引擎的附加层充当通过 AJAX 发出的所有请求和响应的中介。AJAX 引擎是 JavaScript 解释器：

![The AJAX workflow](../Images/image01220.jpeg)

以下是用户与基于 AJAX 的应用程序交互的工作流。用户界面和 AJAX 引擎是客户端 web 浏览器上的组件：

1.  用户键入网页的 URL，浏览器向服务器发送 HTTP 请求。服务器处理请求并使用 HTML 内容进行响应，HTML 内容由 web 渲染引擎显示在浏览器上。在 HTML 中，网页嵌入在 JavaScript 代码中，JavaScript 解释器在遇到事件时执行该代码。
2.  当与网页交互时，用户会遇到一个使用嵌入式 JavaScript 代码并触发事件的元素。谷歌搜索网页就是一个例子。一旦用户开始键入搜索查询，底层 AJAX 引擎就会截获用户的请求。AJAX 引擎通过 HTTP 请求将请求转发给服务器。此请求对用户是透明的，用户无需显式单击 submit 按钮或刷新整个页面。
3.  在服务器端，应用程序层处理请求并以 JSON、HTML 或 XML 格式将数据返回到 AJAX 引擎。AJAX 引擎将此数据转发到 web 渲染引擎，以便在浏览器上显示。web 浏览器使用 DHTML 仅更新网页的选定部分以反映新数据。

当您遇到基于 AJAX 的应用程序时，请记住以下几点：

*   XMLHttpRequestAPI 是一种在幕后发挥神奇作用的 API。由于其名称较长，通常称为 XHR。首先实例化一个名为`xmlhttp`的 JavaScript 对象，它用于从服务器发送和捕获响应。AJAX 工作需要对 XHR 的浏览器支持；所有主流 web 浏览器的最新版本都支持此 API。
*   AJAX 中的 XML 部分有点误导。在 AJAX 引擎和 web 服务器之间交换数据时，应用程序可以使用 XML 以外的任何格式，例如 JSON、纯文本、HTTP 甚至图像。JSON 是首选，因为它是轻量级的，可以将其转换为 JavaScript 对象，这进一步允许脚本轻松访问和操作数据。
*   多个异步请求可以同时发生，而无需等待一个请求完成。
*   许多开发人员使用 AJAX 框架，这使得他们的任务更容易设计应用程序。JQuery、Dojo Toolkit、**Google web Toolkit**（**GWT**）和 Microsoft AJAX 库（ASP 应用程序）都是著名的框架。

AJAX 请求的示例如下所示：

```
function loadfile()
{
  #initiating the XMLHttpRequest object
  var xmlhttp;
  xmlhttp = new XMLHttpRequest();
  xmlhttp.onreadystatehchange=function()
  {
    if (xmlHttp.readyState==4)
    {
      showContents(xmlhttp.ResponseText);
    }
  #GET method to get the links.txt file
  xmlHttp.open("GET", "links.txt", true);
```

函数`loadfile`首先实例化`xmlhttp`对象。然后，它使用此对象从服务器中提取文本文件。当服务器返回文本文件时，它会显示文件的内容。文件及其内容在没有用户参与的情况下加载，如前面的代码所示。

## AJAX 安全问题

恶意攻击者用来攻击基于 AJAX 的应用程序的安全漏洞不是新发现的漏洞。他们利用由于用于构建 AJAX 应用程序的各种技术的混搭而产生的现有漏洞。尽管 AJAX 应用程序与传统 web 应用程序有许多相同的原则，但人们对 AJAX 应用程序面临的风险知之甚少。不幸的是，没有遵循常见的 AJAX 安全最佳实践，这导致应用程序在设计时存在大量安全漏洞。本节的目的是强调基于 AJAX 的 web 应用程序的安全含义。

AJAX 导致的一些安全问题如下：

*   攻击面增加
*   服务器端和客户端代码的混合导致错误
*   应用程序的公开编程逻辑
*   跨站点脚本漏洞（如 XSS）的放大

### 攻击面增加

由于多种技术协同工作，AJAX 肯定会增加攻击面和应用程序的整体复杂性。HTML 表单可以包含多个参数。例如，在在线工作门户中，它可能包括用户名、密码、教育机构、证书等参数。在传统的 web 应用程序中，整个表单一次提交到服务器。

在 AJAX 应用程序中，参数单独提交给后端函数进行处理。每个 AJAX 请求都包含一个发送到服务器端后端函数的表单字段，而不是在一个请求中提交多个表单字段。这增加了用户与服务器直接接口的数量。因此，每个函数都将成为攻击者的额外目标。虽然异步发送多个请求的方式非常有用和高效，但它违背了为攻击者提供最小攻击窗口和减少攻击面的安全概念。下图说明了此过程：

![Increase in attack surface](../Images/image01221.jpeg)

AJAX 应用程序也会增加客户端的风险。它使用 JavaScript 引擎在客户机上执行大量代码。JavaScript 引擎是一个功能齐全的脚本解释器。如果你遇到一个恶意的网站，如果它的代码被执行，它可能会导致严重的后果。Web 浏览器旨在使用沙箱技术和同源策略防止此类攻击，但也有一些方法可以绕过它们。

### 公开了应用程序的编程逻辑

大量的客户端代码也向客户端公开了编程逻辑。在传统的 web 应用程序中，所有的处理都在服务器端完成，因此理解应用程序的逻辑和流程要困难得多。在基于 AJAX 的应用程序中，一些处理在客户端完成，这将向客户端公开编程内容。受过教育的攻击者可以通过分析客户端代码中的函数推断出大量关于应用程序的信息。客户端代码可能包含字符串、数据类型和变量名称，这些名称有助于理解应用程序的内部工作。

如果应用程序正在执行客户端验证，攻击者还可以绕过它，因为攻击者可以修改客户端上运行的任何代码。因此，在客户端执行验证检查是最不安全的方法。

### 访问控制不足

服务器端对 AJAX 请求的不当访问控制可能导致数据暴露给攻击者。假设应用程序使用 AJAX 请求从您上次购买时使用的服务器检索您的信用卡信息。AJAX 请求示例如下所示：

```
#Initiating the XMLHttpRequest object
var xmlHttp = new XMLHttpRequest ();
#Get method to retrieve the credit card details
xmlhttp.open("GET","retreiveccinfo.php?userid=juneda&currency=INR" ,true);
xmlhttp.send();
```

如果攻击者更改 AJAX 请求如下所示，该怎么办

```
retreiveccinfo.php?userid=Jamesa&currency=USD
```

应实施足够的服务器端访问控制，以防止此类攻击。会话 ID 应正确映射到用户帐户。

## 测试 AJAX 应用程序的挑战

如前几节所述，AJAX 增加了应用程序的复杂性，这在执行应用程序安全评估时也带来了一些挑战：

*   在应用程序的手动测试过程中，您会启动一个代理（如 Burp 或 ZAP），捕获请求和响应。在 AJAX 应用程序中，请求是异步的，捕获的请求响应数量远远超过传统应用程序。作为一名道德黑客，您需要意识到这一点，因为使用 web 应用程序代理手动测试应用程序可能很困难。
*   在基于 AJAX 的应用程序中，网页的内容会动态变化。在选择了几个附加选项后单击某个按钮时，通过单击该按钮生成的请求可能会有所不同。响应将更新网页的部分内容，为用户创建新的表单字段和附加链接。这给渗透测试人员在确定应用程序范围时带来了一个独特的挑战，因为不容易抓取和识别应用程序的大小。测试人员也可能会错过网站的部分内容。

## 抓取 AJAX 应用程序

任何应用的安全评估都是从情报收集和确定应用范围开始的。这有助于了解应用程序，也有助于避免出现诸如勺爬行之类的问题。

### 注

舀水爬行是指在项目进行过程中，原始确定目标的变化。它通常会导致项目完成的延迟，并影响最终的可交付成果。

你对网站的抓取越广泛，你从渗透测试中获得的价值就越大。爬虫应该能够到达网页上的每个链接，以正确地绘制出攻击面。在基于 AJAX 的应用程序中，爬虫可以识别的链接取决于应用程序的逻辑流。在本节中，我们将讨论三种可用于抓取 AJAX 应用程序的工具：

*   AJAX 爬行工具
*   斯普拉贾克斯
*   AJAX Spider–OWASP ZAP

### AJAX 爬行工具

**AJAX 爬行工具**（**ACT**）用于枚举 AJAX 应用程序。它可以与 web 应用程序代理集成。一旦爬网，链接将在代理界面中可见，您可以从该界面测试应用程序的漏洞，如下所示：

1.  Download the AJAX crawling tool from the following URL:

    [https://code.google.com/p/fuzzops-ng/downloads/list](https://code.google.com/p/fuzzops-ng/downloads/list)

2.  After downloading, start it from the bash shell using the following command:

    ```
    java –jar act.jar

    ```

    此命令将产生如下屏幕截图所示的输出：

    ![AJAX crawling tool](../Images/image01222.jpeg)

3.  指定目标 URL 并设置代理设置以将其与代理链接。在本例中，我使用的是在本地主机的端口`8010`上运行的 ZAP 代理。您还需要指定浏览器类型。要开始爬网，点击**爬网**菜单并选择**开始爬网**选项。
4.  Once the AJAX crawling tool starts spidering the application, new links will be visible in the proxy window, as shown in the following screenshot:

    ![AJAX crawling tool](../Images/image01223.jpeg)

### 斯普拉贾克斯

这是一个 web 应用程序扫描器，专门为使用 AJAX 框架构建的应用程序而设计。这是一个黑匣子安全扫描仪。它的工作原理是首先确定使用的 AJAX 框架，这有助于创建误报较少的测试用例。Sprajax 还可以识别典型的应用程序漏洞，如 XSS、SQL 注入等。它首先识别函数，然后通过发送随机值来模糊它们。

Sprajax 的 OWASP 项目的 URL 如下：

[https://www.owasp.org/index.php/Category:OWASP_Sprajax_Project](https://www.owasp.org/index.php/Category:OWASP_Sprajax_Project)

除了 AJAX 爬行工具和 Sprajax 之外，您还可以使用 Burp proxy 或 ZAP 来爬行 AJAX 网站，但手动爬行应用程序也应该是您行动计划的一部分，因为基于 AJAX 的应用程序可能包含许多隐藏的 URL，这些 URL 只有在您了解应用程序的逻辑时才会公开。

### AJAX spider–OWASP ZAP

AJAX spider 与 ZAP 集成。它使用了一种简单的方法，它遵循通过浏览器可以找到的所有链接，甚至是由客户端代码生成的链接，这有助于它有效地抓取广泛的应用程序。

可以从**攻击**菜单调用 AJAX spider，如下图所示：

![AJAX spider – OWASP ZAP](../Images/image01224.jpeg)

接下来有是在爬行器开始爬行之前要配置的参数。您可以选择插件要使用的 web 浏览器。在**选项**选项卡中，您可以定义要打开的浏览器数量、爬网深度和线程数量。修改这些选项时要小心，因为这样会减慢爬行速度。

![AJAX spider – OWASP ZAP](../Images/image01225.jpeg)

当爬网开始时，一组浏览器窗口打开，结果将填充到底部窗格中的 AJAX spider 选项卡中。

## 分析客户端代码——Firebug

我们已经讨论了客户端代码的增加如何导致潜在的安全问题。AJAX 使用 XHR 对象向服务器发送异步请求。这些 XHR 对象是使用客户端 JavaScript 代码实现的。有几种方法可以进一步了解客户端代码。使用*Ctrl*+*U*快捷键查看源代码将显示创建 XHR 对象的底层 JavaScript。如果网页和脚本很大，那么通过查看源代码来分析应用程序将不会有帮助和实用。

要了解脚本发送的实际请求的更多信息，可以使用 web 应用程序代理并拦截流量。由于 AJAX 应用程序中发送的请求量很大，因此使用代理拦截和分析每个请求不是明智的选择。

在本节中，我们将使用 Firefox 插件 Firebug 来查看客户端 web 浏览器上引擎盖下发生的事情。插件工具与 Firefox web 浏览器集成良好，以结构化形式显示 web 浏览器上发生的活动。Firebug 可用于执行以下操作：

*   实时编辑 HTML 的布局
*   监视网页的网络使用情况
*   可以使用内置调试器调试 JavaScript
*   快速识别 DOM 对象
*   查看有关服务器设置的 cookie 的详细信息

可从以下 URL 下载并安装该插件：

[https://addons.mozilla.org/en-US/firefox/addon/firebug/](https://addons.mozilla.org/en-US/firefox/addon/firebug/)

一旦安装了插件，Firefox 导航工具栏上就会出现一个灰色 bug。你需要点击 bug 来启动插件，一旦启用，bug 的颜色就会变为橙色。

此外，您还可以右键单击特定元素，如登录字段，然后选择**使用 Firebug 检查**：

![Analyzing client-side code – Firebug](../Images/image01226.jpeg)

### 提示

显示 firebug 窗口的快捷键为*F12*。

### 脚本面板

在**脚本**面板中，您可以更深入地了解实际的 JavaScript 代码。它包括一个调试器，您可以使用该调试器设置断点或逐步执行脚本，分析客户端代码流并识别易受攻击的代码。可以使用下拉菜单单独查看每个脚本。在脚本执行期间，**手表**侧面板将显示变量值的变化。您设置的断点在**断点**面板下可见，如下图所示：

![The Script panel](../Images/image01227.jpeg)

### 控制台面板

**控制台**面板以结构化形式显示**标题**、**帖子**和**Cookies**选项卡。它还包括一个 JavaScript 命令行编辑器，该编辑器在窗口底部可见。它允许您在当前网站的上下文中执行 JavaScript 代码。单击右下角的红色图标可放大命令行编辑器：

![The Console panel](../Images/image01228.jpeg)

### 网络面板

在**网络**面板中的**XHR**节点下，显示所有 XHR 请求和响应。它将列出实际发送的 AJAX 请求和收到的响应。响应通常是 XML 或 JSON 格式，以结构化形式显示。这有助于分析服务器返回的实际数据。下面的屏幕截图解释了这一点：

![The Network panel](../Images/image01229.jpeg)

### 注

Chrome 浏览器还包括一个类似于 Firebug 的工具：开发者工具。使用*Ctrl*+*Shift*+*I*快捷键打开。

前面讨论的漏洞可能存在于 AJAX 应用程序中，因为应用程序的基本设计保持不变，开发人员需要遵循最佳实践来保护应用程序免受漏洞的影响。

如果基于 AJAX 的应用程序中存在 XSS 或 CSRF 漏洞，则这些漏洞的影响将被放大，从而使攻击者的任务变得更容易。正如我们所知，XSS 使用 JavaScript 通过在受害者的浏览器中注入脚本来攻击和窃取信息。AJAX 核心的 XMLHttpRequestAPI 是一把双刃剑。除了能够在后台与服务器通信外，攻击者还可以利用它在后台窃取信息，而用户不会注意到它。在不涉及用户交互的情况下，它可以进一步发展为 XSS 蠕虫，并将 XSS 负载注入网页。2005 年影响 Myspace 网站的自传播 XSS 蠕虫就是使用 AJAX 黑暗面的完美例子。

# 网络服务

Web 服务基于面向服务的体系结构。面向服务的体系结构允许服务提供者轻松地与该服务的使用者集成。Web 服务使不同的应用程序能够在它们之间共享数据和功能。它允许消费者通过互联网访问数据，而应用程序不知道数据的格式或位置。

当您不想公开数据模型或用于访问数据的逻辑，但仍然希望数据随时可供其消费者使用时，这一点就变得非常重要。例如，证券交易所公开的 web 服务。在线经纪人可以使用此 web 服务获取有关股票的实时信息，并将其显示在自己的网站上，供最终用户购买。经纪人网站只需要调用服务并为公司请求数据。当服务回复数据时，web 应用程序可以解析信息并显示它。

Web 服务是独立于平台的，证券交易所应用程序可以用任何语言编写，并且无论构建应用程序所使用的底层技术如何，您仍然可以调用该服务。服务提供商和消费者唯一应该同意的是数据交换规则。

有些人把 web 服务混淆为 web 应用程序的一种形式；web 服务不包含 GUI，因为它只是一个由托管代码组成的组件，web 应用程序可以使用 HTTP 远程访问托管代码。它允许 web 应用程序从可能在完全不同的平台上运行的第三方服务提供商处访问和请求数据。

目前有两种不同的方式来开发 web 服务：

*   **简单对象访问协议**（**SOAP**）
*   RESTful web 服务

### 注

**休息**站进行**表征状态转移**。RESTful 是一个术语，用于指实现 REST 体系结构的 web 服务。

## 引入 SOAP 和 RESTful web 服务

SOAP 一直是开发 web 服务的传统方式，但它有许多缺点，应用程序现在正转向 RESTful web 服务。XML 是使用 SOAP web 服务时唯一可用的数据交换格式，而 RESTful web 服务可以使用 JSON 和其他数据格式。尽管由于额外的安全规范，在某些情况下建议使用基于 SOAP 的 web 服务，但由于其简单性，轻量级 RESTful web 服务是许多开发人员的首选方法。SOAP 是一种协议，而 REST 是一种体系结构风格。亚马逊、Facebook、谷歌和雅虎！已经转移到 RESTful web 服务。

RESTful web 服务的一些特性如下所示：

*   与 CRUD 操作配合得非常好
*   更好的性能和可扩展性
*   可以处理多种格式
*   较小的学习曲线
*   与 web 应用程序类似的设计理念

### 注

CRUD 代表创建、读取、更新和删除，描述了持久存储的四个基本功能。

SOAP 比 REST 的主要优势是 SOAP 独立于传输，而 REST 只在 HTTP 上工作。REST 是基于 HTTP 的，因此可以使用影响标准 web 应用程序的相同漏洞来对付它。幸运的是，可以应用相同的安全最佳实践来保护 RESTWeb 服务。

开发 SOAP 服务所涉及的复杂性迫使许多组织转向 REST 服务，在 SOAP 服务中，XML 数据被包装在 SOAP 请求中，然后使用 HTTP 发送。它还需要一个 WSDL 文件来提供与服务相关的信息。必须在发布 WSDL 文件的地方维护 UDDI 目录。

RESTful 服务的基本思想是，它不使用 SOAP 等复杂机制，而是通过 HTTP 直接与服务提供者通信，而不需要任何附加协议。它使用 HTTP 创建、读取、更新和删除数据。

基于 SOAP 的 web 服务的使用者发送的请求如下所示：

```
<?xml version="1.0"?>
<soap:Envelope
xmlns:soap="http://www.w3.org/2001/12/soap-envelope"
soap:encodingStyle="http://www.w3.org/2001/12/soap-encoding">
  <soap:body sp="http://www.stockexchange.com/stockprice">
    <sp:GetStockPrice>
      <sp:Stockname>xyz</sp:Stockname>
    </sp:GetStockPrice>
  </soap:Body>
</soap:Envelope>
```

另一方面，发送到 RESTFul web 服务的请求可以如此简单：

```
http://www.stockexchange.com/stockprice/Stockname/xyz

```

应用程序使用`GET`请求从 web 服务读取数据，这具有较低的开销，并且开发人员也易于编写代码，不像 SOAP 请求那样，SOAP 请求既长又复杂。虽然 RESTful web 服务也可以使用 XML 返回数据，但很少使用 JSON 作为返回数据的首选方式。

## 保护 web 服务

在真实场景中，您将遇到更多的应用程序，您需要了解 web 应用程序如何与 web 服务交互，并确定是否存在攻击者可以利用的漏洞。应针对以下安全问题保护 RESTFul web 服务：

*   应该使用会话令牌或 API 密钥对 web 服务的使用者和提供者之间的会话进行身份验证和维护。绝不应在 URL 中传递 API 密钥、用户名和会话令牌。会话状态应始终保持在服务器端，而不是客户端。RESTful 服务在默认情况下不提供任何安全性—它依赖于传输层安全性来保护数据，而数据是在线的。建议使用 SSL 来保护传输中的数据。soapweb 服务使用 WS-security，它提供了比 HTTPS 更健壮的消息级安全性。您不应该在 URL 中传递 API 密钥，因为 SSL 不保护 URL 参数，并且密钥记录在书签和服务器日志中。应使用 OAuth 或 HMAC 身份验证。在 HMAC 身份验证中，API 密钥使用在客户端和服务器之间共享的密钥进行加密。
*   RESTFul web 服务的大多数任务都是使用`GET`、`POST`、`DELETE`和`PUT`方法完成的。例如，在证券交易所 web 服务中，可能允许匿名用户使用`GET`方法查询股票价值，但对于未经身份验证的用户，绝不允许使用`PUT`或`DELETE`方法。当允许对给定 URL 使用多个方法时，web 服务应该小心。对于不允许针对 URL 的方法，应发回禁止的消息。对于涉及`PUT`和`DELETE`方法的关键任务，应使用随机令牌来缓解 CSRF 攻击。大多数 web 服务使用以下四个动词：

    <colgroup><col><col></colgroup>
    | 

    HTTP 动词

     | 

    使用

     |
    | --- | --- |
    | `GET` | 检索数据 |
    | `PUT` | 插入数据 |
    | `POST` | 更新数据 |
    | `DELETE` | 删除数据 |

*   应该使用随机生成的数据测试 web 服务，以验证验证过滤器的实现。使用有限字符数的输入字段应使用基于白名单的方法。使用这种方法，我们可以定义什么是可接受的，并构建应用程序可接受的合法输入列表。拒绝不属于白名单的任何字符或不受信任的数据。
*   If the web service is using XML, it should be tested against common XML-based attacks such as XPath injection, XQuery injection, XML schema poisoning, and others.

    当出现异常时，RESTful API 应该像在常规 web 页面中一样使用适当的错误消息进行响应，并使用 HTTP 状态代码将错误返回给客户端。在异常消息中，尽可能少地留下服务器信息。以下是响应代码：

    <colgroup><col> <col></colgroup> 
    | 

    响应代码

     | 

    意思

     |
    | --- | --- |
    | 100s–信息 | 我们都很酷 |
    | 200s-成功 | 我有你需要的 |
    | 300s–重定向 | 在那边 |
    | 400s–客户端错误 | 你把事情搞砸了 |
    | 500s–服务器错误 | 我把事情搞砸了 |

### 不安全的直接对象引用漏洞

不安全的直接对象引用漏洞不是 RESTful web 服务特有的，但在其中很普遍。我们熟悉显示产品及其相关信息的电子商务应用程序。最有可能的是，开发人员会在后端使用一个唯一的 ID 来标识产品。当产品通过主键存储在数据库中时，此 ID 还可以识别产品。因此，ID 成为直接对象引用。

在使用 web 服务的电子商务应用程序中，对 API 的调用如下所示：

`https://example.com/product/234752879`

然后以 JSON 格式返回产品信息，该格式将被格式化并显示在客户端浏览器上：

```
{
  "id": "234752879",
  "product_name": "webcam",
  "product _family": "electronics",
  "section": "computers",
  "Cost": "500"
}
```

如果增加产品 ID，则返回产品`234752880`的数据，而不是`234752879`。这在这个特定的 web 应用程序中不是一个大问题，但是如果在金融应用程序中，您对可能存储敏感信息的帐号有一个直接的对象引用，并且您能够通过操纵帐户 ID 来查看其他帐户的数据，那么该怎么办呢；否则，您将面临有人使用直接对象引用访问敏感数据的风险。不安全的直接对象引用是 web 服务中的一个主要问题，在测试 RESTFul web 服务时，应该将其放在待办事项列表的首位。

使用 web 服务的应用程序增加了攻击面，也改变了应用程序的风险状况。测试方法与普通 web 应用程序并无不同，应用程序仍应针对 OWASP 十大漏洞进行测试。

# 总结

这一章是关于 Web2.0 的。AJAX 和 web 服务在互联网革命中发挥了非常重要的作用。我们从 AJAX 开始，讨论了基于 AJAX 的应用程序的构建块。然后，我们研究了由于多种技术协同工作而产生的安全问题。我们还介绍了使其不同于普通 web 应用程序的 web 服务。接下来，我们讨论了应用程序在引入 web 服务时可能面临的安全问题。

在下一章中，我们将讨论模糊，并使用不同的模糊技术来发现 web 应用程序中的漏洞。