# 第 10 章：模糊 Web 应用程序

在前面的章节中，我们了解了如何识别 web 应用程序中的漏洞。我们使用 Kali Linux 中的工具找出注入缺陷、脚本缺陷和其他几个常见漏洞。我们知道 web 应用程序包含不容易识别的参数，我们需要更全面的方法来发现漏洞。

为了进一步提高应用程序的安全性和健壮性，我们可以对应用程序的源代码执行静态代码分析，这将有助于识别攻击者可以利用的不当编程实践和编码问题。然而，静态分析有一些局限性。它仅在非活动状态下评估应用程序。对源代码执行静态分析不会帮助您发现应用程序在实时运行以及客户端与之交互时的行为。要使用静态分析方法，我们还需要访问应用程序的源代码。

分析应用程序行为的更有效方法是在运行时使用模糊技术。在对应用程序进行模糊化时，我们与处于运行状态的 web 应用程序进行交互，并模拟最终用户。当您测试 web 应用程序的特定漏洞（如 XSS 或 SQL 注入）时，您使用定义的标准构建了测试。除了以预定义的方式测试应用程序外，还应该使用未定义的标准测试应用程序，这将有助于发现导致开发人员忽略的意外行为的缺陷。使用未定义的标准探索应用程序的艺术称为模糊化。

将随机数据注入应用程序会产生不同的效果，并且可能会反映每个输入的不同输出。此试错方法可能导致攻击者发现应用程序中以前未发现的漏洞。1989 年，Barton Miller 教授首次使用模糊化的思想来测试 UNIX 应用程序的健壮性。从那时起，模糊化已经发展了很多，许多开源和商业模糊器已经被开发出来，用于自动化测试。

在本章中，我们将讨论模糊化，并使用它来识别 web 应用程序中的缺陷。我们将讨论以下主题：

*   模糊基础
*   模糊技术的类型
*   模糊化的应用
*   模糊框架
*   起毛步骤
*   Web 应用程序模糊化
*   Kali Linux 中的 Web 应用程序模糊器

# 模糊基础

模糊化是一种测试机制，它向软件实现发送格式错误的数据。实现可以是 web 应用程序、胖客户端或在服务器上运行的进程。它是一种以自动化方式注入数据的黑盒测试技术。模糊可以用于一般测试，但主要用于安全测试。

模糊化经常暴露出应用程序中的严重缺陷。随机数据模糊可能导致程序崩溃，从而导致拒绝服务攻击。模糊测试的结果取决于模糊软件生成可触发应用程序异常的输入的能力。您发现的一些 bug 可能是可利用的，而其他 bug 可能是不可利用的。通常使用模糊识别的一个常见缺陷是缓冲区溢出缺陷。从用户处获取输入的应用程序如果未能对其执行任何绑定检查，则可能导致可利用的情况。Fuzzer 生成随机数据，作为测试此类漏洞的输入。

模糊已经成为一种非常有用的研究技术，被所有主要的软件公司使用，如微软、谷歌和苹果。他们已经将模糊集成到他们的软件开发生命周期中，这有助于在开发的早期阶段识别缺陷。

以下是模糊化的主要优点：

*   使用模糊化，您可以在不深入了解应用程序的情况下发现有趣的漏洞
*   使用模糊识别的许多缺陷都是严重的漏洞，如缓冲区溢出，可导致任意代码注入攻击
*   Fuzzing 通过模拟最终用户来测试应用程序，因此它给出了准确的结果
*   模糊测试可以发现应用程序中经常被开发人员忽略的缺陷

模糊也有一些缺点：

*   当软件在自动模糊化过程中崩溃时，可能很难确定缺陷的确切检测位置。
*   软件崩溃不一定会导致可利用的情况；您需要进一步测试以确定如何利用该缺陷。
*   模糊测试在很大程度上依赖于输入的质量来测试应用程序中的各种条件。如果只是随机数据，那么它与暴力攻击没有什么不同。复杂且规模大的应用程序需要设计良好的模糊器来实现完整的代码覆盖。

### 注

代码覆盖率是描述 fuzzer 测试的代码量的度量。这样做的目的是，覆盖范围越广，丢失应用程序部分的可能性就越小。

# 模糊技术的类型

模糊化可以大致分为智能模糊化和哑模糊化。在技术术语中，它被称为变异模糊和生成模糊。提供随机数据作为输入是模糊化的全部内容。输入可以是完全随机的，没有关于所需输入应该是什么样子的关系和知识，或者可以模拟有效的输入数据生成输入，并进行一些更改（因此名称生成模糊化）。

## 突变模糊

变异模糊，或哑模糊，使用了一种更快的方法使用样本数据，但它缺乏对所需输入的格式和结构的理解。使用变异模糊化，您可以不费吹灰之力地创建模糊器。变异模糊技术使用样本输入，并以随机方式对其进行变异。对于每个模糊尝试，数据都会发生变化，从而在后续模糊尝试中产生不同的输入。位翻转是变异模糊器可以使用的方法之一。哑模糊器可以简单地将`/dev/random`的输出管道化到应用程序中。

### 提示

`/dev/random`是 Linux 中生成随机数据的特殊文件。

变异模糊器可能并不智能，但您会发现许多应用程序被这种简单的模糊技术绊倒。变异模糊处理不适用于需要特定格式数据的更复杂的应用程序，它甚至会在处理错误的数据之前拒绝这些数据。

## 生成模糊

基于生成的模糊器，或者更常见的称为智能模糊器，采用不同的方法。这些模糊程序了解应用程序接受的数据的格式和结构。它根据该格式从头开始生成输入。基于生成的模糊程序需要事先理解和智能，以便构建对应用程序有意义的输入。向模糊器添加智能可以防止数据被拒绝，就像变异模糊一样。生成模糊使用规范或 RFC，其中包含有关格式的详细信息。智能 fuzzer 作为一个真正的客户机注入数据，并根据应用程序的响应创建动态回复。

基于生成的模糊器更难设计，需要更多的精力和时间。努力的增加产生了一个更高效的模糊器，它可以发现更深层的缺陷，而这些缺陷是变异模糊器无法触及的。

## 模糊化的应用

模糊化可用于测试多种软件实现。任何接受输入的代码都可能是模糊化的候选者。fuzzing 最常见的一些用途如下：

*   网络协议模糊化
*   文件模糊
*   用户界面模糊化
*   Web 应用程序模糊化

### 网络协议模糊化

网络协议执行中的漏洞构成了严重的安全问题。协议中的漏洞可使攻击者通过互联网通过易受攻击的机器获得访问权限。如果网络协议有很好的文档记录，那么这些信息可以用来创建智能模糊器和不同的测试用例，根据这些测试用例可以测试协议的行为。

网络协议通常基于客户机-服务器体系结构，其中客户机启动连接，服务器响应。因此，协议需要在两个方向上进行测试，首先连接到服务器，使用测试用例对其进行模糊化，然后充当服务器，等待客户机连接，模糊器响应，在客户机上测试协议的行为。协议模糊器也称为远程模糊器。

### 文件模糊

攻击者越来越多地使用客户端攻击。发送恶意 Word 文档、PDF 文件和图像是攻击者可能使用的一些技巧。在文件模糊处理中，您故意将格式错误的文件发送到软件并测试其行为。文件打开时软件崩溃可能表明存在该漏洞。通过文件模糊识别的常见漏洞有堆栈溢出、堆溢出、整数溢出和格式字符串缺陷，这些漏洞可转化为远程代码执行攻击。使用文件模糊处理，可以创建格式错误的文件头，也可以在文件格式内处理特定字符串。`FileFuzz`和`SKIPEfile`是两种文件模糊工具。

使用文件模糊处理，可以针对以下目标：

*   文档查看器
*   媒体播放器
*   网络浏览器
*   图像处理程序
*   压缩软件

### 用户界面模糊化

带有图形用户界面的厚客户端软件也可以使用格式错误的输入进行模糊化。应针对缓冲区溢出漏洞测试这些应用程序中的输入字段。理想情况下，任何接受输入的应用程序都可以使用模糊化进行测试。

### Web 应用程序模糊化

模糊化 web 应用是安全领域的一个活跃研究领域。由于多种技术的混搭和第三方集成，Web 应用程序变得越来越复杂，这使得它成为模糊化的一个有吸引力的选择。使用模糊化，您不仅可以识别跨站点脚本和 SQL 缺陷，还可以帮助您发现应用程序中在早期测试阶段可能被忽略的部分中的漏洞。我们将在本章后面讨论更多关于 web 应用程序模糊化的内容。

### 网络浏览器模糊化

Web 浏览器最近引起了安全研究人员的注意。浏览器类似于使用文件模糊器进行模糊化的普通软件，但由于其与 web 应用程序的交互，因此值得额外注意。浏览器模糊化是发现浏览器中 bug 的最常见和最有效的方法。web 浏览器通常处理的文件格式是 HTML。对格式错误的网页进行模糊处理可能会暴露浏览器呈现引擎中的缺陷。由于浏览器通常用于打开托管在远程服务器上的网页，因此托管恶意网页的恶意用户可能会利用易受攻击的浏览器进行攻击。Mangleme 和 Crossfuzz 是两个著名的浏览器模糊器。

## Fuzzer 框架

专门的模糊化软件在测试常见文件格式和有良好文档记录的软件时做得很好，但它们对专有软件和代码无效。这就产生了模糊化框架，因为为每个应用程序从头开始创建模糊器是不可行的。

框架是一种概念结构，用于根据其指定的规则构建有用的内容。fuzzing 框架是一组库，充当通用 fuzzer，您可以使用它为不同的目标创建模糊数据。这些框架可用于全面测试协议或定制应用程序。

使用 fuzzing 框架，您可以在更短的时间内创建 fuzzer 来测试专有软件。您不必从头开始设计 fuzzer，因为内置库完成了大部分工作。fuzzing 框架的目的是提供一个可重用、灵活和快速的开发环境来构建 fuzzer。

一些最成熟和最广泛使用的框架如下：

*   萨利
*   尖峰
*   桃

使用框架创建 fuzzer 需要一些脚本技巧，因为您需要自定义和扩展它以满足您的需要。这些框架是用不同的语言开发的，SPIKE 框架是用 C 语言编写的，而 Sulley 和 Peach 是用 Python 开发的。

在上一段列出的三个框架中，我更喜欢 Sulleyfuzzing 框架，因为它是一个功能丰富的框架，由 Fuzzer 中通常找不到的附加组件组成。它不仅创建数据表示，而且还监视目标以定位准确的碰撞条件。它使用一些称为代理的东西来监视模糊条件下目标的健康状况，并在模糊完成后重置目标。

### 注

有关 Sulley 框架的更多信息，请参见[https://github.com/OpenRCE/sulley](https://github.com/OpenRCE/sulley) 。

对模糊框架的详细分析超出了本书的范围，但如果您正在测试定制软件或 web 应用程序，模糊框架应该是您的武器库的一部分。

## 起毛步骤

在攻击目标之前，模糊需要一些准备步骤。下图显示了模糊测试的构建块：

![Fuzzing steps](../Images/image01230.jpeg)

模糊化涉及的典型步骤如下所述：

*   **了解协议**：了解应用中使用的协议是模糊化的第一步也是最重要的一步。除非您了解应用程序使用的协议，否则很难开发测试用例。如果您正在测试专有网络协议，则需要有关如何生成数据包及其正确格式的信息。
*   **定位输入参数**：您正在模糊化的目标可能通过不同的方法获取输入。web 应用程序接受来自 web 表单中各种参数的输入。HTTP 协议的不同头字段也充当应用程序的输入，并成为模糊化的候选对象。通过命令行和不同格式的文件传递输入是应用程序接受数据的其他方式。
*   **生成感兴趣的数据**：模糊化的目的是向目标提供异常数据，作为其通常不希望接收的输入。fuzzer 的任务是生成数据，创建崩溃条件，尽管目标已接受。生成智能数据是优秀模糊程序与其他模糊程序的不同之处。
*   **注入模糊数据**：一旦输入参数和模糊数据准备就绪，就可以将其发送到网络上的目标。
*   **监视和记录**：当模糊器开始模糊化时，您需要监视目标，等待应用程序由于传递给它的数据不正确而达到崩溃状态。应记录此崩溃情况，并捕获导致崩溃的数据。最理想的方法是在应用程序崩溃时捕获其内存转储。
*   **分析与利用**：碰撞条件不一定会导致可利用的情况。您需要分析数据，如果您在事后捕获了内存转储，使用调试器将帮助您了解崩溃背后的原因以及导致崩溃的数据。

## 使用模糊测试 web 应用程序

到目前为止，我们讨论了模糊作为针对目标的通用安全测试技术。当您对 web 应用程序进行渗透测试时，模糊化也扮演着重要的角色。它可能会暴露漏洞，例如输入验证不正确和边界检查不足。这些缺陷可能导致暴露 web 应用程序环境的详细信息，如操作系统版本、应用程序版本和数据库详细信息，甚至可能导致缓冲区溢出情况，可利用这些情况执行远程代码执行攻击。任何基于 HTTP 协议规范构建的 web 应用程序都可以模糊化。

### web 应用中的模糊输入

多年来，开发 web 应用程序变得越来越容易。编程语言变得更加用户友好，这导致更多的组织在内部开发 web 应用程序。不幸的是，在关闭所有主要漏洞的情况下开发一个安全的 web 应用程序是一项困难的任务。Web 应用程序从不同的参数（如 URL、标题和表单字段）获取输入，如果未正确验证这些数据，则会导致攻击者利用漏洞进行攻击。

#### 请求 URI

使用带有 URI 的`GET`请求传递的参数可以模糊化。当应用程序被注入恶意 URI 时，它可能会根据注入的数据做出不同的响应。

请求 URI 可能包括以下参数：

```
/[path]/[page].[extension]?[name]=[value]
```

以下是通过`GET`发送的请求示例：

```
/docs/task.php?userid=101
```

模糊每个参数可能会导致攻击者找到应用程序中普通用户无法看到的新部分。例如，模糊化`path`参数可能导致路径遍历攻击。类似地，用可预测的名称模糊化`page`参数可能会导致信息泄漏。

通过将`userid`值更改为具有管理权限的用户的 ID，模糊化`name`参数可能导致权限提升。最后，模糊化`value`参数可能会暴露 XSS、命令注入和 SQL 注入缺陷。

#### 标题

许多应用程序从客户端发送的头中捕获数据，以便在服务器端执行某些任务。例如，应用程序将依赖用户代理值来决定要返回给用户的内容。如果应用程序未对用户代理字符串执行正确的输入验证，攻击者可能会利用该字符串进行攻击。

应模糊以下标题字段，以确定它们是否可被利用：

*   `Referrer`
*   `Content-Length`
*   `Host`
*   `Accept language`
*   `Cookie`
*   `User-Agent`

SQL 注入、跨站点脚本、命令注入和缓冲区溢出缺陷可以通过模糊头字段来发现。通过模糊 cookie 值，黑客可以预测其他用户的会话 ID 并劫持会话。如果存储了额外的 cookie 以在服务器和客户端之间共享数据，则应该对其进行模糊处理，以确定其是否容易受到任何 SQL 或 XSS 漏洞的攻击。

#### 表单字段

应彻底模糊包含不同参数的 web 表单，以测试应用程序实现的输入验证。应用程序开发人员应该为每个字段设置正确的绑定检查，并拒绝超出该字段的数据。例如，PIN 码的输入字段应仅接受数字。应用程序还应丢弃输入中可能导致 XSS 缺陷的任何类型的脚本标记。

### 起毛检测结果

监视 web 应用程序的异常情况有点不同。模糊化活动通常不会使应用程序崩溃并生成可在调试器中分析的内存转储。您需要依赖应用程序和 HTTP 代码返回的错误消息。状态代码`403`表示您试图访问的资源受到限制，您无权查看；`404`错误代码表示您试图访问的网页不可用；`500`错误代码表示内部服务器错误。

一些 web 应用程序会返回显示应用程序内部的错误消息，如 SQL 错误消息。使用此选项，您可以推断是否可以进一步利用该应用程序。

### 注

整个 HTTP 错误代码列表可在[找到 http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html](http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)

如果您使用随机数据进行模糊处理，您经常会看到`404`错误代码。

## Kali Linux 中的 Web 应用程序模糊器

在 Kali Linux 2.0 中，您可以在**应用程序****Web 应用程序分析**中找到用于模糊化的不同工具：

*   Burp 套件教程
*   Owasp zap
*   功率模糊器
*   韦伯斯卡拉布
*   网工
*   Websploit
*   Wfuzz
*   Xsser

前面提到的一些工具以前已经使用过，并且不是专门用于模糊化，而是将模糊化作为一个附加功能。Burp 套件、Owasp zap 和 WebScarab 是功能强大的代理拦截工具，具有内置的模糊选项。

### 使用打嗝入侵者进行起毛

Burp 入侵者是 Burp 套件中的一个工具，可以模糊 web 应用程序中的不同参数。您可以自动执行注入模糊数据的任务，完成后将显示结果。使用入侵者，您可以发现诸如 XSS、目录遍历、SQL 和命令注入等缺陷。

设置入侵者是一个多步骤的过程：

1.  首先，您需要配置 Burp 代理，以便它拦截连接。接下来，重要的部分是确定需要模糊化的易受攻击的请求和参数。
2.  Once you have intercepted the request, right-click on it and click on **Send to Intruder**, as shown in the following screenshot:

    ![Fuzzing using Burp intruder](../Images/image01231.jpeg)

3.  Click on the **Intruder** tab, where you will see the requests that you have sent from the previous step:

    ![Fuzzing using Burp intruder](../Images/image01232.jpeg)

    这里的重要任务是标记请求中要模糊化的位置。**入侵者**部分有四个子选项卡：**目标**、**位置**、**有效载荷**和**选项**。您发送给入侵者的每个请求都有编号，如前面的屏幕截图所示。

4.  选择您发送给入侵者的请求，在该请求下，您将看到四个选项卡：

    *   **目标**：**目标**选项是不言自明的，如果您针对的是您拦截连接的同一应用程序，则应保持原样。
    *   **位置**：在**位置**选项卡下，您需要定义要插入模糊有效载荷的位置。例如，如果要模糊 URL 中的`userID`参数，则需要选择参数在 URL 中的具体位置。您还可以选择要插入有效负载的多个位置。打嗝入侵者在模糊化时使用不同的攻击类型：

        *   **狙击手**：所选参数的每个都使用单个有效载荷顺序模糊化。当测试特定漏洞（如 XSS 漏洞）的多个参数时，此方法非常有用。
        *   **击锤**：在这种方法中，有效载荷同时发送到所有选择的参数。然后，使用第二个有效载荷对参数进行模糊化，依此类推。当您需要同时在多个位置插入相同的输入时，此攻击方法非常有用。例如，当您模糊化`ID`字段并希望在多个位置更改该参数的值时。
        *   **干草叉**：在该方法中，使用定义的有效载荷模糊每个参数。它使用多个有效载荷集。在模糊化时，它将每个集合的有效负载插入到特定位置。当您希望使用负载组合进行模糊化，同时将数据插入多个位置时，此攻击方法非常有用。在电子商务 web 应用程序中模糊多个参数（如`Itemcode`及其价格）时，此方法可能很有用；您可以同时模糊这两个参数，因为它们彼此相关。
        *   **集束炸弹**：这种攻击方法的目的是使用有效载荷的所有组合来测试参数，当您需要在多个位置插入不同和不相关的数据时，这非常有用。

    *   **有效载荷**：模糊数据通常称为有效载荷。在这里，您可以定义各种有效载荷和不同选项来生成模糊数据。**有效载荷**部分包含多个选项，重要选项如下：

        *   **简单列表**：这是通过文本文件导入有效载荷的最基本方式。
        *   **运行时文件**：如果您有一个好的负载存储库，您可以在运行时导入它。
        *   **自定义迭代器**：这将基于定义的模板创建字符组合。
        *   **字符替换**：导入预设的有效载荷列表，通过替换其中的字符创建多个有效载荷。
        *   **大小写替换**：顾名思义，在模糊`password`字段时会导入有效负载列表并切换有用字符的大小写。

    *   **选项**：在**选项**选项卡下，您可以进行一些性能调整。您还可以启用 DOS 模式（不建议在生产环境中使用）。处理来自服务器的响应时，**Grep-Match**和**Grep-Extract**选项非常有用。它可以匹配服务器返回的特定值，例如 SQL 错误和内部函数，并标记该请求。使用**Grep-Extract**选项，您可以从响应中提取感兴趣的特定值。

5.  In the following example, we are using the fuzzing to identify sub directories under the website. From the **Payload** options, I have selected the **Sniper** attack method. By default, when you send a request to the intruder, it will find out all parameters suitable for fuzzing and will mark them with the `§` symbol.

    如果您想自己选择参数，请点击**清除§**并将光标指向特定位置标记值，然后点击**添加§**。由于我正在模糊子目录，我将在`GET`请求头中添加标记：

    ![Fuzzing using Burp intruder](../Images/image01233.jpeg)

6.  Once you have decided on the parameters that you want to fuzz, you need to define the payload. In this example, I am importing a payload file during runtime:

    ![Fuzzing using Burp intruder](../Images/image01234.jpeg)

7.  The final step is to start the fuzzing attack by selecting the **Start attack** option under the **Intruder** menu at the top:

    ![Fuzzing using Burp intruder](../Images/image01235.jpeg)

    一个新窗口将打开，您将看到入侵者正在工作并填充**结果**选项卡。它记录发送的每个请求及其收到的响应。**长度**和**状态**列可以帮助您解释模糊结果。如以下屏幕截图所示，有效负载`railsgoat`的状态为`200`，这意味着它能够找到该名称的子目录：

    ![Fuzzing using Burp intruder](../Images/image01236.jpeg)

    为了帮助您解释结果，您可以使用 fuzzdb 中的错误字符串来查找有趣的错误消息。fuzzdb 是一个开源数据库，包含服务器响应消息列表、公共资源名称和用于模糊化的恶意输入。来自 fuzzdb 的`errors.txt`文件可以在入侵者的**Grep-Match**选项中导入：

    ![Fuzzing using Burp intruder](../Images/image01237.jpeg)

    此选项将搜索入侵者有效负载生成的响应页面，以查找错误消息的发生；其中包括 SQL 错误、PHP 解析错误和 Microsoft 脚本错误消息。响应页面中的错误消息可以帮助您确定应用程序是否易受攻击。

fuzzdb 的 GitHub 项目位于[https://github.com/rustyrobot/fuzzdb](https://github.com/rustyrobot/fuzzdb) 。原始项目在谷歌代码上，相关信息可在[中找到 https://code.google.com/p/fuzzdb/](https://code.google.com/p/fuzzdb/) 。`errors.txt`文件可在[找到 https://code.google.com/p/fuzzdb/source/browse/trunk/regex/errors.txt](https://code.google.com/p/fuzzdb/source/browse/trunk/regex/errors.txt) 。

### PowerFuzzer 工具

PowerFuzzer 是一种完全自动化的模糊工具。它不包括许多配置选项，是一个一键式工具。当您想要识别任何跨站点脚本和注入缺陷时，它非常有用。

您只需指定目标 URL，点击**扫描**；其他设置是可选的。如果需要，您可以排除特定路径，如果应用程序需要身份验证，还可以指定用户名和密码或 cookie：

![PowerFuzzer tool](../Images/image01238.jpeg)

# 总结

在本章中，我们讨论了模糊化。我们首先了解了在执行 web 应用程序渗透测试时的基础知识和它所增加的价值。我们看到了两种主要的模糊技术以及它可以应用到的不同类型的应用程序。然后，我们继续讨论模糊化框架，并确定了模糊化过程中涉及的不同步骤。Web 应用程序应该通过模糊化进行广泛的测试，因为它可以揭示一些隐藏的漏洞，这些漏洞在手动测试应用程序时被忽略了。我们还了解了如何使用 Burp 入侵者模糊 web 应用程序。

有了这些，我们的旅程就结束了。我希望这本书为您提供了一些想法，可以帮助您执行 web 应用程序的渗透测试。谢谢你的阅读。