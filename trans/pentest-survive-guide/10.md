# 第 10 章取证

在本章中，我们将讨论 CSI。不是你在 CSI 网络上看到的 CSI。这才是真正的交易。在您的系统管理员职业生涯中，可能会有一段时间，您必须交付必须维护一条**证据链**的数据。证据链是一份记录在案且可审计的清单，列出了如何、为什么以及由谁来处理、存储和检查证据。说到这个任务，卡利是你的朋友。您还将发现，我们将使用的一些技术在日常数据检索、复制磁盘映像以及扫描您自己的系统以查找不应在其所在位置（或者可能不在您预期的位置）的数据方面也非常方便。通过笔试，我们看到许多公司的合规评估失败，因为信用卡和个人数据被发现在错误的地方。员工在网络上泄露文件真是太神奇了。我们将首先探索**Guymager**，然后深入**尸检**：

*   进入数字取证
*   探索 Guymager
*   潜入尸检

# 进入数字取证

今天，随着计算机系统在所有领域的应用，当法律诉讼或犯罪发生时，有时所涉及的大部分证据将是数字的。如何处理证据链可以决定案件的成败。在对 PCI 或 HIPPA 进行第三方渗透测试时，您收集的数据是您的*证据*，应该像处理法律案件一样进行处理。在测试期间以及测试后证据的存储期间，应列出并遵循一系列证据。你永远不知道什么时候你认为只是一个正常的测试可能最终成为一个法律案件。例如，当您进行测试时，发现您不是网络上的唯一用户。您正在测试的网络已被破坏。现在你的*测试*已经变成了一个可以采取法律行动的事件响应案例。您的测试数据现在是法律证据。是的，这确实发生在现实生活中。薄熙来在为客户进行例行渗透测试时，发现自己不是网络中唯一的人。你可能就是那个发现线索将犯罪黑客绳之以法的人。法医学有很多不同的方面。你得看看被调查事件的整个尸体。法医调查和您选择的工具会有所不同，这取决于正在进行的调查类型。对网络黑客的调查将不同于对员工涉嫌数据盗窃的调查。我们将介绍的工具都有其特殊用途，因此，大多数情况下，工具将与其他工具一起使用，以完成调查。

在大多数情况下，您不会使用原始系统，而是在法律案件中使用系统的克隆。在机器被破坏和更换的情况下，您只是在调查破坏情况，看看发生了什么。在这种情况下，请确保使用沙盒网络，或者是一个只能访问虚拟主机的虚拟网络，或者使用一个没有上行链路的小型交换机来创建一个物理隔离网络，其中只有交换机上执行调查所需的机器。

# 探索 Guymager

在大多数法医项目中，您将从图像开始工作，因此首先让我们使用图像。Guymager 是一种用于媒体采集的法医成像仪。它有一个很好的 GUI，并以法医成像中使用的几种格式保存图像。应用程序还将克隆驱动器。您可以在**常用应用程序****系统工具**菜单中找到 Guymager：

![Exploring Guymager](../Images/image01005.jpeg)

Guymager 有两种保存文件的模式：

1.  获取模式，在该模式下，您可能需要用于数字证据的图像。
2.  克隆模式，以防需要复制整个分区。

不同之处在于，在采集模式下，使用校验和和和其他信息对图像进行数字签名，以证明未对图像进行篡改。在一个法律案件中，你会拉两张图片。你将获得一个并对其进行数字签名作为证据，然后克隆另一个进行调查。因为您真的不知道您的案例是否会成为法律程序的一部分，所以您可能希望总是提取正在克隆的分区的两个副本。如果你不这样做，那可能是一场灾难。

为了提取这些图像，您将需要两个大小相同或大于证据的驱动器将这些图像保存到。一个是你的证据驱动，一个是你的工作副本。接下来，您会注意到我们有一个`/dev/sdb`连接。这将是我们的 USB 驱动器，我们将把克隆的图像保存到它。

## 启动 Kali 进行取证

有几种方法可以获取磁盘内容进行测试：

*   你可能会有一台带驱动器的电脑，在那里你可以用一个 live 将 Kali 带到机器上。
*   您可能会收到发送给您的驱动器，该驱动器与以前连接的机器分开。
*   您可能会在可移动驱动器上获得一个映像文件。硬盘驱动器图像包含了原始硬盘的所有块，甚至空白区，因此图像文件可以是百万兆字节的数据。

由于此任务涉及按原样保存硬盘分区的内容，因此您不希望以通常的实时磁盘方式启动 Kali。实时磁盘模式会不时写入主机硬盘。如果向您提供的系统单元（主机）中包含意外或故意删除的文件，则这些文件可能会在驱动器上完全或部分保留不变。您肯定不想安装 Kali，因为这会部分或完全覆盖测试中的驱动器。对于这组任务，Kali 有一个**实时取证模式**，它使用测试机器上的 RAM，但不写入硬盘。重要的是不要在硬盘上写任何东西，不管它是否会成为法庭案件的证据。无法用其他文件恢复您在上面写入的文件片段：

![Starting Kali for Forensics](../Images/image01006.jpeg)

## 获取成为法律证据的驱动力

对于这个演示，我们将从机器的 Vmware 映像开始工作。如果您使用的是普通物理驱动器，则该方法将是相同的。如果您正在使用硬盘，请将硬盘连接到 Kali 成像机，然后单击**重新扫描**按钮。这将重新扫描所有驱动器，新连接的驱动器将显示在界面中。对于 Vmware 映像，请选择**添加专用设备**。这将为您提供一个文件菜单，以便您可以选择图像文件。您还可以将此命令用于其他图像类型，例如备份已连接驱动器上使用`dd`副本制作的图像：

![Acquiring a drive to be legal evidence](../Images/image01007.jpeg)

下面，您将看到我们已附加 Vmware 硬盘映像。我们还显示了`/dev/sda`，这是我们的操作系统驱动器，以及`/dev/sdb`，这是我们正在写入图像的 USB 驱动器：

### 提示

**黑客提示**

Gymager 显示驱动器的大小，这样您就可以确保您有空间进行复制。它还让您知道在初始扫描中是否发现任何隐藏分区。

![Acquiring a drive to be legal evidence](../Images/image01008.jpeg)

首先，让我们获取一张图像作为证据：

1.  右键单击 Vmware 映像。
2.  点击**获取**。您将获得一个信息块，用于嵌入图像中的信息，以及一种对副本进行校验和以防止篡改的方法。
3.  由于这是一份证据文件，我们选择了**专家证人格式**。这种格式可以与我们稍后将使用的其他法医工具一起阅读。这是一种标准的开放格式，由行业为此类工作利用。对于证据编号，让我们使用机器名、两个 0 作为分隔符以及日期。在这里，您不能使用特殊字符，否则稍后会出现错误。当然，Bo 是考官，我们添加了一个描述。
4.  设置目的地。我们正在将其保存到安装在`/media/root/usbdisk`的已安装 USB 驱动器中。
5.  给出图像文件名。当您为图像指定一个文件名时，它还将填写**信息文件名**字段。
6.  默认哈希计算设置为`MD5`。`MD5`的发明者认为它已经不存在了，所以让我们使用其他东西。就个人而言，我们更喜欢最高级别，所以让我们选择**SHA-256**，如下所示。这将增加成像时间，但这是值得的。
7.  （可选步骤）在法律情况下，您还需要验证结果。如上所述，这将需要两倍的时间。
8.  Click the **Start** button to run:

    ![Acquiring a drive to be legal evidence](../Images/image01009.jpeg)

在以下屏幕截图中，Guymager 正在运行：

![Acquiring a drive to be legal evidence](../Images/image01010.jpeg)

一旦 Guymager 完成运行，您将看到以下屏幕。底部部分将为您提供有关映像和运行时的信息：

![Acquiring a drive to be legal evidence](../Images/image01011.jpeg)

## 用 Guymager 克隆

如果您只是使用 Guymager 来克隆分区，那么任务就简单多了。这是第二个 Kali 设置，因此驱动器名称不同。右键单击要克隆的分区，如下所示：

![Cloning With Guymager](../Images/image01012.jpeg)

然后，您将获得以下窗口：

1.  突出显示克隆要进入的分区。
2.  设置**信息**目录。
3.  设置目标文件名。同样，您将无法在此处使用特殊字符`-`、`_`或`+`。
4.  设置校验和哈希类型。
5.  （可选步骤）选中该框以验证文件。这是处理任何成像的最佳实践。您不想浪费时间对损坏的驱动器映像进行分析。
6.  点击**启动**按钮运行。

下面的屏幕截图是一个非常有用的对话框，显示了连接到 Kali 框的驱动器。唯一一个足够容纳被克隆设备全部内容的驱动器是第二个驱动器，总共`107.4GB`。这里的尺寸是设备的完整尺寸。如果您已经有一些内容占用了`107.4GB`的一半，则您的克隆将失败或覆盖现有数据：

![Cloning With Guymager](../Images/image01013.jpeg)

当克隆过程完成后，您可以装载接收器分区，并且您克隆的分区将以您提供的名称可用。以下是用于此克隆的信息文件的一部分，显示了**SHA-256**哈希和验证。克隆和验证过程耗时约 19 分钟：

![Cloning With Guymager](../Images/image01014.jpeg)

# 潜入尸检

尸检是一个开源 web 应用程序，它是一个用于使用侦探工具包的 GUI 前端。它是建立在传统的灯堆上的。您可以将图像文件上载到尸检，然后对其进行检查和分析。它提供了与其他更高级的取证套件（如 X-ways、Encase 或 FTK）相同的基本功能，您可以管理许多不同的案例、导出数据、轻松查看元数据和执行字符串搜索。但是，您不能执行其他更高级的功能，例如文件雕刻。

要使用尸检，请转到应用程序菜单的取证部分，然后单击尸检。尸检是一个基于网络的应用程序，因此终端窗口将打开并启动尸检服务。你得让这扇窗户开着。关闭此窗口将终止正在运行的服务：

![Diving into Autopsy](../Images/image01015.jpeg)

如上图所示，要使用尸检，请打开网络浏览器，进入`http://localhost:9999/autopsy`。主页将打开，允许您设置新案例或打开现有案例。由于这是第一次，我们将打开一个新的案例。尸检没有登录，所以最好只在受保护的网络上使用。在下面的屏幕截图中还要注意，该站点会向您发出警告，表示已启用 Java 脚本。我们在没有互联网接入的受保护网络上使用此功能，因此这不是问题（爱猎犬）：

![Diving into Autopsy](../Images/image01016.jpeg)

点击的**新建案例**按钮，创建一个新案例。这将带您进入下一页：

1.  输入案例名称。此名称不能有特殊字符或空格，只能有数字和字母。
2.  （可选步骤）如果愿意，请添加说明。如果你做了很多这样的事情，最好有一个清晰的描述。
3.  添加调查人员的姓名。这用于标记不同流程中的数据，这在报告中很方便，在收集法律证据时是绝对必要的。
4.  Click the **NEW CASE** button:

    ![Diving into Autopsy](../Images/image01017.jpeg)

接下来将要求您添加主机：

![Diving into Autopsy](../Images/image01018.jpeg)

1.  使用机器的 FQDN 填写主机名。
2.  （可选步骤）如果愿意，请添加说明。
3.  输入时区。如果留空，将使用系统的时间。
4.  （可选步骤）您还可以设置 Timeskew 以显示目标计算机与标准时间的差异（通常不需要标准时间）。
5.  （可选步骤）由于我们正在使用新映像设置新主机，因此不需要向哈希数据库添加路径。
6.  点击**下一步**按钮继续：

![Diving into Autopsy](../Images/image01019.jpeg)

这将带您到下一页，将磁盘映像添加到机箱中。点击**添加图像**按钮：

![Diving into Autopsy](../Images/image01020.jpeg)

然后，您将看到下一页。点击**添加图像文件**：

![Diving into Autopsy](../Images/image01021.jpeg)

我们将使用之前使用 Guymager 提取的 Windows7 图像。我们的图像位于安装的 USB 驱动器上，本演示中的路径为`/media/root/usbdisk/win70020160202B.*`。这是我们使用`.dd`格式提取的磁盘映像。当我们拉取这个图像时，一个信息文件也与`.dd`数据图像一起创建。如下图所示，将文件路径添加到图像时，图像名称以`.*`结尾。这将通配符图像并读取信息文件和数据文件。这在使用已分割为图像切片的装箱图像时也很有用。当与 Encase 一起使用时，或者 Guymager 以 Encase 格式输出时，您将有多个以`.Exx`（即`E01`、`E02`、`E03`结尾的数据文件。在文件名中使用通配符将查找所有这些图像切片，并以可用和可搜索的格式组合它们。info 文件将从克隆过程导入元数据以进行调查。

由于这是一个图像，请选择**图像**单选按钮。

如果您有一个独立的系统来执行此任务，并且空间很大，您可以选择**复制**或**移动**单选按钮。由于我们使用的是没有太多空间的 USB 磁盘版本，因此我们选择了**符号链接**单选按钮。这允许实际数据保留在装载的磁盘上，只需导入必要的元数据，并将实际数据的符号链接设置到尸检中。这样可以节省本地存储空间。点击**下一步**按钮启动流程：

![Diving into Autopsy](../Images/image01022.jpeg)

下一页显示运行分析图像之前要验证的文件。在下面，我们将看到图像文件和信息文件。单击“下一步”验证文件：

![Diving into Autopsy](../Images/image01023.jpeg)

这是一个 Vmware 映像，它不知道文件系统类型。这没关系；但是，在此模式下，您无法看到文件树。所有数据仍然可以通过扇区而不是通过文件树进行搜索和检索。因为这是使用 dd 工具制作的，所以这是一个磁盘映像，所以选择`Disk Image`单选按钮。因为这是 Windows，所以从下拉菜单中选择**dos**作为文件系统类型。然后点击**确定**按钮：

![Diving into Autopsy](../Images/image01024.jpeg)

接下来，您将看到磁盘映像详细信息页面。在这里，您可以为文件系统设置一个可验证的哈希。这是法律信息中需要的。哈希是一种经过验证的数据未被篡改的方法。如果您确实选择运行散列，请确保选中**在导入**后验证散列复选框，以检查工作是否正常。点击**添加**按钮：

![Diving into Autopsy](../Images/image01025.jpeg)

这将需要时间，具体取决于图像的大小。完成几十次后，您将能够估计安装程序运行分析所需的大致时间。喝杯咖啡，放松一下：

![Diving into Autopsy](../Images/image01026.jpeg)

运行此命令后，您将看到以下页面。这将显示导入的详细信息、导入的哈希值和证据锁映像名称。请注意，您可以通过点击**添加图像**按钮添加另一个图像。这将带您回到相同的步骤，将另一个图像导入到相同的案例中。如果您只有一个图像，请单击**确定**继续：

![Diving into Autopsy](../Images/image01027.jpeg)

添加所有的图像并单击**确定**后，您将进入`Gallery`页面：

![Diving into Autopsy](../Images/image01028.jpeg)

点击的**详细信息**链接，您将看到一个页面，显示导入图像的详细信息。您还将获得一个**提取字符串**按钮。在第一次设置映像时，您将希望运行此操作。这需要一段时间，但会加快您的搜索速度：

![Diving into Autopsy](../Images/image01029.jpeg)

如果您已点击**提取字符串**按钮，您将看到以下屏幕：

![Diving into Autopsy](../Images/image01030.jpeg)

运行此命令后，您将看到结果。点击**图片详细信息**会显示一个包含图片详细信息的页面。`Keyword Search`链接将带您进入搜索页面：

![Diving into Autopsy](../Images/image01031.jpeg)

点击关键字页面后，您可以使用正则表达式在扇区中搜索 ASCII 或十六进制格式的数据。以前的搜索和默认搜索列为页面底部附近的按钮：

![Diving into Autopsy](../Images/image01032.jpeg)

如果我们对`password =`进行搜索，我们会得到以下结果。我们已经单击了左侧列中的一个链接。“信息”窗格显示我们已调出 IIS 电子邮件服务的配置文件：

![Diving into Autopsy](../Images/image01033.jpeg)

在我们的下一个示例中，我们将使用来自 Windows7 机器的实际硬盘映像。在这个示例中，您可以看到我们基本上已经挂载了文件系统，并且有一个文件树可以使用。使用这种方法，我们有更多的搜索工具，包括恢复已删除文件的功能。

首先，我们建立了一个新的案例，就像我们在上一个例子中所做的那样，直到我们**添加了一个新的图像**。这一次，我们选择了**分区**，而不是**磁盘**，正如我们在前面的示例中所做的那样。

如下图所示，首先输入磁盘映像的路径。然后点击**分区**和**符号链接**单选按钮，点击**下一步**按钮：

![Diving into Autopsy](../Images/image01034.jpeg)

这一次我们将忽略计算图像的散列，以避免您查看散列过程，并在练习中节省时间。如果您正在处理真实物证，请不要跳过此步骤。请注意，这一次我们有一个部分，其中设置了装载点，并在下拉框中将文件系统类型设置为 NTFS。默认情况下，装入点集为 C；如果这是原始机器上的另一个驱动器，请将其更改为与原始驱动器设置相匹配：

![Diving into Autopsy](../Images/image01035.jpeg)

点击**添加**按钮后，我们得到以下页面。点击**确定**将开始分区测试：

![Diving into Autopsy](../Images/image01036.jpeg)

点击按钮**分析**按钮启动流程，设置符号链接表：

![Diving into Autopsy](../Images/image01037.jpeg)

你会得到一个指令页面，询问你想如何分析磁盘。选择**文件分析**：

![Diving into Autopsy](../Images/image01038.jpeg)

这将带您进入`File Browsing`页面。我们尚未搜索，因此内容区域为空。在左边，我们有三种浏览磁盘的方法。您可以通过命名要浏览的目录、在文本文件中输入目录名称并单击`VIEW`来查看第一部分。接下来，您可以在整个磁盘上搜索包含正则表达式搜索结果的文件。第三部分可以浏览已删除的文件，最后可以展开磁盘以查看磁盘上的所有目录。

首先，点击**所有已删除文件**按钮，查找已删除文件：

![Diving into Autopsy](../Images/image01039.jpeg)

点击按钮**所有已删除文件**按钮后，尸检运行已删除数据的搜索。通过单击链接，文件的原始数据将显示在文件树下方的窗口中。请记住，这是已删除的数据，因此这些文件中的某些信息可能已损坏：

![Diving into Autopsy](../Images/image01040.jpeg)

通过点击**展开目录**按钮，我们可以看到分区的文件树。如所示，在下面的示例中，可以看到和查看隐藏的系统目录。已删除的信息显示为红色：

![Diving into Autopsy](../Images/image01041.jpeg)

下面，我们将进入`C:\Users`目录并提取一个文件的信息。进入`Users`目录，我们找到一个名为 whalton 的帐户。进入该账户，我们可以找到本书的工作数据：

![Diving into Autopsy](../Images/image01042.jpeg)

当您点击**报告**链接时，尸检会在该文件上生成一份报告，其中包含隐藏的系统元数据。使用**导出**链接，可以导出此报告以供以后在报告中使用。

点击**文件类型**按钮，可以按文件类型查看。使用它，您可以对图像进行排序，并将已排序文件的副本拉到 Kali 机器上的目录中。您还可以将其设置为仅提取图像，并将其保存为缩略图。因为我们使用的是一个小型虚拟机，并且从一台真正的笔记本电脑上检查磁盘转储，所以我们将没有空间复制已排序的文件。在调查中，您可能希望这样做，这样您就可以搜索复制的文件，而不必真正接触证据中的磁盘映像。使用照片图像工具时也是如此。

点击**确定**按钮，尸检开始按文件类型对文件进行分析和排序。这需要一段时间。喝咖啡的时间到了：

![Diving into Autopsy](../Images/image01043.jpeg)

下图显示正在运行的文件类型分析：

![Diving into Autopsy](../Images/image01044.jpeg)

好的，在喝了一杯好咖啡，在树林里散步之后，我们现在已经整理好了数据。摘要列出了系统上文件的数量和类型的明细。我们还可以看到非文件的数量和重新分配的文件名。我们还提供了计算机上每种类型文件的编号列表：

![Diving into Autopsy](../Images/image01045.jpeg)

当点击**按类型**对文件进行排序链接时，我们得到一个错误，即尸检不支持查看已排序的文件，但您可以按所示路径查看文件。（似乎他们可以把这联系起来）。别担心。复制显示的路径，在浏览器中打开另一个选项卡，并将路径粘贴到新选项卡的地址栏中，然后点击*输入*：

![Diving into Autopsy](../Images/image01046.jpeg)

在新建页签中输入文件路径后，您将看到以下页面，其中包含按类型指向文件信息的链接：

![Diving into Autopsy](../Images/image01047.jpeg)

通过点击其中一个链接，我们可以看到文件信息。让我们单击文档并进行一点查看。加载文档页面后，我们可以使用浏览器的`Find`命令搜索文档名称。在这里，我们正在搜索名称中带有字符串`password`的文件：

![Diving into Autopsy](../Images/image01048.jpeg)

这已经解释了尸检的基本功能。欲了解更多信息和完整文档，请访问其网站[http://www.sleuthkit.org/informer/](http://www.sleuthkit.org/informer/) 。

# 装载图像文件

下面的资源列表为您提供了装载图像文件的更深入的介绍，以及您未来法医冒险的其他有用资源：

*   [http://www.linuxquestions.org/questions/linux-general-1/how-to-mount-img-file-882386/](http://www.linuxquestions.org/questions/linux-general-1/how-to-mount-img-file-882386/)
*   [http://unix.stackexchange.com/questions/82314/how-to-find-the-type-of-img-file-and-mount-it](http://unix.stackexchange.com/questions/82314/how-to-find-the-type-of-img-file-and-mount-it)
*   [https://major.io/2010/12/14/mounting-a-raw-partition-file-made-with-dd-or-dd_rescue-in-linux/](https://major.io/2010/12/14/mounting-a-raw-partition-file-made-with-dd-or-dd_rescue-in-linux/)
*   [http://www.sleuthkit.org/autopsy/v2/](http://www.sleuthkit.org/autopsy/v2/)

# 总结

在本章中，您学习了几种使用 Guymager 收集硬盘图像进行法医分析的方法，以及一些使用尸检工具进行分析的示例。正如所建议的，有几种本机 Linux 工具可用于帮助您从驱动器或分区收集和分析取证数据。

我们期待着听到你在法医学方面的经验。请通过出版商网站向我们发送电子邮件。