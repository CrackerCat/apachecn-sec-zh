# 十二、使用 Kali Linux 搭建实验室

准备是一切的关键。在进行渗透测试业务时，这一点变得更加重要，因为您可以在有限的时间内进行侦察、扫描、利用，并最终获得访问权限，并向客户提供详细的报告。您进行的每个渗透测试在性质上都不同，并且需要与您之前进行的测试不同的方法。工具在其中起着重要作用，您需要事先准备好工具包，并拥有执行测试所需的所有工具的实际操作经验。

在本章中，我们将介绍以下主题：

*   Kali Linux 概述及对上一版本的更改
*   安装 Kali Linux 的不同方法
*   虚拟化与物理硬件上的安装
*   Kali Linux 中重要工具的演练和配置
*   安装 Tor 和配置

# 卡利 Linux

Kali Linux 是基于 Debian 的以安全为中心的 Linux 发行版。这是著名的 Linux 发行版 Backtrack 的更名版本，它附带了大量用于网络、无线和 web 应用渗透测试的开源黑客工具库。尽管 Kali Linux 包含 Backtrack 提供的大部分工具，但 Kali Linux 的主要目标是使其具有可移植性，以便可以安装在基于 ARM 架构的设备上，如平板电脑和 Chromebook，这使得这些工具可以非常方便地供您使用。

使用开源黑客工具有一个主要缺点：当安装在 Linux 上时，它们包含大量依赖项，并且需要按照预定义的顺序安装。此外，一些工具的作者没有发布准确的文档，这使我们的生活变得困难。

Kali Linux 简化了这个过程；它包含许多与所有依赖项一起预安装的工具，并且处于随时可用状态，因此您可以更加关注实际攻击，而不是安装工具。Kali Linux 中安装的工具的更新会更频繁地发布，这有助于您保持工具的最新状态。一个预装了所有主要黑客工具以测试现实世界网络和应用的非商业工具包是每一个道德黑客的梦想，Kali Linux 的作者尽一切努力让我们的生活变得轻松，这使我们能够花更多的时间寻找实际缺陷，而不是构建工具包。

## Kali Linux 2.0 的改进

在 Black HatUSA 2015 上，Kali 2.0 发布了新的 4.0 内核。它以 Debian Jessie 为原型，代号为 Kali Sana。Kali 以前的主要版本是 1.0，定期更新到 1.1 版。Kali 2.0 中的一些改动是为了更好地访问和添加更新、更稳定的工具而进行的界面修饰性更改。

以下列出了 Kali 2.0 中的一些主要改进：

*   **持续滚动更新**：Kali Linux 的更新周期在 2.0 中有所改进，有一个称为滚动版本的特性。滚动发布发行版是一个不断更新的发行版，这样用户可以在发布时获得最新的更新和软件包。因此，用户不必等待主要版本来修复 bug。在 Kali 2.0 中，在 Debian 测试发行版发布包时，会定期从中提取包。这有助于保持 Kali 核心操作系统的更新。
*   **频繁的工具更新**：攻击性安全性，维护 Kali Linux 发行版的组织现在设计了一种不同的方法来检查更新的工具。他们现在使用一个新的上游版本检查系统，当发布新版本的工具时，该系统会定期发送更新。使用这种方法，利用人员一发布 Kali Linux 中的工具，就会立即对其进行更新。
*   **改进的桌面环境**：KaliLinux 现在支持完整的 GNOME3 会话。GNOME3 是使用最广泛的桌面环境之一，也是利用人员的最爱。运行完整 GNOM3 会话所需的最小 RAM 为 768 MB。尽管考虑到我们今天看到的计算机的硬件标准，这不是一个问题，但如果您的计算机较旧，您可以下载使用 Xfce 桌面环境的较轻版本的 Kali Linux，其中包含一组较小的有用工具。Kali Linux 还本机支持其他桌面环境，如 KDE、MATE、e17、i3wm 和 lxde。Kali 2.0 提供了新的壁纸、可定制的侧边栏、改进的菜单布局以及更多的视觉调整。
*   **对各种硬件平台的支持**：KaliLinux 现已在所有主要版本的 Google Chromebooks 和 Raspberry Pi 机器人套件上提供。Nethunter 是基于 Kali Linux 构建的移动设备黑客发行版，已使用 Kali 2.0 进行了更新。官方的 VMware 和 VirtualBox 映像也已更新。
*   **主要工具更改**：Metasploit 社区和 pro 软件包已从 Kali 2.0 中删除。如果您需要这些版本，则需要直接从 Rapid7 的网站下载。只有开源版本的 Metasploit 附带了 Kali 2.0。不再有任何 Metasploit 服务，您需要手动初始化、连接并启动 Metasploit 的数据库。

## 安装 Kali Linux

Kali Linux 的成功还得益于它为安装提供的灵活性。如果您想快速测试系统，您可以在几分钟内在亚马逊云平台上启动并运行 Kali Linux；如果您想使用 rainbow 表破解密码，您也可以将其安装在带有快速处理器的高速 SSD 驱动器上。以 Linux 为基础，操作系统的每个部分都可以定制，这使得 Kali Linux 在任何测试环境中都是一个有用的工具包。以下是安装 Kali Linux 的不同方法：

*   USB 模式
*   VMware 和 ARM 设备的自定义映像
*   Amazon EC2 上的 Kali Linux 最小映像
*   将其安装在物理硬盘上

### USB 模式

Kali Linux 现在可以安装在 USB 驱动器上，这样你就可以把黑客工具放在口袋里了。将其安装在 USB 驱动器中的优点是，您不需要物理硬盘上的空间，并且不需要双重启动您的机器。从 1.0.7 版开始，可以在 USB 驱动器上启用持久性选项，这将保存您在 Kali Linux 中重新启动时所做的所有更改。还可以启用一个单独的选项，使用 LUKS 加密对 USB 驱动器的数据分区进行加密。这起着重要的作用，因为随着渗透测试的进行，USB 驱动器将存储来自网络的敏感信息，如凭据、Nmap 输出和其他扫描仪。它需要得到保护，以免落入坏人之手。

### 注

**LUKS**代表**Linux 统一密钥设置**，是 Clemens Fruhwirth 于 2004 年专门为 Linux 创建的磁盘加密标准。

从[下载 Kali Linuxhttps://www.kali.org/downloads/](https://www.kali.org/downloads/) 。按照以下步骤在 USB 驱动器上安装 Kali Linux：

1.  After inserting the USB drive into your computer, you need to identify the device path using the `fdisk` or `lsblk` command. Make sure you have a USB drive of at least 8 GB free space. These steps can be done on any Linux machine:

    ![USB mode](../Images/image01057.jpeg)

2.  You need to then use a disk cloning tool such as the command line utility in Linux called `dd` to clone the Kali Linux ISO image file on the USB drive. The `if` parameter defines the input file, `of` is the output location that should be the USB location, and `bs` is the block size. This is all that is required to make a Kali Linux bootable USB drive:

    ![USB mode](../Images/image01058.jpeg)

3.  If you want the changes that you make while working on Kali Linux to be saved across reboots, then you need to perform a few extra steps:

    1.  使用**GParted**在未分配空间上安装了 Kali Linux 的 USB 驱动器的上创建一个额外的分区。从屏幕右上角选择正确的驱动器，它将显示驱动器上未使用的空间以及已安装 Kali Linux 的空间。
    2.  Now, you need to right-click on the **unallocated** section, and then select **new** from the drop-down menu. Create a partition named `Primary Partition` (shown in the following screenshot) with **File System** as **ext4** and then label the partition as `Persistence`:

        ![USB mode](../Images/image01059.jpeg)

    3.  创建分区后，打开一个新终端并键入以下命令：

        ```
        mkdir -p /mnt/kali_usb
        mount /dev/sdb3 /mnt/kali_usb
        echo "/ union" > /mnt/kali_usb/persistence.conf
        umount /dev/sdb3

        ```

    4.  要创建加密分区，请键入以下内容：

        ```
        cryptsetup --verbose --verify-passphrase luksFormat /dev/sdb3
        cryptsetup luksOpen /dev/sdb3 kali_usb
        mkfs.ext4 -L persistence /dev/mapper/kali_usb
        e2label /dev/mapper/kali_usb persistence
        mkdir -p /mnt/kali_usb
        mount /dev/mapper/kali_usb /mnt/kali_usb
        echo "/ union" > /mnt/kali_usb/persistence.conf
        umount /dev/mapper/kali_usb
        cryptsetup luksClose /dev/mapper/kali_usb

        ```

    此安装 USB 驱动器，然后在其中创建一个`persistence.conf`文件。`sdb3`表示分区；根据您的计算机上的分区数量，它可能会有所不同。

您现在可以使用 USB 驱动器重新启动机器，当启动菜单出现时，根据您之前采取的步骤选择**实时 USB 持久性**或**实时 USB 加密持久性**。

要测试您所做的更改是否在重新启动时保存，请创建一个临时文本文件并保存，并且在 Kali Linux 重新启动后，该文件应保持完整。

### 卡利 Linux 的 VMware 和 ARM 镜像

攻击性安全，Kali Linux 的创建者，提供了 Kali Linux 的 VMware 映像，可以在您的虚拟化软件中使用。您可以通过 torrent 在以下位置下载：

[http://www.offensive-security.com/kali-linux-vmware-arm-image-download/](http://www.offensive-security.com/kali-linux-vmware-arm-image-download/)

这些映像可以在 VMware workstation 和 VirtualBox 软件中工作。您需要创建一个新的虚拟机，连接下载的虚拟硬盘，然后启动该机器。通过使用这种方法，您不必坐着按照安装向导进行操作，就可以登录到已安装的 Kali Linux。

他们还发布了 Rasberry Pi 设备、Galaxy Note 设备等的图像。

下载用于 ARM 体系结构的 Kali Linux 时，有两个选项：ARMHF 和 ARMEL。**ARMHF**代表**ARM****硬****浮体**（HF）架构，**ARMEL**代表**Endian**（EL）架构。

### 亚马逊云上的 Kali Linux

如果你有一个亚马逊 EC2 账号，你可以立即启动一个卡利 Linux 实例；这些图像是免费的，您只需支付所使用的资源，如 RAM、处理器和硬盘空间。亚马逊市场中的 Kali Linux 镜像的直接链接位于[https://aws.amazon.com/marketplace/pp/B00HW50E0M](https://aws.amazon.com/marketplace/pp/B00HW50E0M) 。

如果您需要云中的 Pentesting 平台来进行一些测试或参与，这将非常有帮助。在亚马逊云平台上使用 Kali Linux 实例之前，需要记住以下几点：

*   The instance of Kali Linux on the Amazon marketplace is a minimal installation one. This means no tools are preinstalled on this image, so you will have to use metapackages to install the tools of your needs. This, in a way, is good step. Kali Linux comes with a huge number of tools that are not always required during penetration test and with a bare instance, you can install only those packages that are of your need. For example, if you are performing a penetration test of a web application, you can only install the kali-linux-web and kali-linux-top10 metapackages, which would include Nmap, Metasploit, and Wireshark, along with the web app hacking tools.

    如果要检查哪些元包可用，可以使用以下命令进行搜索：

    ```
    apt-get update && apt-cache search kali-linux

    ```

    要搜索特定元包中可用的工具，请键入以下命令：

    ```
    apt-cache show kali-linux-web |grep depends

    ```

    确定需要安装哪个元软件包后，需要运行以下命令：

    ```
    Apt-get install kali-linux-web

    ```

    ### 提示

    如果您无意中在 Kali Linux 中构建了一些工具，并希望从头开始，那么可以重新安装包含该工具的元包。

*   您不能使用根帐户登录到 Kali Linux 实例。您必须使用普通用户帐户，然后使用`sudo su`命令提升您的权限。
*   如果您正在对来自亚马逊云的 Kali Linux 实例的大型网络进行渗透测试，您必须填写一份表格告知亚马逊您的意图，这将有助于他们区分恶意网络流量和来自您的 Kali Linux 实例的流量。

### 在硬盘上安装 Kali Linux

拥有一台完全独立的笔记本电脑，在物理硬盘上安装有 KaliLinux，有足够的 RAM 和高速处理器来处理密码哈希和彩虹表，这是大多数经验丰富的渗透测试人员遵循的方式。在进行实际渗透测试时，您的机器上至少需要有 8GB 的 RAM。高速网络端口和允许数据包注入的无线网卡也是测试人员工具包的重要组成部分。

GUI 安装向导易于操作，您无需任何特殊培训即可将其安装到物理硬盘上。

Kali Linux 预装了许多黑客工具，它们只能以 root 权限运行。因此，默认用户为`root`，不创建非特权用户。如果要创建标准用户，可以使用**应用****常用应用****系统工具****首选项**下的设置控制台。根帐户的默认密码为`toor`。

## Kali Linux 虚拟化与物理硬件安装

虚拟化软件的流行使得在虚拟化平台上安装测试机成为一个很有吸引力的选择。它们以较低的成本提供了丰富的功能集，并消除了双重启动机器的麻烦。大多数虚拟化软件提供的另一个有用功能是克隆虚拟机，使用它可以创建同一台机器的多个副本。在真实的渗透测试中，您可能需要克隆和复制您的测试机器，以安装进一步的黑客工具，并在 Kali Linux 中进行配置更改，保留早期映像的副本，该副本将用作虚拟化环境中的基础映像。这可以非常轻松地完成。

一些虚拟化软件有一个**恢复到快照**功能，如果你把测试机搞砸了，想要重新开始工作，你可以及时返回。

根据需要修改分配给虚拟机的 RAM 数量、虚拟磁盘大小和虚拟处理器数量是虚拟化软件的另一个众所周知的功能。

除了使虚拟化平台成为如此吸引人的选择的功能之外，还有一个主要缺点。如果渗透测试涉及测试网络上使用的密码强度或其他处理器密集型任务，则需要高性能处理器和专用于该任务的 GPU。在虚拟平台上破解密码不是一件明智的事情，因为它会减慢进程，并且由于虚拟化开销，您将无法充分使用处理器。

虚拟化平台的另一个让很多人困惑的特性是网络选项。桥接、仅主机和 NAT 是虚拟化软件提供的三种主要网络选项。建议在执行渗透测试时使用桥接网络，因为虚拟机现在的行为就像其连接到物理交换机一样，并且数据包不受影响地移出主机。

在虚拟机中安装 Kali Linux 时，您必须安装为特定虚拟化软件提供的附加工具，该附加工具将启用一些附加功能，例如从主机向虚拟机复制和粘贴文本、改进图形性能和时钟同步。为了避免安装过程中出现任何故障，您应该首先使用以下命令安装`Linux kernel header`包：

```
apt-get update && apt-get install -y linux-headers-$(uname -r)

```

# Kali Linux 中的重要工具

一旦 Kali Linux 启动并运行，您就可以开始使用这些工具了。因为这本书是关于网络应用黑客的，所以我们大部分时间使用的所有主要工具都在**应用****网络应用**下。以下屏幕截图显示了**Web 应用**下的工具：

![Important tools in Kali Linux](../Images/image01060.jpeg)

在 Kali Linux 2.0 中，**Web 应用**下的工具进一步分为以下四类：

*   Web 应用代理
*   Web 漏洞扫描程序
*   网络爬虫与目录浏览
*   CMS 与框架识别

## Web 应用代理

HTTP 代理是 web 应用黑客工具包中最重要的工具之一，Kali Linux 包括其中一些工具。您在一个代理中错过的一个特性肯定会出现在另一个代理中，这突出了 Kali Linux 的真正优势，它拥有大量的工具库。

HTTP 代理是一种位于浏览器和网站之间的软件，用于拦截浏览器和网站之间的所有流量。web 应用黑客的主要目的是深入了解应用的内部工作，最好是充当中间人，拦截每个请求和响应。

### 打嗝代理

在 Kali Linux 中最广泛使用的代理之一是 Burp 代理，它是 BURPUSITE 工具的一部分。它位于**应用****Web 应用****Web 应用代理**下。Burpsuite 是一个功能丰富的工具，它包括一个 web 爬行器、入侵者和一个中继器，用于自动化针对 web 应用的定制攻击。在后面的章节中，我们将更深入地介绍 Burpusuite 的几个特性。

Burp 代理是不透明的代理，您需要采取的第一步是将代理绑定到特定的端口和 IP 地址，并配置 web 浏览器以使用该代理。默认情况下，它监听环回地址和端口号`8080`。

确保您选择的端口未被任何其他应用使用，以避免任何冲突。请注意端口和绑定地址，并将其添加到浏览器的代理设置中：

![Burp proxy](../Images/image01061.jpeg)

默认情况下，Burp 代理只截获来自客户端的请求。它不会截获来自服务器的响应。如果需要，从**选项**选项卡手动打开，然后在**截取服务器响应**部分下进一步向下打开。

#### 定制客户端拦截

如果您想缩小截获的 web 流量，还可以设置特定规则。如图所示，您可以匹配特定域、HTTP 方法、cookie 名称等的请求。一旦被拦截，您就可以编辑这些值并将其转发到 web 服务器并分析响应：

![Customizing client interception](../Images/image01062.jpeg)

#### 动态修改请求

在**匹配****和****替换**部分中，您可以配置规则来查找请求中的特定值，并动态编辑它，而无需任何手动干预。Burp proxy 包括以下几个规则，其中最显著的规则用于将用户代理值替换为 Internet Explorer、iPhone 或 Andriod 设备的值：

![Modifying requests on the fly](../Images/image01063.jpeg)

#### 基于 SSL 网站的 Burp 代理

Burp proxy 也适用于基于 SSL 的网站。为了解密，它拦截连接，将自己呈现为 web 服务器，并颁发由其自己的**证书颁发机构**（**CA**签署的证书。然后，代理将自己呈现给实际的 SSL 网站，作为用户，并使用 web 服务器提供的证书对请求进行加密。然后，来自 web 服务器的连接在代理处终止，该代理解密数据并使用将显示在用户 web 浏览器上的自签名 CA 证书对其重新加密。下图说明了此过程：

![Burp proxy with SSL-based websites](../Images/image01064.jpeg)

web 浏览器会显示警告，因为证书是自签名的，不受 web 浏览器信任。您可以安全地在 web 浏览器中添加异常，因为您知道 Burp 代理正在拦截请求，而不是恶意用户。您还可以通过从 Burp 导出证书并手动将其添加到 Firefox 中的受信任 CA 证书列表来脱机导入证书：

![Burp proxy with SSL-based websites](../Images/image01065.jpeg)

### WebScarab 和 Zed 攻击代理

前两个也是 Kali Linux 附带的 web 应用攻击代理。两者都是功能丰富的代理，但 Burp 代理仍然领先。您偶尔会发现一个代理缺少一个小功能，但在另一个代理中可用。例如，WebScarab 有一个很好的用于会话 ID 分析的值-时间散点图，这在 Burp 套件中是缺失的。WebScarab 和**Zed 攻击代理**（**ZAP**也是不透明代理，需要配置 web 浏览器向其转发请求。这两个工具均由**开放式 Web 应用安全项目**（**OWASP**维护，该项目是一个致力于 Web 应用安全的非盈利社区。2013 年，WebScarab 的利用速度放缓，新功能只添加到 ZAP 中，ZAP 也被称为 WebScarab 的继任者。

### ProxyStrike

KaliLinux 中还包括一个名为 ProxyStrike 的活动代理。该代理不仅拦截请求和响应，还主动发现漏洞。它有用于查找 SQL 注入和 XSS 缺陷的模块。与我们到目前为止讨论的其他代理类似，您需要将浏览器配置为使用 ProxyStrike 作为代理。它在后台执行应用的自动爬网，结果可以以 HTML 和 XML 格式导出。

## 网络漏洞扫描器

Kali Linux 还包括几个针对 web 应用的漏洞扫描程序。这些工具可用于查找 web 应用中的错误配置、过时文件和常见漏洞。

### 尼托

Nikto 就是 Nessus 对网络渗透测试的意义。它建立在一个称为 Wikto 的旧漏洞扫描程序上；该工具的作者无法跟上每天发布的新漏洞，并且该工具没有进一步更新。它随后被 CIRT.net 和 Chris Sullo 采用，更名为 Nikto，并定期发布更新。

它是一个功能丰富的漏洞扫描程序，可用于测试不同 web 服务器上的漏洞。它声称会检查一些流行 web 服务器上过时的软件版本和配置问题。

Nikto 的一些众所周知的特征如下：

*   以多种形式输出报告，如 HTML、CSV、XML 和文本
*   包括通过使用多种技术测试漏洞来减少误报
*   可以直接登录到 Metasploit
*   Apache 用户名枚举
*   暴力强制子域
*   可以在移动到下一个目标之前自定义每个目标的最大执行时间

### 飞鱼

此漏洞扫描程序首先使用递归爬网和预建字典为目标网站创建一个交互式站点地图。然后对生成的映射中的每个节点进行漏洞测试。扫描速度是它区别于其他 web 漏洞扫描程序的主要特征之一。它以其自适应扫描功能而闻名，利用该功能，它可以从上一步接收到的响应中进行更智能的决策学习。它在相对较短的时间内提供了 web 应用的全面覆盖。Skipfish 的输出是 HTML 格式的。

### 网络爬虫——Dirbuster

一些应用具有隐藏的 web 目录，而与 web 应用交互的普通用户看不到这些目录。Web 爬虫试图在 Web 应用中查找隐藏目录，Dirbuster 在这方面非常擅长。Dirbuster 基本上是由 Java 利用的一个应用，它试图在 web 应用上强制执行目录和文件名。Dirbuster 使用一个列表，该列表是通过浏览互联网和收集利用人员在实际 web 应用中使用的目录和文件生成的。由 OWASP 利用的 Dirbuster 目前是一个非活动项目，现在通过 ZAP 代理插件而不是独立工具提供。

### OpenVAS

open 漏洞评估扫描器是 Kali Linux 中的网络漏洞扫描器。渗透测试应始终包括对目标系统的漏洞评估，OpenVAS 在识别网络端的漏洞方面做得很好。OpenVAS 是 Nessus 的一个分支，但它的提要是完全免费的，并根据 GPL 授权。

OpenVAS 安装在 Kali Linux 中，但在开始使用之前需要进行初始配置。进入**应用****漏洞分析**并选择 OpenVAS 初始设置。Kali Linux 需要连接到 Internet 才能完成此步骤，因为该工具会下载所有最新的提要和其他文件。设置结束时，将生成一个密码，该密码将在登录 GUI 界面时使用：

![OpenVAS](../Images/image01066.jpeg)

您现在可以通过将浏览器指向`https://127.0.0.1:9392`打开图形界面。接受自签名证书错误，然后使用用户名 admin 和初始配置时生成的密码登录。

OpenVAS 现在可以对任何目标运行漏洞扫描。登录后，您可以通过导航到**管理****用户**并针对用户名选择编辑用户选项（用扳手标记）来更改密码。

GUI 界面分为多个菜单，如下所述：

*   **扫描管理**：从这里可以开始新的网络 VA 扫描。您还可以在此菜单下找到所有报告和调查结果。
*   **资产管理**：在这里，您可以从扫描中找到所有累积的主机。
*   **SecInfo 管理**：所有漏洞及其 CVE ID 的完整详细信息存储在此处。
*   **配置**：在这里，您可以配置警报、调度、报告格式等多种选项。还可以通过此菜单自定义主机和开放端口发现的扫描选项。
*   **管理**：通过**管理**菜单进行用户的添加、删除和提要同步。
*   **附加**：可通过此菜单进行与 OpenVAS GUI 相关的设置，如设置时间和语言。

让我们看一下 OpenVAS 的扫描结果。我们扫描了三台主机，发现其中两台主机存在一些高风险漏洞。您可以进一步点击个人扫描并查看有关已识别漏洞的详细信息：

![OpenVAS](../Images/image01067.jpeg)

### 数据库利用

如果不测试后端数据库的安全性，则任何 web 渗透测试都不会完成。SQL Server 始终是攻击者的目标列表，在渗透测试期间需要特别注意它们，以弥补可能从数据库泄漏信息的漏洞。SQLNinja 是一个用 Perl 编写的工具，可用于攻击易受攻击的 Microsoft SQL server 并获得 shell 访问权限。类似地，sqlmap 工具用于利用易受 SQL 注入攻击和指纹攻击的 SQL server，检索用户和数据库，枚举用户，以及执行更多操作。更多关于 SQL 注入攻击的信息将在[第 5 章](15.html#aid-352RK2 "Chapter 5. Attacking the Server Using Injection-based Flaws")中的一书中讨论*使用基于注入的缺陷*攻击服务器。

## CMS 识别工具

内容管理系统，特别是 WordPress，在互联网上非常流行，在这个平台上部署了数百个网站。插件和主题是 WordPress 网站不可分割的一部分，但这些插件中存在大量安全问题。WordPress 网站通常由最不关心安全性的普通用户管理，他们很少更新 WordPress 软件、插件和主题，从而使其成为一个有吸引力的目标。

WPScan 是一款非常快速的 WordPress 漏洞扫描器，用 Ruby 编程语言编写，并预装在 Kali Linux 中。

可以使用 wpscan 提取以下信息：

*   插件列表
*   主题名称
*   使用 Bruce 强制技术的弱密码和用户名
*   版本详情
*   可能的漏洞

Kali Linux 中提供的一些其他 CMS 工具如下所示：

*   Plecost 是一个 WordPress 手指打印机工具，可用于检索已安装插件的信息，并针对每个易受攻击的插件显示 CVE 代码。
*   Joomscan 能够检测 Joomla CMS 中的已知漏洞，如文件包含、命令执行和注入缺陷。它探测应用并提取目标正在运行的确切版本。

## Web 应用模糊器

fuzzer 是一种设计用于将随机数据注入 web 应用的工具。web 应用模糊器可用于测试缓冲区溢出情况、错误处理问题、边界检查和参数格式检查。模糊测试的结果是揭示 web 应用漏洞扫描程序无法识别的漏洞。模糊程序采用试错法，需要耐心来识别缺陷。

Burpsuite 和 WebScarab 具有内置的起毛器。Wfuzz 是 Kali Linux 中可用的一键式模糊器，我们将在[第 10 章](20.html#aid-3P3NE1 "Chapter 10. Fuzzing Web Applications")、*模糊化 Web 应用*中使用它们来测试应用。

# 使用 Tor 进行渗透测试

渗透测试的主要目的是以现实世界中恶意黑客会采用的方式侵入 web 应用。Tor 提供了一个有趣的选项来模拟黑帽黑客用来保护其身份和位置的步骤。尽管试图提高 web 应用安全性的道德黑客不应担心隐藏其位置，但通过使用 Tor，它为您提供了测试边缘安全系统（如网络防火墙、web 应用防火墙和 IPS 设备）的附加选项。

黑帽黑客尝试各种方法来保护他们的位置和真实身份；他们不使用永久的 IP 地址，并不断地改变它以欺骗网络犯罪调查人员。您会发现来自不同 IP 地址范围的端口扫描请求以及实际的攻击具有边缘安全系统第一次记录的源 IP 地址。在获得客户端必要的书面批准后，您可以使用 Tor 通过系统通常看不到连接的未知 IP 地址连接到 web 应用来模拟攻击者。使用 Tor 使追踪入侵企图到实际攻击者变得更加困难。

Tor 使用互连网络中继的虚拟电路来反弹加密的数据包，加密是多层的，将数据释放到公共互联网的最终网络中继无法识别通信的来源，因为整个数据包都是加密的，每个节点仅对其中的一部分进行解密。目标计算机将数据包的最终出口点视为通信源，从而保护用户的真实身份和位置。下图说明了此过程：

![Using Tor for penetration testing](../Images/image01068.jpeg)

## 设置 Tor 和匿名连接的步骤

以下是安装 Privoxy 和 Tor 的步骤：

1.  Web browsers are notorious for leaking personal information about the user and we would use Privoxy, which is a web proxy to protect against such leaks. It's a highly customizable proxy that can be used to defend against web browsers leaking private information. The primary focus of Privoxy is privacy enhancement. Since the proxy is sitting between your web browser and the Internet, it is the best place to filter out outbound personal information that the web browser is leaking. Similarly, install Tor. Tor and Privoxy are both proxies. The web browser forwards the request to Privoxy and in turn Privoxy forwards it to be Tor to be anonymized:

    ![Steps to set up Tor and connect anonymously](../Images/image01069.jpeg)

2.  Next, edit the Privoxy configuration file and add the parameters, as shown here. Here, we are configuring Privoxy to send all `socks4a` compliant web traffic to port `9050` where Tor is listening:

    ![Steps to set up Tor and connect anonymously](../Images/image01070.jpeg)

3.  现在编辑`/etc/tor/`目录下的`torrc`文件并在末尾添加（带`#`的行为注释）：

    ```
    SafeSocks 1
    WarnUnsafeSocks 1
    SocksListenAddress 127.0.0.1
    SocksPort 9050
    ControlPort auto

    ```

    ### 提示

    配置文件的所有输入都区分大小写，因此请小心。

4.  Verify services and listening ports:

    ![Steps to set up Tor and connect anonymously](../Images/image01071.jpeg)

5.  Configure web browser to use Privoxy as the proxy:

    ![Steps to set up Tor and connect anonymously](../Images/image01072.jpeg)

6.  Finally, visit the website `check.torproject.org` to verify if your requests are indeed flowing through the Tor network:

    ![Steps to set up Tor and connect anonymously](../Images/image01073.jpeg)

此处显示的 IP 地址肯定不是我的 ISP 分配的地址，而是欧洲的某个位置，用作 Tor 网络的出口节点。

## 通过 Tor 可视化 web 请求

这就是数据包在网络上的流动方式。web 浏览器将请求转发给 Privoxy，Privoxy 会对请求进行清理，并删除所有能够显示客户端真实身份的信息，并将请求转发给客户端上的 Tor 代理。然后，使用 Tor 网络中的大量中继对来自 Tor 代理的请求进行加密和路由，最终由出口节点释放，并发送到实际目的地：

![Visualization of a web request through Tor](../Images/image01074.jpeg)

## Tor 的最后一句话

以下是 Tor 的最后一句话：

*   Tor 的`torrc`配置文件高度可定制。您可以从所选国家/地区选择特定的退出节点。您还可以将 Tor 配置为拒绝可能显示用户真实 IP 地址的不安全的`SOCKS`方法。这些只是一些选择；花点时间在它上面，你就会真正了解它的力量。
*   Tor 还有一个称为 Vidalia 的图形用户界面，可以单独下载，用于启动和停止 Tor，并配置更多设置。
*   Tor is non-transparent proxy. The Internet-bound data from each application that you want to anonymize should be separately configured to use Tor. For example, if you want the wget to use Tor through the Privoxy proxy, you will have to add in the `http_proxy` environment variable as follows:

    ![Final words for Tor](../Images/image01075.jpeg)

*   Tor 网络还可用于托管隐藏的网站，只有当客户端连接到 Tor 网络时，才能访问该网站，该网站对公共互联网是隐藏的。最近，这些网站因进行非法交易而受到执法机构的关注。来自这些执法机构的专家能够深入 Tor 网络，我们能够利用未知的漏洞揭露这些网站的来源。这让许多人感到惊讶，因为 Tor 网络被认为是不可破坏的。

### 提示

如果您想将 Burp proxy 与 Tor 一起使用来测试网站 GUI 下发生的事情，则必须将 web 浏览器配置为使用 Burp 作为代理，然后将 Burp proxy 配置为使用 Tor 作为代理。

# 总结

这一章是关于 Kali Linux 的。我们首先了解了 Kali Linux 的不同安装方式以及使用它的场景。虚拟化 Kali Linux 是一个很有吸引力的选择，我们讨论了它的利弊。一旦我们启动并运行了 Kali Linux，我们就概述了将用于测试 web 应用的主要黑客工具。Burp suite 是一个非常有趣且功能丰富的工具，我们将在本书中使用它。然后，我们讨论了 web 漏洞扫描器，这些扫描器在识别知名 web 服务器中的缺陷和配置问题时非常有用。最后，我们设置 Tor 和 Privoxy 来模拟真实世界中隐藏其真实身份和位置的攻击者。

在下一章中，我们将执行侦察、扫描 web 应用，并确定用作进一步利用的基础的底层技术。