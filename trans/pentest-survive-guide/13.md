# 第三章网络服务器的侦察与评测

多年来，恶意攻击者找到了各种方法来渗透系统。他们收集有关目标的信息，识别漏洞，然后发动攻击。一旦进入目标，他们会试图隐藏自己的踪迹，并保持更长时间的隐藏。攻击者可能不一定遵循相同的顺序，但作为渗透测试人员，遵循建议的方法将帮助您以结构化的方式进行评估，并且在每个阶段收集的数据有助于准备对您的客户有价值的报告。攻击者的目标是最终拥有系统，因此他们可能不会遵循任何顺序方法。作为一名渗透测试人员，您的目标是尽可能多地识别 bug，遵循一种方法非常有用。然而，你也需要有创造力，跳出框框思考。

以下是渗透测试的不同阶段：

*   **侦察**：这涉及调查公开信息
*   **扫描**：这包括在目标中找到开口
*   **利用**：这涉及到破坏目标并获取访问权限
*   **维护访问**：这包括安装后门以维护其他访问方法
*   **覆盖铁轨**：这包括移除铁轨存在的证据

侦察和扫描是渗透测试的初始阶段。渗透测试的成功取决于在这些阶段收集的信息的质量。在本章中，我们将作为渗透测试人员，使用被动和主动侦察技术提取信息。然后，我们将使用 Kali Linux 提供的不同工具探测目标，以提取更多信息，并使用自动化工具找出漏洞。

# 侦察

侦察是国防军用来获取敌人信息的一个术语和一种技术，其方式不会使对方警觉。恶意用户使用相同的方法获取与目标相关的信息。情报搜集是侦察的主要目的。在此初始阶段收集的任何信息都将被视为重要信息。使用恶意内容的攻击者以侦察阶段获得的信息为基础，并逐渐进行攻击。一点看似无害的信息可能会帮助您在测试的后期阶段突出显示严重缺陷。一个好的渗透测试人员知道如何识别在某些情况下可能造成巨大损害的低风险漏洞。攻击者会盯着一个漏洞进行攻击，您的任务是通过识别攻击者可以利用的最小漏洞来获得访问权限，从而使系统免受黑客攻击。

web 应用程序渗透测试中的侦察目标包括以下任务：

*   使用 Whois 记录、搜索引擎和 DNS 服务器识别 IP 地址、子域和相关信息。
*   从谷歌、必应、雅虎等公开资源收集目标网站的相关信息！，还有肖丹。Archive.org 是一个为互联网上所有网页提供数字存档的网站，它可以在侦察阶段透露一些真正有用的信息。该网站自 1996 年以来一直在存档缓存页面。如果目标网站是最近创建的，则 Archive.org 需要一些时间来缓存它。
*   借助 Facebook、Flick、Instagram 或 Twitter 等社交网站以及 Maltego 等工具识别与目标相关的人。
*   使用地理 IP 数据库、谷歌地图和必应地图的卫星图像确定目标的物理位置。
*   使用 Burp Suite、HTTP Track 和 ZAP Proxy 等工具对 web 应用程序进行爬网并创建站点地图，以了解应用程序的流程。

## 被动侦察与主动侦察

真正意义上的侦察应该始终是被动的。但在实际实现中，在对 web 应用程序进行侦察时，您通常会与目标交互以获取最新的更改。被动侦察依赖于缓存的信息，可能不包括最近对目标所做的更改。虽然您可以通过使用与目标相关的公开可用信息了解到很多信息，但与网站进行交互时，如果不向防火墙和入侵预防设备发出警报，则应始终包括在测试范围内。

一些渗透测试人员会认为，被动侦察可能包括浏览目标 URL 和浏览公开内容，但其他人会表示，不应涉及任何针对实际网站的网络数据包。有时，被动和主动侦察有时都被称为被动方法，因为渗透测试人员只是寻找信息，而不是像恶意攻击者那样主动攻击目标。如果您使用 Tor 匿名器进行侦察，则可以隐藏流量来源并保持被动。当您主动抓取网站并针对目标运行模糊程序时，它可能会提醒 IPS 和防火墙设备，因为这些活动会产生大量流量。

## 侦察-信息收集

正如前面提到的，侦察的主要目的是避免被发现。被动侦察用于从公开可用资源中提取与目标相关的信息。在 web 应用程序渗透测试中，您将获得一个 URL 作为开始。然后，我们将研究整个网站，并尝试连接不同的部分。被动侦察也称为**开源情报（OSINT）**收集。

在黑匣子渗透测试中，如果您没有关于目标的先前信息，并且必须依赖未知攻击者的接近，那么侦察将起主要作用。一个网站的 URL 是我们唯一需要扩展关于目标的知识的东西。

### 域名注册详情

每注册一个域名时，您必须提供有关您的公司或业务的详细信息，例如名称、电话号码、邮政地址以及用于技术和计费目的的特定电子邮件地址。域注册器还将存储您的权威 DNS 服务器的 IP 地址。

检索此信息的攻击者可以恶意使用此信息。注册期间提供的联系人姓名和号码可用于社会工程攻击，如通过电话欺骗用户。邮政地址可以帮助攻击者发动战争并找到不安全的无线接入点。《纽约时报》在 2013 年受到攻击，当时其 DNS 记录被恶意攻击者利用针对管理该域的注册商的域分销商的网络钓鱼攻击而更改。更改 DNS 记录会严重影响网站的功能，因为攻击者可以使用它将 web 流量重定向到不同的服务器，而纠正的更改可能需要 72 小时才能到达遍布全球的所有公共 DNS 服务器。

#### Whois–提取领域信息

Whois 记录用于检索域所有者向域注册商提供的注册详细信息。它是一个协议，用于提取有关域的信息和相关联系信息。您可以查看注册域的个人/实体的名称、地址、电话号码和电子邮件地址。Whois 服务器由**区域互联网注册商**（**RIR**操作，可通过`43`端口直接查询。在早期，互联网上只有一台 Whois 服务器，但随着互联网的扩展，Whois 服务器的数量已经增加。如果查询的服务器中不存在所请求域的信息，则请求将转发到域注册器的 Whois 服务器，并将结果返回给最终客户端。Whois 工具内置于 Kali Linux 中，可以从终端运行。该工具检索到的信息仅与域名所有者更新的信息一样准确，如果注册网站上更新的详细信息不正确，则有时可能会产生误导。您可以通过订阅域注册器提供的其他服务来阻止与域相关的敏感信息，注册器将显示这些信息的详细信息，而不是域的联系人详细信息。

`whois`命令后跟目标域名应该会显示一些有价值的信息。输出将包含注册器名称和返回信息的 Whois 服务器。它还将显示域注册的时间和到期日期，如以下屏幕截图所示：

![Whois – extracting domain information](../Images/image01076.jpeg)

如果域管理员未能在到期日前续订域，域注册商将释放该域，然后任何人都可以购买该域。

输出还指出了域的 DNS 服务器，可以进一步查询该服务器以查找域中的其他主机：

![Whois – extracting domain information](../Images/image01077.jpeg)

### 使用 DNS 识别主机

一旦您拥有权威 DNS 服务器的名称，您就可以使用它来识别域中的其他主机。DNS 区域不一定只包含 web 服务器的条目。在互联网上，每一种需要主机名来识别服务的技术都使用 DNS。邮件服务器和 FTP 服务器使用 DNS 将主机解析为 IP 地址。通过查询 DNS 服务器，我们可以识别目标组织中的其他主机，它还将有助于识别可从 Internet 访问的其他应用程序。`citrix.example.com`或`webmail.exchange.com`的记录可以引导您找到可从互联网访问的其他应用程序。

#### 使用挖掘进行区域转移

在 Linux 中使用**域 Internet Groper**（**dig**）命令行工具，您可以尝试执行区域传输以识别域中的其他主机。配置不当的 DNS 服务器可能允许将区域传输到任何服务器，这使得渗透测试人员的任务更加容易，因为您不必使用耗时的暴力技术来识别域中的主机。区域传输通过 TCP 端口`53`而不是 UDP 端口`53`完成。

dig 命令行工具主要用于查询 DNS 服务器的主机名。一个简单的命令，如`dig google.com`显示域的 IP 地址和承载其 DNS 区域的 DNS 服务器的名称（也称为名称服务器）。DNS 记录有多种类型，如**邮件交换器**（**MX**）、SRV 记录和 PTR 记录。`dig google.com mx`命令显示邮件交换器记录的信息。

除了通常的 DNS 任务外，`dig`命令还可用于执行 DNS 区域传输。通常，区域传输只能在两个受信任的 DNS 服务器（如主服务器和辅助服务器）之间进行，但配置错误的服务器会允许区域传输与任何其他服务器一起工作。

如以下屏幕截图所示，如果启用了区域传输，挖掘工具将在终端转储区域中的所有条目：

![Zone transfer using dig](../Images/image01078.jpeg)

让我们从 IP 地址`192.168.1.50`的 DNS 服务器请求区域传输，该 DNS 服务器承载域`pentesting_lab.com`的 DNS 区域：

```
Dig @192.168.1.50 pentesting_lab.com –t AXFR

```

您经常会发现，即使主 DNS 服务器阻止区域传输，该域的辅助服务器也可能允许区域传输工作。`dig google.com NS +noall +answer`命令将显示该域的所有名称服务器。

尝试从`facebook.com`的 DNS 服务器传输区域失败，因为他们已正确锁定其 DNS 服务器：

![Zone transfer using dig](../Images/image01079.jpeg)

执行 DNS 查找以搜索 IP 地址是被动侦察，但当您使用 dig 或 nslookup 等工具进行区域传输时，它将变为主动侦察。

#### 使用 Nmap 强制 DNS 记录

Nmap 附带一个脚本，用于使用暴力强制技术查询 DNS 服务器中的其他主机。它使用字典文件`vhosts-defaults.lst`和`vhosts-full.lst`，其中包含 Nmap 开发团队多年来收集的大量常见主机名列表。文件可位于`/usr/share/nmap/nselib/data/`。Nmap 向 DNS 服务器发送该文件中每个条目的查询，以检查 DNS 区域中是否有该主机名可用的 a 记录。

如下面的屏幕截图所示，暴力脚本返回了一个肯定的结果。它通过查询 DNS 区域中的一些主机的 a 记录来标识这些主机：

![Brute force DNS records using Nmap](../Images/image01080.jpeg)

### 侦察工具——信息收集框架

开源情报收集是一个耗时的手动过程。与目标组织相关的信息可能分布在多个公共资源中，积累和提取与目标相关的信息是一项困难而耗时的任务。大多数组织的 IT 预算不允许在此类活动上花费太多时间。

Recon ng 是渗透测试人员始终需要的工具。这是一个信息收集工具，正在研究类固醇。一个非常交互式的工具，类似于 Metasploit 框架。该框架使用许多不同的来源来收集数据，例如 Google、Twitter 和 Shodan。有些模块在查询网站之前需要 API 密钥；可以通过在搜索引擎的网站上注册来生成密钥。其中一些模块使用付费 API 密钥。

要在 Kali Linux 中启动侦察，请导航至**应用程序**菜单，然后单击**信息收集**子菜单。您将看到右侧窗格中列出了**侦察**。与 Metasploit 类似，当框架启动并运行时，您可以输入`show modules`来检查随框架附带的不同模块。有些模块是被动的，而有些模块则主动探测目标以提取所需信息。

尽管侦察 ng 有几个利用模块，但该工具的主要任务是协助侦察活动，并且有大量模块可供使用：

![The Recon-ng tool – a framework for information gathering](../Images/image01081.jpeg)

当使用自动工具查询搜索引擎时，搜索引擎可能需要 API 密钥来识别发送这些请求的人并应用配额。该工具的工作速度比人工快，通过分配 API，可以跟踪使用情况并防止滥用服务。因此，确保你不会压倒搜索引擎，否则你将被排斥在外。

您可以通过以下链接为 Bing 生成 API 密钥：

[https://datamarket.azure.com/dataset/bing/search](https://datamarket.azure.com/dataset/bing/search)

免费订阅每月为您提供 5000 个查询。生成密钥后，需要使用以下命令将其添加到 Recon ng 工具中的密钥表中：

```
keys add bing_api <api key generated>

```

要显示存储在 Recon ng 中的所有 API 密钥，请键入以下命令：

```
keys list

```

以下屏幕截图显示了前面命令的输出：

![The Recon-ng tool – a framework for information gathering](../Images/image01082.jpeg)

#### 使用 recon ng 进行域枚举

收集有关目标网站子域的信息将帮助您识别网站的不同内容和功能。目标组织提供的每种产品或服务都可能有一个子领域专门用于此。这有助于以连贯的方式组织不同的内容。通过识别不同的子域，您可以创建一个站点地图和一个将各个部分连接起来的流程图，并了解网站的流程。

##### 子级和顶级域枚举

使用 Bing API 主机名枚举器模块，我们将尝试在`facebook.com`网站下寻找其他子域：

1.  您需要首先通过`load recon/domains-hosts/bing_domain_api`命令加载模块。接下来，输入`show info`命令，该命令将显示描述模块的信息。
2.  The next step would be to set the target domain in the `SOURCE` option; we will set it to `facebook.com`:

    ![Sub-level and top-level domain enumeration](../Images/image01083.jpeg)

3.  When you are ready, use the `run` command to kick-off the module. The tool first queries for a few domains, then uses the (`-`) directive to remove the already queried domains, and then searches for additional domains again. The biggest advantage is speed. In addition to speed, the output is also stored in a database in plain text can be used as an input to others tools such as Nmap, Metasploit, and Nessus, as shown in the following screenshot:

    ![Sub-level and top-level domain enumeration](../Images/image01084.jpeg)

DNS 公共后缀暴力破解模块可用于识别**顶级域名**（**TLD**）和**二级域名**（**SLD**）。许多基于产品和基于服务的企业在每个地理区域都有单独的网站；您可以使用此暴力强制模块来识别它们。它使用`/usr/share/recon-ng/data/suffixes.txt`中的单词列表文件来枚举其他域。

#### 报告模块

您运行的每个侦察模块将把输出存储到单独的表中。您可以以多种格式导出这些表，例如 CSV、HTML 和 XML 文件。要查看 Recon ng 工具使用的不同表格，您需要输入`show`并按*选项卡*两次：

![Reporting modules](../Images/image01085.jpeg)

要将表格导出到 CSV 文件中，请通过键入`load /reporting/csv`加载 CSV 报告模块。加载模块后，设置文件名和要导出的表，并键入`run`：

![Reporting modules](../Images/image01086.jpeg)

以下是侦察中的一些额外侦察模块，它们对渗透测试人员有很大帮助：

*   **Netcraft 主机名枚举器**：Recon ng 将获取 Netcraft 网站并累积与目标相关的所有主机，并将其存储在主机表中。
*   **SSL SAN 查找**：许多支持 SSL 的网站都有一个证书，通过使用**主题替代名称**（**SAN**功能，可以跨多个域工作。此模块使用[ssltools.com](http://ssltools.com)网站检索证书的 SAN 属性中列出的域。
*   **LinkedIn 认证联系人枚举器**：此将从 LinkedIn 配置文件中检索联系人并将其存储在`contacts`表中。
*   **IPInfoDB GeoIP**：此将使用`IPinfoDB`数据库显示主机的地理位置（需要 API）。
*   **雅虎！主机名枚举器**：此使用 Yahoo！搜索引擎在域中定位主机。使用多个搜索引擎的模块可以帮助您定位可能未被其他搜索引擎索引的主机和子域。
*   **地理编码器和反向地理编码器**：这些模块使用谷歌地图 API 使用提供的坐标获取地址，如果给出了地址，还可以检索坐标。然后这些信息被存储在`locations`表中。
*   **Pushin 模块**：使用 Recon ng pushpin 模块，您可以从流行社交网站中提取数据，并将其与地理位置坐标关联，创建地图。下面列出了两个广泛使用的模块：
*   **推特地理位置搜索**：该在推特上搜索从给定坐标的特定半径上传的媒体（图像、推特）。
*   **Flickr 地理定位搜索**：此尝试定位从给定坐标周围区域上传的照片。

这些图钉模块可用于将人员映射到实际位置，并确定在特定时间处于给定坐标的人员。积累并转换成 HTML 文件的信息可以映射到卫星图像的精确坐标上。使用 Recon ng，您可以创建一个包含主机、IP 地址、物理位置和人员的大型数据库，只需使用公共可用资源即可。

侦察的目的应始终是从各种公共资源中提取信息，并从中识别敏感数据，攻击者可以利用这些数据直接或间接地以组织为目标。

# 扫描——探测目标

渗透测试需要在有限的时间内进行，侦察阶段是时间最短的阶段。在真实世界的渗透测试中，您与客户共享侦察阶段收集的信息，并尝试就扫描阶段应包括的目标得出结论。

在此阶段，客户机还可能向您提供侦察阶段未识别但应包含在实际测试和利用阶段的其他目标和域。这样做是为了通过包括黑帽和白帽黑客的方法从测试中获得最大的好处，在黑帽和白帽黑客的方法中，您可以像恶意攻击者一样开始测试，并且随着您的前进，会提供额外的信息，以准确地查看目标。

一旦确定了托管网站的目标服务器，下一步就是收集额外的信息，比如操作系统和该特定服务器上可用的服务。除了托管网站外，一些组织还启用 FTP 服务，并可根据需要打开其他端口。作为第一步，我们需要识别 web 服务器上除了端口`80`和`443`之外打开的其他端口。

扫描阶段包括以下几个阶段：

*   端口扫描
*   操作系统指纹识别
*   Web 服务器版本标识
*   基础设施分析
*   应用程序标识

## 使用 Nmap 进行端口扫描

网络映射器，俗称 Nmap，是最广为人知的端口扫描仪。它被渗透测试人员和道德黑客用来成功地找到开放端口，是他们工具包中的一个重要软件。Kali Linux 预装了 Nmap。Nmap 由一组活跃的开发人员定期更新和维护，这些开发人员为开源工具做出了贡献。

默认情况下，Nmap 不会向所有端口发送探测。Nmap 只检查`nmap-services`文件中指定的前 1000 个常用端口。每个端口条目都有一个对应的编号，指示该端口打开的可能性。这大大提高了扫描速度，因为不太重要的端口被排除在扫描之外。根据目标的响应，Nmap 确定端口是打开的、关闭的还是已过滤的。

### 端口扫描的不同选项

运行 Nmap 端口扫描的简单方法称为 TCP 连接扫描。此选项用于扫描打开的 TCP 端口，并使用**–**`sT`选项调用。连接扫描执行三向 TCP 握手（Syn---Syn/Ack---Ack）。它提供更准确的端口状态，但更有可能在目标计算机上记录。进行扫描的一种更隐蔽的方式是使用被称为 SYN 扫描的**–**`sS`选项，该选项不会完成与目标的握手，因此不会登录到该目标机器上。但是，SYN 扫描生成的数据包可以向防火墙和 IPS 设备发出警报。

当使用`–F`标志调用时，Nmap 将扫描前 100 个端口，而不是前 1000 个。此外，它还提供了使用`--top-ports [N]`标志自定义扫描的选项，以从 nmap 服务文件中扫描`N`最流行的端口。许多组织可能有一些应用程序正在侦听不属于 nmap 服务文件的端口。对于这种情况，您可以使用`–p`标志定义 Nmap 要扫描的端口、端口列表或端口范围。

有 65535 个 TCP 和 UDP 端口，应用程序可以使用其中任何一个端口。如果需要，可以使用`–p 1-65535`选项测试所有端口。

以下屏幕截图显示了上述命令的输出：

![Different options for port scan](../Images/image01087.jpeg)

### 提示

如果您想在执行端口扫描时查看 Nmap 发送的确切数据包，可以添加`the –packet-trace`选项。

### 使用 Nmap 规避防火墙和 IP

除了对 TCP 进行不同的扫描外，Nmap 还提供了各种选项，在扫描组织网络外部的目标时，这些选项有助于绕过防火墙，如下所示：

*   **确认扫描**：此选项用于规避某些路由器上仅允许来自内部网络的 SYN 数据包的规则，从而阻止默认连接扫描。这些路由器将只允许内部客户端通过路由器进行连接，并将使用 SYN 位集阻止来自外部网络的所有数据包。当使用`–sA`标志调用`ACK scan`选项时，Nmap 仅生成设置了 ACK 位的数据包，使路由器误认为该数据包是对内部客户端连接的响应，并允许该数据包通过该数据包。`ACK scan`选项无法可靠地判断终端系统的端口是打开还是关闭，因为不同的系统以不同的方式响应未经请求的 ACK。但它可以用来识别路由器后面的在线系统。
*   **Hardcoded source port in firewall rules**: Many firewall administrators configure firewalls with rules allowing incoming traffic from the external network that originate from a specific source port such as `53`, `25`, and `80`. Nmap by default randomly selects a source port, but it can be configured to shoot traffic from a specific source port in order to circumvent this rule:

    ![Evading firewalls and IPS using Nmap](../Images/image01088.jpeg)

*   **Custom packet size**: Nmap and other port scanners send packets in a specific size and firewalls now have rules defined to drop such packets. In order to circumvent this detection, Nmap can be configured to send packets with a different size using the `--data-length` option:

    ![Evading firewalls and IPS using Nmap](../Images/image01089.jpeg)

*   **Custom MTU**: Nmap can also be configured to send packets with smaller MTU. The scan will be done with a `--mtu` option along with a value of the MTU. This can be used to circumvent some older firewalls and intrusion detection devices. New firewalls reassemble the traffic before sending it across to the target machine so it would be difficult to evade them. The MTU needs to be a multiple of 8\. The default MTU for Ethernet LAN is of 1500 bytes:

    ![Evading firewalls and IPS using Nmap](../Images/image01090.jpeg)

*   **MAC address spoofing**: If there are rules configured in the target environment to only allow network packets from certain MAC addresses, you can configure Nmap to set a specific MAC address to conduct the port scan. The port scanning packets can also be configured with a MAC address of a specific vendor as shown in the following screenshot:

    ![Evading firewalls and IPS using Nmap](../Images/image01091.jpeg)

### 在 Nmap 中使用反向校验和选项发现防火墙

当您使用正确计算的校验和向封闭端口发送合法数据包，并获得连接重置数据包时，您无法确定该数据包是来自目标主机前面的防火墙还是来自终端主机。配置了错误校验和的数据包可用于确定目标和计算机之间是否确实存在防火墙，如下所示（错误校验和）数据包被机器的端点悄悄地丢弃，任何重置或端口无法访问的数据包肯定来自位于目标前面的设备，如防火墙或入侵防护设备。以下屏幕截图显示了这种情况：

![Spotting a firewall using back checksum option in Nmap](../Images/image01092.jpeg)

在前面的示例中，端口**4567**被标记为**已过滤**（虽然在目标上关闭），因为 Nmap 不确定其状态，因为数据包被目标悄悄丢弃（由于校验和错误）。如果中间有防火墙，并且端口**4567**不允许通过防火墙，则防火墙会发回重置数据包，因为它不会验证校验和。路由器和防火墙不会验证校验和，因为这会减慢处理速度。

## 使用 Nmap 识别操作系统

在确定 web 服务器上打开的端口之后，我们需要确定底层操作系统。Nmap 提供了几个选项来执行此操作。在过去的几个版本中，通过几个人对项目的贡献，Nmap OS 指纹打印技术有了很大的改进，并准确地确定了目标的操作系统。使用`-O`选项执行操作系统扫描；您可以为详细输出添加`-v`，以了解为确定操作系统而进行的底层测试：

![Identifying the operating system using Nmap](../Images/image01093.jpeg)

熟练的黑客不依赖于单一工具的结果。因此，Kali Linux 附带了几个指纹识别工具；除了使用 Nmap 运行版本扫描外，您还可以使用诸如 Amap 之类的工具获得第二种意见。

## 分析服务器

一旦确定了底层操作系统，我们需要确定在该系统的开放端口上运行的确切应用程序。在扫描 web 服务器时，我们需要分析在操作系统上运行的 web 服务的风格和版本。Web 服务器基本上处理来自应用程序的 HTTP 请求并将其分发到 Web；Apache、IIS 和 Nginx 是使用最广泛的。除了版本之外，我们还需要确定 web 服务器上启用的任何其他软件、功能和配置，然后再继续开发阶段。

网站的开发在很大程度上依赖于 PHP 和.Net 等框架，每个 web 应用程序都需要不同的技术，具体取决于用于设计它的框架。

除了 web 服务器的版本扫描之外，我们还需要确定支持 web 应用程序的其他组件，例如数据库应用程序、加密算法和负载平衡器。

现在，多个网站部署在同一台物理服务器上。我们只需要攻击我们范围内的网站，并且需要正确理解虚拟主机。

### 应用程序版本指纹

在众所周知的端口（如端口`25`和`80`上运行的服务很容易识别，因为它们被广泛的应用程序（如邮件服务器和 web 服务器）使用。**互联网分配号码管理局**（**IANA**）负责维护端口号的正式分配，并且可以从每个操作系统中的端口映射文件中识别映射。但是，许多组织在更适合其基础架构的端口上运行应用程序。您经常会看到内部网网站在端口`8080`而不是`80`上运行。

端口映射文件只是一个占位符，应用程序可以在任何开放的端口上运行，正如开发人员无视 IANA 设置的映射所设计的那样。这就是为什么我们需要进行版本扫描，以确定 web 服务器是否确实在端口`80`上运行，并进一步分析该服务的版本。

#### Nmap 版本扫描

Nmap 有对进行版本扫描的选项；版本扫描可以与操作系统扫描结合使用，也可以单独运行。Nmap 通过发送大量数据包来探测目标，然后分析响应以确定确切的服务及其版本。

要仅启动版本扫描，请使用`–sV`选项。操作系统扫描和版本扫描可以使用`–A`选项组合在一起。如果没有随扫描选项一起定义端口，Nmap 将首先使用前 1000 个端口的默认列表在目标上执行端口扫描，并从中识别打开的端口。接下来，它将向打开的端口发送一个探测，并分析响应以确定在该特定端口上运行的应用程序。收到的响应与在`nmap-service-probes`文件中找到的巨大签名数据库相匹配。这类似于 IPS 签名的工作方式，即网络数据包与包含恶意数据包签名的数据库相匹配。版本扫描选项仅与该文件中签名的质量相同。

以下屏幕截图显示了上述命令的输出：

![The Nmap version scan](../Images/image01094.jpeg)

### 注

`--version-trace`选项将使 Nmap 打印出有关版本扫描和运行的底层测试的调试信息。

您可以向 Nmap 项目报告未知端口的错误结果和新签名。这将有助于提高未来版本中签名的质量。

#### Amap 版本扫描

Kali Linux 还附带了一个名为 Amap 的工具，该工具由黑客选择的（**THC**小组创建，与 Nmap 类似。它通过发送大量数据包来探测打开的端口，然后分析响应以确定在该端口上侦听的服务。

发送到目标端口的探针在名为`appdefs.trig`的文件中定义，接收到的响应根据`appdefs.resp`文件中的签名进行分析。

在渗透测试期间，使用多种工具探测端口以排除任何误报非常重要。在测试过程中，依赖一个工具的签名可能是致命的，因为我们未来的漏洞利用将取决于此阶段确定的服务及其版本。

您可以使用`–bqv`选项调用 Amap，该选项只会报告打开的端口，打印接收到的 ASCII 响应，并打印一些与之相关的详细信息：

![The Amap version scan](../Images/image01095.jpeg)

### 指纹识别 web 应用框架

拥有关于用于开发网站的框架的知识，可以帮助您识别未修补版本中可能存在的漏洞。

例如，如果网站是在 Wordpress 平台上开发的，那么可以在该网站的网页中找到它的踪迹。大多数 web 应用程序框架都有标记，攻击者可以使用这些标记来确定所使用的框架。

有几个地方可以揭示框架的细节。

#### HTTP 头

除了定义 HTTP 事务的操作参数外，标头还可能包含攻击者可以使用的其他信息。

从`X-Powered-By`字段，攻击者可以确定作为 PHP 替代实现的**嘻哈虚拟机**（**HHVM**最有可能是该框架。这种方法可能并不总是有效，因为可以通过服务器端的适当配置禁用头文件：

![The HTTP header](../Images/image01096.jpeg)

应用程序框架还创建了新的 cookie 字段，这些字段可以帮助了解所使用的底层框架，因此也要关注 cookie 字段。

HTML 页面源代码中的注释也可以指示用于开发 web 应用程序的框架。页面源中的信息还可以帮助您确定使用的其他 web 技术。

#### Whatweb 扫描仪

Whatweb 工具的目的是识别网站使用的不同 web 技术。它包含在 Kali Linux 中，位于**应用程序****Web 应用程序分析****Web 漏洞扫描程序**。它确定了用于设计 web 应用程序的不同内容管理系统、统计/分析包和 JavaScript 库。该工具声称拥有 900 多个插件。它可以在不同的攻击级别下运行，以平衡速度和可靠性。该工具可能在单个网页上获得足够的信息来识别网站，或者可能必须递归查询网站以识别所使用的技术。

在下一个示例中，我们将对 Wikipedia 站点使用该工具，并使用`–v`详细选项打印出一些与所识别技术相关的有用信息：

![The Whatweb scanner](../Images/image01097.jpeg)

### 注

如果您正在对内容管理系统进行渗透测试，Kali Linux 会专门创建一个指纹识别工具来识别它。此工具名为 BlindElephant，位于**应用程序****Web 应用程序分析****CMS&框架识别**。

### 识别虚拟主机

许多组织的网站由使用共享资源的服务提供商托管。共享 IP 地址是他们使用的最有用和最具成本效益的技术之一。当您对特定 IP 地址执行反向 DNS 查询时，您经常会看到返回的许多域名。这些网站使用基于名称的虚拟主机，并且通过主机头值唯一地识别和区别于托管在相同 IP 地址上的其他网站。

这类似于多路复用系统。当服务器接收到请求时，它通过查询请求头中的**主机**字段来识别请求并将其路由到特定主机，这在[第 1 章](11.html#aid-2D7TI1 "Chapter 1. Introduction to Penetration Testing and Web Applications")、*渗透测试和 Web 应用简介*中进行了讨论。

### 注

在为网站交互和策划攻击时，确定托管类型变得非常重要。如果 IP 地址承载多个网站，则必须在攻击中包含正确的主机头值，否则将无法获得所需的结果。这也可能会影响该 IP 地址上托管的其他网站。直接使用 IP 地址进行攻击将产生不良结果，也会影响渗透测试的范围。

#### 使用搜索引擎定位虚拟主机

我们可以通过分析 DNS 记录来确定 IP 地址上是否有多个网站。如果多个名称指向同一 IP 地址，则使用**主机**头值来唯一标识网站。DNS 工具（如 dig 和 nslookup）可用于识别返回类似 IP 地址的域。

您可以使用网站[www.my-ip-neights.com](http://www.my-ip-neighbors.com)来确定其他网站是否托管在给定的 web 服务器上。以下示例显示了在同一 IP 地址上托管的多个与 Wikipedia 相关的网站：

![Locating virtual hosts using search engines](../Images/image01098.jpeg)

Bing 还可以用于搜索目标上托管的其他网站。对目标 IP 地址的查询将显示其上托管的其他网站的信息。`ip:`指令以及目标的 IP 地址将返回 Bing 搜索引擎索引的所有网站：

```
ip:<target IP address>

```

以下截图显示了`208.80.154.224`IP 地址返回的网站：

![Locating virtual hosts using search engines](../Images/image01099.jpeg)

#### 侦察中的虚拟主机查找模块

我们前面讨论过的侦察工具还包括一个模块，用于查找同一服务器上的虚拟主机。模块使用网站[my-ip-Neights.com](http://my-ip-neighbors.com)定位虚拟主机。输出存储在 hosts 表中，数据可以导出为前面讨论的所有格式。

首先使用以下命令加载模块：

```
load recon/hosts-hosts/ip_neighbor

```

接下来，设置要测试的目标。这里，我们正在`Wikipedia.org`域中寻找虚拟主机：

```
Set SOURCE Wikipedia.org

```

完成后，键入`run`执行模块，该模块将填充与`wikipedia.org`共享相同 IP 地址的所有域，如下图所示：

![The virtual host lookup module in Recon-ng](../Images/image01100.jpeg)

### 识别负载平衡器

大多数网站使用某种形式的负载平衡来在服务器之间分配负载并保持高可用性。网站的交互性使得最终用户在整个会话期间访问同一台服务器以获得最佳用户体验至关重要。例如，在电子商务网站上，一旦用户在购物车中添加项目，预期用户将再次在结帐页面连接到同一服务器以完成交易。随着中间人（如负载平衡器）的引入，负载平衡器将来自用户的后续请求发送到同一服务器变得非常重要。

有几种技术可用于服务器之间的负载平衡用户连接。DNS 是最容易配置的，但它不可靠，不能提供真正的负载平衡体验。硬件负载平衡器是目前用于将流量路由到网站的设备，这些设备可跨多个 web 服务器维护负载。

在渗透测试期间，有必要确定所使用的负载平衡技术，以便全面了解网络基础设施。一旦确定，您现在必须测试负载平衡器后面的每台服务器是否存在漏洞。还需要与客户团队合作，因为不同的硬件负载平衡器供应商使用不同的技术来维护会话亲和力。

#### 基于 Cookie 的负载平衡器

硬件负载平衡器使用的一种流行方法是在终端客户端的浏览器中插入一个 cookie，将用户与特定服务器绑定。此 cookie 的设置与 IP 地址无关，因为许多用户将处于代理或 NAT 配置之后，并且他们中的大多数人将具有相同的源 IP 地址。

每个负载平衡器都有自己的 cookie 格式和名称。此信息可用于确定是否正在使用负载平衡器及其提供程序。负载平衡器设置的 cookie 还可以显示与目标相关的敏感信息，这些信息可能对渗透测试仪有用。

Burp 代理可以配置为拦截连接，我们可以通过分析标头来查找 cookie。如以下屏幕截图所示，目标使用 F5 负载平衡器。长数值实际上是包含池名、web 服务器 IP 地址和端口的编码值。因此，在这里，负载平衡器 cookie 揭示了它不应该做的关键服务器细节。可以将负载平衡器配置为设置不显示此类详细信息的自定义 cookie。这只能由大型组织完成，这些组织有专门的团队负责其负载平衡器的工作，并对该产品进行了专门培训：

![Cookie-based load balancer](../Images/image01101.jpeg)

F5 负载平衡器的默认 cookie 具有以下格式：

`BIGipServer<pool name> =<coded server IP>.<coded server port>.0000`

在下面的屏幕截图中，您可以看到 cookie 已加密。尽管恶意攻击者可以确定负载平衡器，但 cookie 并未透露负载平衡器后面的 web 服务器的任何信息：

![Cookie-based load balancer](../Images/image01102.jpeg)

#### 识别负载平衡器的其他方法

以下列出了几种识别设备（如负载平衡器）的其他方法：

*   **分析服务器之间的 SSL 差异**：不同 web 服务器之间的 SSL 配置可能会有的细微变化。颁发给池中 web 服务器的证书上的时间戳可能会有所不同。SSL 配置中的差异可用于确定是否在负载平衡器后面配置了多个服务器。
*   **重定向到其他 URL**：跨服务器负载平衡请求的另一种方法是将客户端重定向到其他 URL 以分配负载。用户可以浏览到网站`www.example.com`，但会被重定向到`www2.example.com`。来自另一个用户的请求被重定向到`www1.example.com`并从另一个服务器传递到网页。这是识别负载平衡器的最简单方法之一，但由于其具有管理开销和安全影响，因此通常不会实现。
*   **负载平衡器 DNS 记录**：DNS 区域中的主机记录可用于推断设备是否为负载平衡器。
*   **负载平衡器检测器**：这是 Kali Linux 中包含的工具。它确定网站是否正在使用负载平衡器。从外壳执行刀具的命令为`lbd <website name>`。该工具附带免责声明，它是一个概念验证工具，容易出现误报。
*   **Web 应用防火墙**：除了负载均衡器外，应用还可以使用**Web 应用防火墙**（**WAF**来抵御攻击。Kali Linux 中的 web 应用程序防火墙检测工具 Wafw00f 能够检测路径中是否存在任何 WAF 设备。该工具位于**信息采集****IDS/IPS 标识**处。

### 扫描 web 服务器的漏洞和错误配置

到目前为止，我们已经处理了目标的基础设施部分。我们需要分析底层软件，并试图了解在幕后工作的不同技术。使用默认配置设计的 Web 应用程序容易受到攻击，因为它们为恶意攻击者利用该应用程序提供了多个漏洞。

Kali Linux 提供了几种工具来分析 web 应用程序的配置问题。扫描工具通过浏览整个网站来识别漏洞，并查找感兴趣的文件、文件夹和配置设置。服务器端脚本语言（如 PHP 和 CGI）未正确实现，并且在旧版本上运行，可以使用自动化工具加以利用。

#### 使用 Nmap 识别 HTTP 方法

在几种 HTTP 方法中，目前只有少数几种被积极使用，除非您有有效的理由启用，否则应在 web 服务器上禁用`DELETE`、`PUT`和`TRACE`等 HTTP 方法。

作为渗透测试人员，您的第一项任务应该是确定 web 服务器支持哪些方法。您可以使用 Netcat 打开与 web 服务器的连接，并使用`OPTIONS`方法查询 web 服务器。我们还可以使用 Nmap 来确定支持的方法。

在不断增加的 Nmap 脚本库中，您可以找到一个名为`http-methods.nse`的脚本。当您使用`--script`选项与目标一起运行脚本时，它将列出目标上允许的 HTTP 方法，并指出危险的方法。在下面的屏幕截图中，我们可以看到它检测到几种启用的方法，并指出`TRACE`是一种危险的方法：

![Identifying HTTP methods using Nmap](../Images/image01103.jpeg)

默认情况下，脚本使用用户代理 Mozilla 探测目标，并显示数据包是由 Nmap 脚本引擎生成的：

![Identifying HTTP methods using Nmap](../Images/image01104.jpeg)

您可以使用`http.useragent`脚本参数更改用户代理，并隐藏任何 Nmap 信息以防泄露：

![Identifying HTTP methods using Nmap](../Images/image01105.jpeg)

#### 使用 Metasploit 中的辅助模块测试 web 服务器

以下模块对于渗透测试人员在测试 web 服务器漏洞时非常有用：

*   `Dir_listing`：此模块将连接到目标 web 服务器，并确定其上是否启用了目录浏览。
*   `Dir_scanner`：使用此模块，您可以扫描目标以查找任何感兴趣的 web 目录。您可以为模块提供自定义创建的词典或使用默认词典。
*   `Enum_wayback`：这个是一个有趣的模块，它可以查询 Archive.org 网站并查找目标域中的网页。可能已取消链接的旧网页仍然可以访问，并且可以使用 Archive.org 网站找到。您还可以确定网站多年来所经历的变化。
*   `Files_dir`：此模块可以通过定位配置文件和源代码文件的备份，来扫描服务器是否存在数据泄漏漏洞。
*   `http_login`：如果网页有一个通过 HTTP 工作的登录页面，您可以尝试使用 Metasploit 字典对其进行强制。
*   `robots_txt`：Robot 文件可能包含一些未经探索的 URL，您可以使用此模块进行查询，以查找未被搜索引擎索引的 URL。
*   `webdav_scanner`：这个模块可以用来查看服务器上是否启用了 WebDAV，这基本上将 web 服务器变成了一个文件服务器。

#### 使用 WMAP 网络扫描仪插件自动扫描

随着 Metasploit 多年来的改进，开发人员考虑将几个辅助模块和许多附加功能集成到一个插件中，并自动化扫描 web 服务器的整个任务。这导致创建了一个称为 WMAP 的工具。它集成到 Metasploit 中，因此您可以获得 Metasploit 提供的所有功能，例如自动选项卡完成、从其他扫描仪导入数据以及数据库集成。

一旦 Metasploit 启动并运行，就可以使用`load wmap`关键字加载 WMAP 插件。Wmap 使用 Metasploit 用于保存其结果的 PostgreSQL 数据库。因此，在运行 wmap 之前，请确保已连接数据库。

以下是使用 WMAP 自动扫描的步骤：

1.  You first need to define a site. As shown in the following screenshot, it is done with the command `wmap_sites –a <site name/IP address>`. Then, use the `wmap_site –l` command to identify the site ID. The site ID is now used to identify the site to be tested. The `wmap_targets –d 0` command will then add the website as a target:

    ![Automating scanning using the WMAP web scanner plugin](../Images/image01106.jpeg)

2.  You can have a look at the modules which the tool is going to run by invoking the `wmap_run -t` command. Finally, run the `wmap_run –e` command to start the scan:

    ![Automating scanning using the WMAP web scanner plugin](../Images/image01107.jpeg)

3.  Once the test is complete, you can check out the vulnerabilities found using the `vulns` command:

    ![Automating scanning using the WMAP web scanner plugin](../Images/image01108.jpeg)

4.  使用 WMAP，您可以自动执行我们之前必须执行的所有手动步骤。

#### 漏洞扫描和图形报告–Skipfish web 应用程序扫描仪

Skipfish 扫描仪不太容易出现假阳性错误，并且在扫描结束时以漂亮的图形 HTML 文件生成报告。扫描仪真的很快；它还显示发送的数据包数和在终端上实时创建的 HTTP 连接数。

扫描程序试图识别 web 应用程序中的几个高风险缺陷，例如 SQL 和命令注入缺陷，以及跨站点脚本缺陷。它在 web 应用程序上查找不正确和缺少的 MIME 类型。它还以识别易受攻击的 CGI 和 PHP 脚本而闻名。如果 web 服务器具有过期证书，则也会在 HTML 报告中报告该证书。

Skipfish 漏洞扫描器位于**应用程序****Web 应用程序分析****Web 漏洞扫描器**。当使用–h 开关调用时，它列出了可用于自定义扫描的几个选项。您应该提供保存 HTML 报告和目标的路径。带有输出位置和目标的命令如下所示：

```
Skipfish –o <output location> <target>

```

![Vulnerability scanning and graphical reports – the Skipfish web application scanner](../Images/image01109.jpeg)

结果易于阅读，并被分配了一个风险等级，以引起测试团队的注意。如以下屏幕截图所示，skipjack 在网页上发现了一个潜在的 XSS 缺陷，渗透测试人员现在必须使用手动测试技术对其进行进一步验证和测试：

![Vulnerability scanning and graphical reports – the Skipfish web application scanner](../Images/image01110.jpeg)

### 爬行式 web 应用程序

当测试一个大型现实世界的应用程序时，您需要一种更详尽的方法。作为第一步，您需要确定应用程序有多大，因为有几个决策依赖于它。您需要的资源数量、工作量估算和评估成本取决于应用程序的大小。

web 应用程序由多个相互链接的网页组成。在开始评估应用程序之前，您需要对其进行映射以确定其大小。您可以像普通用户一样手动浏览应用程序，单击每个链接并查看内容。在手动爬网应用程序时，您的目标应该是从经过身份验证和未经身份验证的用户的角度识别尽可能多的网页。

手动对应用程序进行爬网既耗时又容易出错。Kali Linux 有许多工具可用于自动化此任务。Burp 套件中的 Burp spider 工具以爬行 web 应用程序而闻名。它自动化了在应用程序中对各种网页进行编目的繁琐任务。它的工作原理是请求一个网页，解析它的链接，然后向这些新链接发送请求，直到所有网页都被映射。这样，就可以映射整个应用程序，而不会忽略任何网页。

#### 打嗝蜘蛛

Burp spider 使用被动和主动方法映射应用程序。启动 Burp 代理时，默认情况下，它以被动爬行模式运行。在此模式下，当浏览器配置为使用 Burp 代理时，它将使用通过代理请求的所有内容更新站点地图，而不发送任何进一步的请求。被动爬行被认为是安全的，因为您可以直接控制爬行的内容。这在包含您不希望触发的管理功能的关键应用程序中变得非常重要。

为了有效的映射，被动 spidering 模式应与主动模式一起使用。最初，允许 Burp spider 在您浏览应用程序时被动地映射应用程序，当您找到需要进一步映射的感兴趣的网页时，可以触发主动爬网模式。在活动模式下，Burp spider 将递归地请求网页，直到它映射所有 URL。

下面的屏幕截图显示了当我们单击应用程序中的各个链接时被动爬网的输出。在被动映射应用程序之前，请确保已将 Burp 设置为 web 浏览器中的代理，并且已关闭拦截：

![The Burp spider](../Images/image01111.jpeg)

当您想主动爬行一个网页时，右键点击**站点地图**部分的链接，点击**爬行该分支**。一旦您这样做，活动爬行器模式就会启动。在的**Spider**部分，您将看到已发出请求，**站点地图**将填充新项目，如以下屏幕截图所示：

![The Burp spider](../Images/image01112.jpeg)

当活动 spider 运行时，它将显示请求数量和一些其他详细信息。在**范围**部分，您可以使用正则表达式字符串创建规则来定义目标：

![The Burp spider](../Images/image01113.jpeg)

#### 应用登录

应用程序在允许您查看内容之前可能需要身份验证。Burp spider 可以配置为在对应用程序进行爬网时使用预配置的凭据对其进行身份验证。在**Spider**部分的**选项**选项卡下，您可以定义凭证或选择**引导提示**选项：

![Application login](../Images/image01114.jpeg)

当您选择**提示引导**选项时，会显示提示，如果蜘蛛遇到登录页面，您可以输入**用户名**和**密码**，如下所示：

![Application login](../Images/image01115.jpeg)

在本章的最后，我们完成了侦察阶段，并完成了对 web 服务器的扫描。在下面的屏幕截图中，我列出了 Kali Linux 中的一些有用工具，这些工具可用于以下每个阶段：

![Application login](../Images/image01116.jpeg)

# 总结

侦察是渗透测试的第一阶段。在测试可从互联网访问的目标时，搜索引擎和社交网站可以显示有用的信息。搜索引擎存储了大量信息，这些信息在执行黑盒渗透时非常有用。我们使用这些免费资源来识别恶意用户可能对目标使用的信息。Kali Linux 有几个工具可以帮助我们实现目标，我们很少使用。然后我们进入扫描阶段，该阶段要求黑客主动与 web 应用程序交互，以识别漏洞和错误配置。

在下一章中，我们将研究影响 web 应用程序的服务器端和客户端漏洞。