# 第五章嗅探和欺骗

网络嗅探帮助您了解哪些用户正在使用可以利用的服务，IP 欺骗可以用来毒害系统的 DNS 高速缓存，以便将所有的流量发送给中间人（例如您指定的主机），以及大多数电子邮件钓鱼方案的组成部分。嗅探和欺骗通常用于网络中的 Windows 端点，您需要了解坏人将要使用的技术：

*   **嗅探网络流量**：嗅探网络流量的工具很多，但它们的工作原理都是相同的。您的**网络接口卡**（**NIC**可以读取所有 TCP/IP 数据包。有数百种协议和数千个 TCP/IP 端口。可以肯定地说，您不必了解所有这些，但您可能会了解十几个。
*   **欺骗网络流量**：TCP/IP 系统信任。网络工作方式的基本假设是一种对可信度的期望。当一个犯罪分子决定对网络数据包的组合方式耍花招时会发生什么？这是欺骗。例如，当 ICMP 数据包被广播到大量主机，但原始 IP 地址被伪造以指向特定的目标主机时，发送到广播数据包的所有主机都会向受害者发送意外确认。这是一个*蓝精灵攻击*，它会将受害者的机器绑起来。Smurf 攻击是众多**拒绝****服务****拒绝**攻击之一。

# 嗅探和欺骗网络流量

你很可能已经注意到了 Kali Linux 的座右铭，*你**越安静，你就越能听到*。这是嗅探网络流量的核心。你静静地倾听网络流量，复制每一个数据包。每一包都很重要，否则它就不在那里了。戴上安全帽想一想。你明白为什么明文发送密码这么糟糕吗？嗯，像 Telnet、FTP 和 HTTP 这样的协议以明文形式发送密码，而不是加密哈希。任何数据包嗅探器都会捕捉到这些密码，而且不需要天才就可以在数据包捕捉中搜索诸如*密码*之类的术语。没必要去炸土豆条，它就在那儿。你只需凭空拿出他们的明文密码，就能给经理或客户留下深刻印象。坏人使用同样的技术闯入网络，窃取金钱和秘密。

在复制的数据包中可以找到的不仅仅是密码。数据包嗅探器不仅用于数据包目的。在网络上查找攻击者时，它们可能很有用。你不能躲避包嗅探器。数据包嗅探器对于网络诊断也很有用。例如，网络运行缓慢可能是由于一台 NIC 正在消亡的服务器不与任何人通信，或是一个失控的进程将许多其他进程与响应捆绑在一起。

如果嗅探正在监听网络，那么欺骗正在欺骗网络。你所做的是让攻击机器对网络撒谎，并让它假装是其他人。使用下面的一些工具，以及网络上攻击机器上的两张网卡，您甚至可以将流量传递到真正的主机上，并捕获进出两台机器的所有流量。这是一个**中间人攻击**（**MitM**）。在笔测试的大多数情况下，您实际上只是在密码散列之后进行测试，而密码散列可以在没有完整的 MitM 攻击的情况下获得。仅仅是欺骗而不传递流量将在 NetBIOS 的 ARP 广播中暴露密码哈希。

### 提示

**黑客提示**

高级黑客实验室–如果您计划在网络上运行完整的 MitM 攻击，那么除了安装了 Kali Linux 的笔记本电脑之外，您还需要一台至少带有两个 NIC 的主机。您的 MitM 主机可以是虚拟或物理服务器。

# 嗅探网络流量

包嗅探是理解网络的最好方法之一。在 NIC 读取数据包时使用终端窗口流式传输文本可能有点过时，但它是所有网络分析的基础。我们展示了几个嗅探器，您可以使用它们窃取明文密码，映射所有响应机器的 IP 地址，并收集带有用户名和密码哈希的 NTLM 数据包。

## 使用 tcpdump 进行基本嗅探

**Tcpdump**是一个简单的命令行嗅探工具，可在大多数路由器、防火墙和 Linux/UNIX 系统上找到。还有一个版本在 microOLAP 制造的 Windows 上运行，可以在[找到 http://www.microolap.com/products/network/tcpdump/](http://www.microolap.com/products/network/tcpdump/) 。它不是免费的，但有试用版。这个版本的好处在于它是一个简单的可执行文件，可以上传到系统中使用，而无需安装额外的驱动程序。它可以在有外壳访问权限的破裂系统上启动。您的 shell 必须具有系统或管理员级别的访问权限才能工作，因为如果没有管理权限，NIC 将不会在混杂模式下运行。另一个数据包转储工具是**Windump.exe，**可从[获得 http://www.winpcap.org/windump/install/](http://www.winpcap.org/windump/install/) 中，您还可以找到**WinPcap.exe，在机器上运行 tcpdump 或 windump 所需的**。

在 Linux/Unix 系统和诸如 Cisco 或 Juniper 之类的路由器上，默认情况下可能会安装它。如果您在 Linux 系统上找不到它，那么它就存在于每个分发存储库中。

Tcpdump 的最佳用途不是收集数据进行实时检查，而是将数据捕获到文件中，以便稍后使用类似于**Wireshark**的工具进行查看。由于 tcpdump 的体积小、可移植性好，并且可以从命令行使用，因此它非常适合此任务。

下面，我们看到 tcpdump 运行时没有保存到文件。请注意，当数据包通过接口时，我们可以看到它们。

我们正在运行的命令是：

```
tcpdump -v -i vmnet1

```

`-v`将应用程序置于详细模式。`-i vmnet1`命令应用程序只捕获`vmnet1`接口上的数据包。点击*输入*键，tcpdump 将开始捕获数据包并将其显示在屏幕上。要停止捕获，请点击*Ctrl*+*C*。

现在，在这种模式下，对于任何实际用途，数据的传递速度都会过快，特别是在大型网络上，因此接下来我们将把数据保存到一个文件中，以便我们可以在空闲时使用更好的查看工具查看数据：

![Basic sniffing with tcpdump](../Images/image00804.jpeg)

现在，我们将运行以下命令并将输出通过管道传输到一个`.pcap`文件。请注意，屏幕上没有您之前看到的输出。数据现在将进入文件，而不是屏幕。运行以下命令：

```
tcpdump -v -i vmnet1 -w kalibook-cap-20150411.pcap

```

注意，我们正在命令中添加`-w kalibook-cap-20150411.pcap`。标记`-w`告诉应用程序将数据写入名为`kalibook-cap-20150411.pcap`的文件。该文件应该有一个描述性的名称，我也包括在文件名的日期。如果您不时地进行此类测试，但不从系统中删除文件，则可能会造成混淆，因为其中几个文件位于同一系统上。`.pcap`是业界用于包文件的标准文件扩展名，代表**包捕获文件**。此文件可以使用文件传输方式移动到另一台机器：

![Basic sniffing with tcpdump](../Images/image00805.jpeg)

请注意，此捕获是在名为 wander 的机器上完成的。**Wander**是我们网络的防火墙，是捕获网络流量的最佳场所。我们现在将其传输到我们的卡利盒，以检查数据包：

首先，在我们的 Kali 机器上，我们需要启动 SSH 服务。正如我们前面提到的，Kali 包括您可以在任何 Linux 服务器上找到的所有网络服务，但出于安全原因，所有服务在默认情况下都是关闭的，必须手动启动才能使用。我们将使用以下命令启动 SSH：

```
service ssh start

```

![Basic sniffing with tcpdump](../Images/image00806.jpeg)

我们可以看到 SSH 服务启动，通过运行`netstat -tl`命令，我们可以看到 SSH 服务正在监听所有接口。我们现在将把文件从防火墙传输到 Kali。

在 Kali 命令行上，运行以下命令：

```
ifconfig

```

这将显示您的 IP 地址：

![Basic sniffing with tcpdump](../Images/image00807.jpeg)

现在，通过运行以下命令，从防火墙将文件传输到 Kali：

```
scp kalibook-cap-20150411.pcap root@192.168.202.129:kalibook/kalibook-cap-20150411.pcap

```

输入`yes`接受键警告，然后在提示时输入 root 密码。

### 提示

**注：**

在这里，我们试图将其发送到错误的目录。没有名为`workspace`的目录。如果您看到这种类型的错误，这很可能就是原因。请注意，我们已将此文件直接移动到 Kali 框上的项目目录。

![Basic sniffing with tcpdump](../Images/image00808.jpeg)

完成后，不要忘记关闭 SSH。

```
service ssh stop

```

所以，这对于内置了`ssh`的系统来说是好的，但是 Windows 呢？SSH 客户机在 Windows 平台上非常精简。大多数人似乎都在使用`putty.exe`，但你的破解服务器系统不太可能安装 putty。我们会回到过去的好日子。大多数 Windows 系统都附带 FTP 命令行实用程序。有时，有安全意识的系统管理员会从机器上删除`ftp.exe`，这会阻止这种类型的文件传输。通常，它是供你使用的。如果没有，请转到[http://www.coreftp.com/](http://www.coreftp.com/) 和下载核心 FTP。他们有一个适用于此应用程序的免费版本，您还可以获得更多功能的付费许可证。

我们现在将把 tcpdump 实用程序传输到我们的破解 Windows 机器上，以捕获一些数据包。

首先，我们需要在 Kali 上设置 FTP 服务，以便来回传输。我们将使用我们的朋友**Metasploit**来这个。为此，Metasploit 有一个易于使用的 FTP 服务。我们需要一个文件夹从以下位置工作：

1.  在 Kali box 上打开桌面上的计算机。
2.  点击左侧列表中的**主页**链接。
3.  右键点击文件夹区域，点击**新建文件夹**。
4.  将其命名为`public`，然后右键单击该文件夹并转到**属性**。
5.  Click on the **Permissions** tab, give both the **Group** and **Others** read/write access and the ability to create and delete files, as seen as following:

    ![Basic sniffing with tcpdump](../Images/image00809.jpeg)

现在将`NDIS driver`和`tcpdump.exe`复制到公用文件夹中。如果目标网络上可能正在使用反病毒和/或 IDS/IPS 系统，则需要重命名 tcpdump 文件。我已将名称更改为`tdpdump.jpg`。`microolap_pssdk6_driver_for_ndis6_x86_v6.1.0.6363.msi`驱动程序文件正常通过 OK。（这些文件位于连接到章节的`tools`文件夹中。）

现在，通过进入**应用程序****Kali Linux****系统服务****社区/专业启动**启动服务，在 Kali box 上启动 Metasploit。服务启动后，打开终端窗口并键入：

```
msfpro

```

Metasploit 将启动。Metasploit 运行后，将其更改为项目的工作区。我的工作区名为`kali-book-int-20150300`：

```
workspace kali-book-int-20150300

```

现在我们将配置 FTP 服务器并启动它。要加载 FTP 服务器，请键入以下命令。

```
use auxiliary/server/ftp
show options

```

您将看到配置选项。

![Basic sniffing with tcpdump](../Images/image00810.jpeg)

我们需要更改`FTPROOT`设置类型：

```
set FTPROOT /root/public
show options

```

通过再次运行`show options`命令，我们可以检查我们的配置。我们准备好出发了。键入以下命令：

```
run

```

您将看到如下输出：

![Basic sniffing with tcpdump](../Images/image00811.jpeg)

您可以通过运行以下命令查看服务：

```
netstat-tl

```

![Basic sniffing with tcpdump](../Images/image00812.jpeg)

现在，让我们将文件复制到我们的 Windows 机器上，并捕获一些美味的数据包！我们将在 Windows 上使用 WinDump 进行此过程。

## 使用 WinDump 进行更基本的嗅探（Windows tcpdump）

**WinDump**是 Windows 的 tcpdump。它是开源的，并且在 BSD 许可下。您可以在[下载 http://www.winpcap.org/windump/](http://www.winpcap.org/windump/) 。

您还需要 WinPcap 驱动程序，所以一定要从站点获取它们。

WinDump 将在命令行、电源外壳或远程外壳上工作。与 tcpdump 一样，它将写入一个文件，您可以下载该文件进行脱机查看。

现在让我们把文件复制到我们的 Windows 机器上。从命令行、powershell 或被利用的远程 Shell 登录到 Kali 上的 FTP 服务器。我的卡利盒子在`192.168.202.129`：

```
ftp 192.168.202.129

```

系统将要求输入用户名；只需点击*进入*。它还会要求输入密码，所以只需再次点击*进入*即可登录。然后，键入：

```
dir

```

这将显示目录的内容：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00813.jpeg)

如上所述，我们看到了我们的 WinPcap 驱动程序和我们的公开的 WinDump.exe。要下载它们，只需键入：

```
get WinPcap_4_1_3.exe

```

然后

```
get WinDump.exe

```

我们有文件了，现在请注销：

```
quit

```

正如我们在前面的屏幕截图中所看到的，我们现在通过键入以下内容在本地拥有文件：

```
dir

```

我们还可以在 Metasploit 中看到在 Kali 上从正在运行的实例传输的文件：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00814.jpeg)

现在，通过 RDP 或从 Metasploit 启动 VNC 会话登录到您的 pwned Windows 计算机。从桌面进入下载文件的文件夹，双击`WinPcap.exe`文件，如下图所示：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00815.jpeg)

接下来，您将获得许可证窗口，单击**我同意**按钮并继续：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00816.jpeg)

下一个屏幕开始驱动程序的实际安装。确保勾选复选框以自动运行。如果您必须返回，这将是一个很大的帮助：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00817.jpeg)

完成此操作后，您就可以捕获一些数据包了。

启动命令行窗口或 powershell，并转到您拥有 WinDump 的目录。这里，我们把它放在**下载**文件夹中。运行以下命令。

```
.\WinDump.exe

```

很快，您将开始看到数据包通过接口。屏幕上显示的内容取决于系统与网络的通信量。您可以判断是否有太多的数据无法实时理解。此外，在此模式下，您只看到数据包的报头信息，而不是完整的数据包及其信息。下面，您将看到以黄色标记的命令正在运行，以绿色标记的命令正在运行界面上侦听。在那之后，你会看到包进来了。

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00818.jpeg)

现在，让我们将捕获内容转储到一个文件中，这样我们就可以通过运行以下命令来查看我们拥有的内容：

```
.\WinDump.exe -w Win7-dump-20150411.pcap

```

`-w`文件告诉 WinDump 写入文件`Win7-dump-20150411.pcap`。正如您在下面看到的，如果您忘记了 write 标志，那么使用`-h`标志运行 WinDump 将给您一个简短的帮助。运行一段时间后，点击*Ctrl*+*C*停止捕捉。您现在可以看到，我们有一个包含捕获的数据包的文件。

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00819.jpeg)

捕获后，我们需要将文件发送回 Kali 以分析数据包。

Windows 文件共享适用于此。如果打印机和文件共享未打开，请启用它以共享文件并返回到您的 Kali 框。

### 提示

**黑客提示**

如果网络管理员运行 Tripwire 之类的程序来检查配置更改，或者将 ArcSight 设置为警告管理用户记录的操作，则此过程可能会引发警报。

Kali 的文件管理器中内置了 SMB 文件共享和 NetBIOS 发现功能。点击桌面上的**电脑**图标，然后点击**浏览网络**；您将看到**Windows 网络**的图标，如下所示：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00820.jpeg)

通过点击**Windows 网络**，Kali 将发现本地网络上的任何工作组或域。如下图所示，我们看到了我们当地的工作组**IVEBEENHAD；**点击它，您将看到网络上的计算机：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00821.jpeg)

接下来，点击受害者计算机，并使用与您拥有凭据的工作组或域关联的管理员帐户登录，此时您将看到系统上的共享目录。向下钻取文件夹并转到包捕获所在的目录。对于我们来说，将是**用户****管理员****下载**：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00822.jpeg)

现在我们已经到达文件所在的位置，再次点击**计算机**图标，打开另一个文件管理器窗口，进入项目的证据目录。然后，将文件拖放到 Kali 的驱动器上：

![More basic sniffing with WinDump (Windows tcpdump)](../Images/image00823.jpeg)

现在我们准备读取一些捕获的数据包。

## 利用 Wireshark 搜寻包裹

**Wireshark**是数据包嗅探和分析网络数据包的行业实际标准。它不仅适用于 TCP/IP，而且几乎适用于所有其他已知的协议和标准。每个著名的操作系统都有 Wireshark 版本。要在 Windows 上运行 Wireshark，您需要本章前面的 WinPcap 驱动程序。在 Linux/Unix 和 OSX 上，驱动程序通常已经存在。Wireshark 预装在 Kali 上。

Wireshark 是一个极其复杂的应用程序。有很多关于它的使用的书。我建议你买一个，并学习这个工具的深入使用。这里我们将只介绍基本内容。

如果你仔细想想，互联网是什么？有些人指着他们的网络浏览器说有互联网。系统管理员可能会给您一个关于通过网络传输数据的服务器和设备的详细答案。每个人的答案都是正确的，但仍然没有准确地回答问题。互联网是信息包。没有数据包，信息就没有出路。大多数人没有意识到 TCP/IP 是两个独立工作的不同协议套件。首先是 IP，然后是 TCP 和 UDP，它们运行在 IP 之上。所有这些都会在互联网框架上运行。

我们马上回 Wireshark。首先，我们需要理解一个包。

### 解剖包裹

让我们看看一个包。下面是从捕获的数据流中提取的一个信息包。请记住，这只是一包！

哦，这里有一点历史！如果您查看数据包的结构和旧电报消息的结构，您会注意到结构是相同的。是的，包基本上是电报。还要记住，摩尔斯电码基本上是一种 4 位二进制语言。

请注意，首先我们有一个框架。帧包含有关数据包的基本信息。您可以看到线路上的字节，它是由 Wireshark 捕获的。这也保持了数据包的定时，并且在接收到数据包时用于重新组装数据包：

```
Frame 9: 188 bytes on wire (1504 bits), 188 bytes captured (1504 bits)
    Encapsulation type: Ethernet (1)
    Arrival Time: Apr 12, 2015 01:43:27.374355000 EDT
    [Time shift for this packet: 0.000000000 seconds]
    Epoch Time: 1428817407.374355000 seconds
    [Time delta from previous captured frame: 0.002915000 seconds]
    [Time delta from previous displayed frame: 0.002915000 seconds]
    [Time since reference or first frame: 9.430852000 seconds]
    Frame Number: 9
    Frame Length: 188 bytes (1504 bits)
    Capture Length: 188 bytes (1504 bits)
    [Frame is marked: False]
    [Frame is ignored: False]
    [Protocols in frame: eth:ip:tcp:nbss:smb]
    [Coloring Rule Name: SMB]
    [Coloring Rule String: smb || nbss || nbns || nbipx || ipxsap || netbios]
```

接下来，我们将看到您的数据包的 IP 部分。我们看到它包含源接口和目标接口的 MAC 地址。你的 MAC 地址是你真正的机器地址。堆栈的 IP 部分进行路由，以便两个 MAC 地址可以找到对方。

```
Ethernet II, Src: Vmware_07:7e:d8 (00:0c:29:07:7e:d8), Dst: Vmware_45:85:dc (00:0c:29:45:85:dc)
    Destination: Vmware_45:85:dc (00:0c:29:45:85:dc)
        Address: Vmware_45:85:dc (00:0c:29:45:85:dc)
        .... ..0\. .... .... .... .... = LG bit: Globally unique address (factory default)
        .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
    Source: Vmware_07:7e:d8 (00:0c:29:07:7e:d8)
        Address: Vmware_07:7e:d8 (00:0c:29:07:7e:d8)
        .... ..0\. .... .... .... .... = LG bit: Globally unique address (factory default)
        .... ...0 .... .... .... .... = IG bit: Individual address (unicast)
    Type: IP (0x0800)
Internet Protocol Version 4, Src: 192.168.202.130 (192.168.202.130), Dst: 192.168.202.128 (192.168.202.128)
    Version: 4
    Header length: 20 bytes
    Differentiated Services Field: 0x00 (DSCP 0x00: Default; ECN: 0x00: Not-ECT (Not ECN-Capable Transport))
    Total Length: 174
    Identification: 0x033f (831)
    Flags: 0x02 (Don't Fragment)
    Fragment offset: 0
    Time to live: 128
    Protocol: TCP (6)
    Header checksum: 0xe0b6 [correct]
        [Good: True]
        [Bad: False]
    Source: 192.168.202.130 (192.168.202.130)
    Destination: 192.168.202.128 (192.168.202.128)
    [Source GeoIP: Unknown]
    [Destination GeoIP: Unknown]
```

数据包的下一部分是 TCP 进入的地方，它设置要使用的 TCP 或 UDP 协议的类型以及为数据包传输分配的源端口和目标端口。此数据包是从客户机（即源）发送的。从上面的 IP 部分，我们看到客户端 IP 地址是`192.168.202.130`。下面我们看到客户的端口`49161`。此数据包正在发送到端口`445`的`192.168.202.128`（目的地）。这是 TCP，返回的流量包括一个返回路由。我们可以通过目标端口信息判断这是某种类型的 SMB 流量：

```
Transmission Control Protocol, Src Port: 49161 (49161), Dst Port: microsoft-ds (445), Seq: 101, Ack: 61, Len: 134
    Source port: 49161 (49161)
    Destination port: microsoft-ds (445)
    [Stream index: 0]
    Sequence number: 101    (relative sequence number)
    [Next sequence number: 235    (relative sequence number)]
    Acknowledgment number: 61    (relative ack number)
    Header length: 20 bytes
    Flags: 0x018 (PSH, ACK)
        000\. .... .... = Reserved: Not set
        ...0 .... .... = Nonce: Not set
        .... 0... .... = Congestion Window Reduced (CWR): Not set
        .... .0.. .... = ECN-Echo: Not set
        .... ..0\. .... = Urgent: Not set
        .... ...1 .... = Acknowledgment: Set
        .... .... 1... = Push: Set
        .... .... .0.. = Reset: Not set
        .... .... ..0\. = Syn: Not set
        .... .... ...0 = Fin: Not set
```

在上述分组信息中，`0`为`No`，而`1`为`Yes`。

```
    Window size value: 63725
    [Calculated window size: 63725]
    [Window size scaling factor: -1 (unknown)]
    Checksum: 0xf5d8 [validation disabled]
    [SEQ/ACK analysis]
        [This is an ACK to the segment in frame: 8]
        [The RTT to ACK the segment was: 0.002915000 seconds]
        [Bytes in flight: 134]
```

下面我们看到这是一个使用`SMB`协议的`NetBIOS`会话：

```
NetBIOS Session Service
    Message Type: Session message (0x00)
    Length: 130
SMB (Server Message Block Protocol)
    SMB Header
        Server Component: SMB
        [Response in: 10]
        SMB Command: NT Create AndX (0xa2)
        NT Status: STATUS_SUCCESS (0x00000000)
        Flags: 0x18
        Flags2: 0xc807
        Process ID High: 0
        Signature: 0000000000000000
        Reserved: 0000
        Tree ID: 2049
        Process ID: 2108
        User ID: 2048
        Multiplex ID: 689
    NT Create AndX Request (0xa2)
        [FID: 0x4007]
        Word Count (WCT): 24
        AndXCommand: No further commands (0xff)
        Reserved: 00
        AndXOffset: 57054
        Reserved: 00
        File Name Len: 44
        Create Flags: 0x00000016
        Root FID: 0x00000000
```

下面，我们已被授权访问我们请求的数据。我们现在可以看到，这个数据包与访问文件有关。完成此请求的用户具有以下权限来查看请求的文件。从上面可以看出，文件请求的状态为“成功”：

```
        Access Mask: 0x00020089
            0... .... .... .... .... .... .... .... = Generic Read: Generic read is NOT set
            .0.. .... .... .... .... .... .... .... = Generic Write: Generic write is NOT set
            ..0\. .... .... .... .... .... .... .... = Generic 
            Execute: Generic execute is NOT set
            ...0 .... .... .... .... .... .... .... = Generic All: Generic all is NOT set
            .... ..0\. .... .... .... .... .... .... = Maximum Allowed: Maximum allowed is NOT set
            .... ...0 .... .... .... .... .... .... = System Security: System security is NOT set
            .... .... ...0 .... .... .... .... .... = Synchronize: 
            Can NOT wait on handle to synchronize on completion of 
            I/O
            .... .... .... 0... .... .... .... .... = Write Owner: 
            Can NOT write owner (take ownership)
            .... .... .... .0.. .... .... .... .... = Write DAC: Owner may NOT write to the DAC
            .... .... .... ..1\. .... .... .... .... = Read Control: READ ACCESS to owner, group and ACL of the SID
            .... .... .... ...0 .... .... .... .... = Delete: NO delete access
            .... .... .... .... .... ...0 .... .... = Write Attributes: NO write attributes access
            .... .... .... .... .... .... 1... .... = Read Attributes: READ ATTRIBUTES access
            .... .... .... .... .... .... .0.. .... = Delete Child: NO delete child access
            .... .... .... .... .... .... ..0\. .... = Execute: NO execute access
            .... .... .... .... .... .... ...0 .... = Write EA: NO write extended attributes access
            .... .... .... .... .... .... .... 1... = Read EA: READ EXTENDED ATTRIBUTES access
            .... .... .... .... .... .... .... .0.. = Append: NO append access
            .... .... .... .... .... .... .... ..0\. = Write: NO write access
            .... .... .... .... .... .... .... ...1 = Read: READ access
        Allocation Size: 0
        File Attributes: 0x00000000
        Share Access: 0x00000007 SHARE_DELETE SHARE_WRITE SHARE_READ
        Disposition: Open (if file exists open it, else fail) (1)
        Create Options: 0x00000044
        Impersonation: Impersonation (2)
        Security Flags: 0x03
        Byte Count (BCC): 47
        File Name: \My Videos\desktop.ini
```

上面所有的行都是为了让一台计算机知道在另一台计算机上存在一个名为`\My Videos\desktop.ini`的文件。`47`发送了字节的信息。现在，这不是实际的文件，只是一个文件列表。基本上，这就是使文件图标出现在窗口管理器中的数据包。只发送一点点数据确实需要很多：

```
No.     Time        Source                Destination           Protocol Length Info
     10 9.431187    192.168.202.128       192.168.202.130       SMB      193    NT Create AndX Response, FID: 0x4007
```

现在我们了解了一些关于数据包的知识，让我们回到 Wireshark！

### 和线鲨一起游泳

让我们打开它打开我们的捕获。当你在 Kali 1.x 中访问 Wireshark 时，你必须访问**应用程序****Kali Linux****十大安全工具****Wireshark**。当它启动时，它将向您发出有关以 root 身份运行的警告。您可以安全地单击这些。如果您愿意，请勾选表示您不想再次看到这些的复选框。当您与 Kali 合作时，您将始终以`root`的身份工作。在 Kali 2.0 和 Kali Rolling 发行版中，您将在**09-嗅探&欺骗****Wireshark**菜单下找到 Wireshark。进攻性安全部门的好人使得 Kali 中大多数工具的点击路径更短。

![Swimming with Wireshark](../Images/image00824.jpeg)

### 提示

另一个警告：千万不要在生产 Linux 机器上这样做。除了卡利，不要以`root`身份登录和运行任何地方。Wolf 在他的 Kali Linux 测试盒中添加了一个标准用户和`sudo`，只有在实际运行测试时才以`root`的身份运行。

![Swimming with Wireshark](../Images/image00825.jpeg)

警告后，窗口将打开。正如我们所看到的，我们有一个非常好的界面。您可以做的不仅仅是读取捕获。您可以从列出的本地接口捕获数据包。在右边，您将看到一个关于**在线帮助**的部分。如果你迷路了，需要帮助，那就是你要去的地方。网上有大量帮助：

![Swimming with Wireshark](../Images/image00826.jpeg)

让我们开始我们的捕获。点击**文件****打开**，会出现文件菜单。导航到文件所在的位置并单击**打开**按钮：

![Swimming with Wireshark](../Images/image00827.jpeg)

现在捕获打开，所有捕获的数据都列在顶部屏幕中。每个列表都是一个数据包。您看到的是数据包的头信息、其源、目的地和协议类型。

通过单击顶部屏幕上的一个数据包，该数据包的全部信息将出现在中间屏幕中。这将是我们之前分解数据包时看到的信息。这个实际上是人类可读的数据包。在底部屏幕中，我们有机器语言中的实际原始数据包。通过在中间屏幕上点击信息线，WiReSARK 将在蓝色中突出显示该代码在该分组上的机器语言的字符串：

![Swimming with Wireshark](../Images/image00828.jpeg)

查看第一个屏幕，我们可以看到总体流量。我们看到一台机器发出 DHCPv6 请求呼叫，却没有收到任何地方的响应。必须在此网络上关闭 IPv6。接下来，我们将看到`192.168.202.128`和`192.168.202.130,`之间来回的通信量。仅从标题中我们可以看到，此传输用于使用 SMB 的`192.168.202.128`上的文件信息。我们可以通过查看标题得知`.130`上的用户可以访问`.128`：

![Swimming with Wireshark](../Images/image00829.jpeg)

那么，好东西在哪里？下面我们有一个 SMB NTLMSSP 数据包，我们可以从头部看到这是针对帐户`IVEBEENHAD\Administrator`的。通过选择数据包，我们可以向下钻取数据包中的并找到密码的 NTLM 哈希值。这一点可以单独用于可以传递散列的利用工具中。您还可以将此散列值引入脱机密码破解工具，如 John the Ripper 或 Hydra。请注意，您还可以在底部屏幕中看到原始数据包信息中的值：

![Swimming with Wireshark](../Images/image00830.jpeg)

Wireshark 的最佳功能之一是搜索功能。这个函数的细节本身就是一本书。您可以使用**表达式构建表达式。。。**过滤器**字段右侧的**按钮。从简单的过滤器，如`ip != 10.0.0.232`（将所有流量分割到您的 Kali box）或通过在过滤器字段中输入 SMTP 来检查意外的 SMTP 流量，当您学习您最需要的过滤器时，会有无穷的乐趣。在线帮助将解释很多，与所有优秀的知识库一样，它也会提出新的问题：

![Swimming with Wireshark](../Images/image00831.jpeg)

# 欺骗网络流量

互联网上的欺骗有几种定义：

*   **电子邮件欺骗**：这是最常见的定义，与使用虚假电子邮件地址伪装成不同的人有关。这在尝试网络钓鱼攻击时效果很好，受害者收到一封据称来自其银行或零售店的电子邮件。
*   **域欺骗**：有可能欺骗域，这是您毒害其网络或单个工作站上的路由表的地方。其工作原理是，用户在地址栏中键入的域未对齐，指向错误的 IP 地址。当受害者进入[时 http://bankarmenia.com/](http://bankarmenia.com/) 他们最终进入了一个看起来与亚美尼亚银行网站一模一样的钓鱼网站，但事实并非如此。这用于从用户处收集凭据以进行盗窃。
*   **域名错误欺骗**：黑客购买热门网站常见错误的域名，如`Yaahoo.com`。他们建立了一个类似[www.yahoo.com](http://www.yahoo.com)的网站，并从所有拼写错误中获益。
*   **IP 欺骗**：为了伪装成不同的机器或隐藏数据包的来源，而创建精心制作的数据包。

## Ettercap

我们最喜欢的欺骗工具之一是 eTerCap。它的魅力之一是能够通过防火墙和从一段到另一段运行欺骗：

![Ettercap](../Images/image00832.jpeg)

可爱的标志和非常透露！是的，那是蜘蛛背上的无线路由器。Ettercap 有一些很好的无线网络插件。我们现在不会报道无线，但这是需要了解的。Ettercap 可以像 tcpdump 和 Wireshark 一样嗅探和捕获数据，但它还具有欺骗网络流量、捕获感兴趣的信息并将其传输到文件的功能。在 Kali 1.x 中，可以在**应用程序【Kali Linux】****嗅探/欺骗****网络嗅探器****ettercap 图形化**中找到图形界面，以启动 ettercap：

![Ettercap](../Images/image00833.jpeg)

在 Kali 2.0 和滚动版本中，eTerCap GUI 的点击路径为**09-嗅探&欺骗****eTerCap GUI**：

![Ettercap](../Images/image00834.jpeg)

下面是 Ettercap 的图形界面。我们首先在菜单栏中选择**嗅探****统一****嗅探**启动**统一嗅探**：

![Ettercap](../Images/image00835.jpeg)

我们现在被问到使用哪个接口。通常，它将是默认值。如果需要，可以通过下拉框选择系统上的任何界面。点击**确定**按钮。

### 提示

**警告！**

使用 SSH 隧道时，如果从远程计算机使用，eTerCap 将断开隧道连接。他们似乎玩得不好。

![Ettercap](../Images/image00836.jpeg)

您会注意到，一旦配置了统一嗅探，菜单栏就发生了更改。

首先，我们需要记录消息。转到**记录****记录用户消息。。。菜单栏中的**：

![Ettercap](../Images/image00837.jpeg)

您将获得一个窗口来命名消息输出的文件。给它一个文件名并点击**确定**按钮：

![Ettercap](../Images/image00838.jpeg)

接下来，我们需要开始嗅探流量。进入**开始****开始嗅探**。这里发生的是 tcpdump 和 Wireshark 执行的相同功能。目前，eTerCap 只是被动地捕获数据包。在开始嗅探之前，您可以在记录菜单下设置 Ettercap，以保存所有捕获的数据包，供以后检查。您只需将捕获保存到一个`.pcap`文件，就像在 tcpdump 和 Wireshark 中一样。

通常，仅保存用户消息的输出就足以进行笔测试。当笔测试时，你主要是在密码和登录凭证之后。消息日志将捕获这些。有时，为了进行进一步的侦察，你可以把整个俘虏都保存下来。

![Ettercap](../Images/image00839.jpeg)

一旦嗅探开始，我们需要扫描主机。进入菜单栏中的**主机****扫描主机**。这将扫描本地网络以查找可用的主机。注意，还有一个选项**从文件加载。。。**。您可以选择此选项并从文本文件加载主机 IP 地址列表。这是一个很好的选择，当你在一个大型网络上，你只想要欺骗流量到文件服务器和域控制器，而不是工作站。这将减少网络流量。ARP 欺骗可以产生大量流量。如果这是一个大型网络，则此流量会减慢网络速度。如果您在秘密测试，流量会让您被抓到：

![Ettercap](../Images/image00840.jpeg)

下面是我们从扫描中获取的主机列表。由于这是一个小型网络，我们将欺骗所有的主机。我们看到我们列出了五台主机，完整的带有 MAC 地址的。请记住，其中之一是测试机：

![Ettercap](../Images/image00841.jpeg)

我们准备给水下毒，看看有什么浮上来。进入**Mitm**并点击**Arp 中毒**：

![Ettercap](../Images/image00842.jpeg)

然后，您将获得一个窗口来设置要执行的中毒类型。选择**嗅探远程连接**并点击**确定**按钮：

![Ettercap](../Images/image00843.jpeg)

以下屏幕显示正在进行的 DNS 中毒。

![Ettercap](../Images/image00844.jpeg)

中毒完成后，将通过 Ettercap 界面发送数据，显示管理用户及其 NTLM 密码哈希。这些信息足以开始与开膛手约翰或阿拉奇尼进行密码哈希运算。

### 提示

**黑客提示**

即使管理员密码失败，您仍然应该破解它们。管理员用户可能忘记了他们登录的机器，失败的密码可能在系统的其他地方起作用。

![Ettercap](../Images/image00845.jpeg)

在大多数安全策略中，Windows 系统被设置为在用户五次或六次尝试后拒绝连接。此策略保护用户帐户免受暴力密码攻击或密码猜测攻击。这将停止强制使用密码，但正如您所看到的，此策略对此类攻击没有影响。您已经拥有早期嗅探的管理员密码，因此您可以第一次登录。

Ettercap 的一个重要特性是，它还可以在命令行下使用 Ncurses 界面工作。在使用 SSH 从远程系统工作时，这非常好。然后，按*Tab*键和箭头键在菜单中移动，*Enter*键进行选择。

### 在命令行上使用 Ettercap

在许多情况下，您将无法使用 eTerCap 的图形界面。当您从一台有漏洞的 Linux 机器发起攻击时，您可能会发现它根本没有图形桌面。在这种情况下，您可以使用 Ettercap Ncurses 版本或纯文本版本。在使用 SSH 从远程系统工作时，这非常好。然后，按*键*键和箭头键在菜单中移动，按*键*键选择：

![Using Ettercap on the command line](../Images/image00846.jpeg)

要从命令行启动 Ettercap，需要向命令添加一些标志。与大多数 Linux 命令一样，您可以使用`ettercap –help`获取标志及其含义的列表。对于基本用途，可以使用以下命令：

```
root@kalibook :~#  ettercap -C -m ettercap-msg.txt

```

`-C`标志在 Ncurses 模式下启动 ETERCAP；我们包含了`-m ettercap-mgs.txt`标志，用于将消息输出管道输出到文件`ettercap-msg.txt`。如果要保存整个捕获，请添加`-w ettercap-capture.pcap`。这将保存完整的捕获，以便您可以在需要时将其拉入 Wireshark。我们发现使用命令行标志保存输出更容易。以下插图是基于 CLI 的 Curses 界面和基于 CLI 的纯文本界面：

![Using Ettercap on the command line](../Images/image00847.jpeg)

现在我们可以看一下 Ettercap 命令行界面。`ettercap -T`命令检查 Kali 主机 IP 地址和子网掩码，然后扫描可用网络中的所有机器。这是一个非常嘈杂的测试，很快就会通过。下图是扫描的设置细节：

![Using Ettercap on the command line](../Images/image00848.jpeg)

# 总结

本章向您展示了如何使用 tcpdump、WinDump 和 Wireshark 嗅探网络，以及如何筛选协议和 IP 地址。接下来，你就可以使用 eTerCap 玩欺骗和 ARP 中毒了。

在下一章中，我们将深入研究密码攻击。我们将破解密码散列，例如您可能在 Windows 网络上嗅探 NTLM 数据包时恢复的密码散列。我们将使用字典攻击。我们将向您展示一些东西，这些东西将鼓励您开发更长、更复杂的密码。